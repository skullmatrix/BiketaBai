@page "{bookingId:int}"
@using Microsoft.AspNetCore.Authorization
@using BiketaBai.Helpers
@attribute [Authorize]
@model UploadConditionPhotoModel
@{
    ViewData["Title"] = "Upload Bike Condition Photo";
}

<link rel="stylesheet" href="~/css/premium-minimal.css" asp-append-version="true" />

<div class="page-container">
    <div style="max-width: 800px; margin: 0 auto; padding: var(--space-4) var(--space-3);">
        @if (Model.Booking == null)
        {
            <div class="alert-minimal alert-minimal-error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>Booking not found</div>
            </div>
        }
        else
        {
            <!-- Header -->
            <div class="page-header" style="margin-bottom: var(--space-5);">
                <a href="/Dashboard/Renter" class="btn-minimal btn-minimal-ghost btn-minimal-sm" style="margin-bottom: var(--space-3);">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
                <h1 class="page-title" style="font-size: 1.75rem; margin-bottom: var(--space-1);">
                    <i class="bi bi-camera-fill"></i> Upload Bike Condition Photo
                </h1>
                <p class="page-subtitle" style="color: var(--neutral-600); font-size: 0.875rem;">Booking #@Model.Booking.BookingId.ToString().PadLeft(6, '0')</p>
            </div>

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert-minimal alert-minimal-error mb-4">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <div>@TempData["ErrorMessage"]</div>
                </div>
            }

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert-minimal alert-minimal-success mb-4">
                    <i class="bi bi-check-circle-fill"></i>
                    <div>@TempData["SuccessMessage"]</div>
                </div>
            }

            <!-- Booking Summary -->
            <div class="card-minimal card-minimal-compact mb-4">
                <div class="card-minimal-header">
                    <h2 class="card-minimal-title" style="font-size: 1.125rem;">
                        <i class="bi bi-info-circle"></i> Booking Details
                    </h2>
                </div>
                <div style="display: grid; grid-template-columns: 120px 1fr; gap: var(--space-4); align-items: start; padding: var(--space-4);">
                    @if (Model.Booking.Bike.BikeImages.Any())
                    {
                        <img src="@Model.Booking.Bike.BikeImages.First().ImageUrl" 
                             alt="@Model.Booking.Bike.Brand @Model.Booking.Bike.Model"
                             style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--radius-md);" />
                    }
                    else
                    {
                        <div style="width: 120px; height: 120px; background: var(--neutral-200); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-bicycle" style="font-size: 2rem; color: var(--neutral-400);"></i>
                        </div>
                    }
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-2);">
                            @Model.Booking.Bike.Brand @Model.Booking.Bike.Model
                        </h3>
                        <div style="font-size: 0.875rem; color: var(--neutral-600);">
                            <div><strong>Type:</strong> @Model.Booking.Bike.BikeType.TypeName</div>
                            <div><strong>Rental Period:</strong> @TimeZoneHelper.FormatPhilippineTime(Model.Booking.StartDate, "MMM dd, yyyy") - @TimeZoneHelper.FormatPhilippineTime(Model.Booking.EndDate, "MMM dd, yyyy")</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="alert-minimal alert-minimal-info mb-4">
                <i class="bi bi-info-circle-fill"></i>
                <div>
                    <strong>Why Upload Condition Photos?</strong>
                    <p style="margin: var(--space-2) 0 0 0; font-size: 0.875rem;">
                        Taking photos of the bike's condition before you start renting helps protect both you and the owner. 
                        These photos document the bike's condition at the start of your rental and can be used as evidence 
                        if there are any disputes about damages later. Both you and the owner can view these photos.
                    </p>
                </div>
            </div>

            <!-- Existing Photos -->
            @if (Model.ExistingPhotos.Any())
            {
                <div class="card-minimal mb-4">
                    <div class="card-minimal-header">
                        <h2 class="card-minimal-title" style="font-size: 1.125rem;">
                            <i class="bi bi-images"></i> Uploaded Condition Photos (@Model.ExistingPhotos.Count)
                        </h2>
                    </div>
                    <div style="padding: var(--space-4);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-3);">
                            @foreach (var photo in Model.ExistingPhotos)
                            {
                                <div style="position: relative;">
                                    <img src="@photo.PhotoUrl" 
                                         alt="Condition photo"
                                         style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--neutral-200);" />
                                    @if (!string.IsNullOrEmpty(photo.PhotoDescription))
                                    {
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: white; padding: var(--space-2); border-radius: 0 0 var(--radius-md) var(--radius-md); font-size: 0.75rem;">
                                            @photo.PhotoDescription
                                        </div>
                                    }
                                    <div style="position: absolute; top: var(--space-1); right: var(--space-1); background: rgba(255, 255, 255, 0.9); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--neutral-600);">
                                        @TimeZoneHelper.FormatPhilippineTime(photo.TakenAt, "MMM dd, hh:mm")
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Upload Form -->
            <div class="card-minimal mb-4">
                <div class="card-minimal-header">
                    <h2 class="card-minimal-title" style="font-size: 1.125rem;">
                        <i class="bi bi-camera-fill"></i> Upload New Photo
                    </h2>
                </div>
                <form method="post" enctype="multipart/form-data">
                    <div style="padding: var(--space-4);">
                        <div class="form-group-minimal" style="margin-bottom: var(--space-4);">
                            <label class="label-minimal">Bike Condition Photo <span style="color: var(--danger);">*</span></label>
                            <input type="file" asp-for="PhotoFile" class="input-minimal" accept="image/*" required />
                            <span asp-validation-for="PhotoFile" class="text-danger" style="font-size: 0.875rem;"></span>
                            <small style="color: var(--neutral-600); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                Upload a clear photo showing the bike's condition. Accepted formats: JPG, PNG, WEBP (max 5MB)
                            </small>
                            <div id="imagePreview" style="margin-top: var(--space-3); display: none;">
                                <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: var(--radius-md); border: 2px solid var(--neutral-200);" />
                            </div>
                        </div>

                        <div class="form-group-minimal" style="margin-bottom: var(--space-4);">
                            <label class="label-minimal">Photo Description (Optional)</label>
                            <textarea asp-for="PhotoDescription" 
                                      class="input-minimal" 
                                      rows="3" 
                                      placeholder="e.g., Front view showing handlebars and frame, Side view showing wheels, etc..."></textarea>
                            <small style="color: var(--neutral-600); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                Add a brief description of what part of the bike this photo shows
                            </small>
                        </div>

                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-5);">
                            <button type="submit" class="btn-minimal btn-minimal-primary btn-minimal-lg" style="flex: 1;">
                                <i class="bi bi-upload"></i> Upload Photo
                            </button>
                            <a href="/Dashboard/Renter" class="btn-minimal btn-minimal-ghost btn-minimal-lg">
                                Skip for Now
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Image preview
        document.getElementById('PhotoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        });
    </script>
}

