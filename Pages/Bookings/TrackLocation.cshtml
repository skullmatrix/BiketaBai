@page "{bookingId:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@model TrackLocationModel
@{
    ViewData["Title"] = "Location Tracking";
}

<div class="page-container">
    <div style="max-width: 1200px; margin: 0 auto;">
        @if (Model.Booking == null)
        {
            <div class="alert-minimal alert-minimal-error">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>Booking not found</div>
            </div>
        }
        else
        {
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-4);">
                    <h1 class="page-title">
                        <i class="bi bi-geo-alt-fill"></i> Location Tracking
                    </h1>
                    <a href="/Dashboard/Renter" class="btn-minimal btn-minimal-ghost">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Booking Info -->
            <div class="card-minimal mb-4">
                <div class="card-minimal-header">
                    <h2 class="card-minimal-title">
                        <i class="bi bi-calendar-check"></i> Booking Details
                    </h2>
                </div>
                <div class="grid-minimal grid-minimal-2">
                    <div>
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Bike</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.Bike.Brand @Model.Booking.Bike.Model</div>
                        
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Owner</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.Bike.Owner.FullName</div>
                        
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Store</div>
                        <div style="font-weight: 600;">@(Model.PrimaryStore?.StoreName ?? "Store Location")</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Start</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.StartDate.ToString("MMM dd, yyyy hh:mm tt")</div>
                        
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">End</div>
                        <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.EndDate.ToString("MMM dd, yyyy hh:mm tt")</div>
                        
                        <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Geofence Radius</div>
                        <div style="font-weight: 600; color: var(--sage-primary);">@Model.GeofenceRadiusKm km</div>
                    </div>
                </div>
            </div>

            <!-- Location Status -->
            <div class="card-minimal mb-4" id="locationStatusCard">
                <div style="text-align: center; padding: var(--space-6);">
                    <div id="locationStatus" class="mb-3">
                        <i class="bi bi-hourglass-split" style="font-size: 3rem; color: var(--neutral-400);"></i>
                        <p class="mt-3" style="color: var(--neutral-600);">Requesting location access...</p>
                    </div>
                    <div id="locationInfo" style="display: none;">
                        <h4 id="statusText" class="mb-3" style="color: var(--sage-primary);"></h4>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2); text-align: left; max-width: 400px; margin: 0 auto;">
                            <p style="margin: 0;"><strong>Distance from Store:</strong> <span id="distanceText" style="color: var(--sage-primary); font-weight: 600;">-</span></p>
                            <p style="margin: 0;"><strong>Your Location:</strong> <span id="coordinatesText" style="color: var(--neutral-600);">-</span></p>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--neutral-500);">Last updated: <span id="lastUpdateText">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="card-minimal mb-4">
                <div style="padding: 0; border-radius: var(--radius-lg); overflow: hidden;">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="alert-minimal alert-minimal-info mb-4">
                <i class="bi bi-info-circle-fill"></i>
                <div>
                    <strong>How Location Tracking Works</strong>
                    <ul style="margin: var(--space-2) 0 0 0; padding-left: var(--space-5);">
                        <li>Your location is automatically tracked every 30 seconds while this page is open for live tracking</li>
                        <li>You must allow location access when prompted by your browser</li>
                        <li>If you go outside the @Model.GeofenceRadiusKm km radius, you'll receive SMS warnings</li>
                        <li>Keep this page open during your rental to ensure continuous tracking</li>
                    </ul>
                </div>
            </div>

            <!-- Warning Alert -->
            <div class="alert-minimal alert-minimal-warning" id="warningAlert" style="display: none;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Geofence Warning</strong>
                    <p id="warningMessage" style="margin: var(--space-2) 0 0 0;"></p>
                </div>
            </div>

        }
    </div>
</div>

<!-- Load Leaflet CSS and JS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .bike-marker-icon {
        background: transparent !important;
        border: none !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    }
    .bike-marker-icon svg {
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
</style>

<script>
    // Function to create a custom bike icon marker
    function createBikeIcon(color = '#3388ff') {
        // Create SVG bike icon with better visibility
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                <!-- Background circle with shadow effect -->
                <circle cx="24" cy="24" r="22" fill="${color}" stroke="#fff" stroke-width="3" opacity="0.95" filter="url(#shadow)"/>
                <!-- Bike icon -->
                <g transform="translate(24, 24)">
                    <!-- Bike wheels -->
                    <circle cx="-10" cy="5" r="7" fill="none" stroke="#fff" stroke-width="2.5"/>
                    <circle cx="10" cy="5" r="7" fill="none" stroke="#fff" stroke-width="2.5"/>
                    <!-- Wheel spokes -->
                    <line x1="-10" y1="5" x2="-10" y2="-2" stroke="#fff" stroke-width="2"/>
                    <line x1="-10" y1="5" x2="-3" y2="5" stroke="#fff" stroke-width="2"/>
                    <line x1="10" y1="5" x2="10" y2="-2" stroke="#fff" stroke-width="2"/>
                    <line x1="10" y1="5" x2="3" y2="5" stroke="#fff" stroke-width="2"/>
                    <!-- Bike frame -->
                    <path d="M -10 5 L -2 -5 L 0 0 L 2 -5 L 10 5" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <!-- Seat -->
                    <circle cx="-4" cy="-8" r="1.5" fill="#fff"/>
                    <!-- Handlebars -->
                    <path d="M 0 -5 L -3 -8 M 0 -5 L 3 -8" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
                </g>
                <!-- Shadow filter -->
                <defs>
                    <filter id="shadow">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                    </filter>
                </defs>
            </svg>
        `;
        
        return L.divIcon({
            html: svg,
            className: 'bike-marker-icon',
            iconSize: [48, 48],
            iconAnchor: [24, 24],
            popupAnchor: [0, -24]
        });
    }

    let map;
    let renterMarker;
    let storeMarker;
    let geofenceCircle;
    let watchId;
    let updateInterval;

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const bookingId = @Model.Booking.BookingId;
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    initMap(position.coords.latitude, position.coords.longitude);
                    startTracking();
                },
                async function(error) {
                    const locationStatusEl = document.getElementById('locationStatus');
                    locationStatusEl.innerHTML = 
                        '<i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--error);"></i>' +
                        '<p class="mt-2" style="color: var(--error);">Location access denied. Please enable location services.</p>';
                    
                    // Notify owner if location permission is denied
                    if (error.code === error.PERMISSION_DENIED) {
                        try {
                            const response = await fetch('/Api/LocationPermissionDenied', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    bookingId: bookingId
                                })
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                console.log('Owner notified about location permission denial');
                            }
                        } catch (err) {
                            console.error('Error notifying owner:', err);
                        }
                    }
                }
            );
        } else {
            document.getElementById('locationStatus').innerHTML = 
                '<i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--error);"></i>' +
                '<p class="mt-2" style="color: var(--error);">Geolocation is not supported by your browser.</p>';
        }
    });

    function initMap(lat, lng) {
        // Store coordinates from model
        const storeLat = @(Model.StoreLatitude?.ToString("F6") ?? "14.5995");
        const storeLng = @(Model.StoreLongitude?.ToString("F6") ?? "120.9842");
        const radius = @Model.GeofenceRadiusKm * 1000; // Convert km to meters

        // Create map centered on store
        map = L.map('map').setView([storeLat, storeLng], 13);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add store marker
        storeMarker = L.marker([storeLat, storeLng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map).bindPopup('Store Location');

        // Add geofence circle
        geofenceCircle = L.circle([storeLat, storeLng], {
            color: '#87A96B',
            fillColor: '#E8F0E3',
            fillOpacity: 0.3,
            radius: radius
        }).addTo(map);

        // Add renter marker with bike icon (default to blue, will update based on actual distance)
        renterMarker = L.marker([lat, lng], {
            icon: createBikeIcon('#3388ff'),
            zIndexOffset: 1000
        }).addTo(map).bindPopup(`
            <div style="text-align: center;">
                <strong>Your Location</strong><br>
                <code style="font-size: 0.9em;">${lat.toFixed(6)}, ${lng.toFixed(6)}</code><br>
                <small style="color: #666;">
                    <i class="bi bi-circle-fill" style="color: #28a745; font-size: 0.6em;"></i> Live Tracking
                </small>
            </div>
        `);

        // Fit map to show both markers and geofence
        const group = new L.featureGroup([storeMarker, renterMarker, geofenceCircle]);
        map.fitBounds(group.getBounds().pad(0.1));
    }

    function startTracking() {
        // Send location immediately when tracking starts
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                updateLocation,
                function(error) {
                    console.error('Error getting initial location:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0 // Get fresh location immediately
                }
            );
        }

        // Update location every 15 seconds for live tracking (more frequent for real-time owner tracking)
        updateInterval = setInterval(function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    updateLocation,
                    function(error) {
                        console.error('Error getting location:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 15000 // Accept location up to 15 seconds old
                    }
                );
            }
        }, 15000); // 15 seconds for live tracking (more frequent updates for owner)

        // Also watch position continuously for smoother updates
        watchId = navigator.geolocation.watchPosition(
            updateLocation, 
            function(error) {
                console.error('Error watching location:', error);
            }, 
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 15000 // Accept location up to 15 seconds old (more frequent for real-time tracking)
            }
        );
    }

    function updateLocation(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // Calculate distance from store
        const storeLat = @(Model.StoreLatitude?.ToString("F6") ?? "14.5995");
        const storeLng = @(Model.StoreLongitude?.ToString("F6") ?? "120.9842");
        const distance = calculateDistance(lat, lng, parseFloat(storeLat), parseFloat(storeLng));
        const radius = @Model.GeofenceRadiusKm;
        const isWithin = distance <= radius;

        // Update marker smoothly with icon based on geofence status
        if (renterMarker) {
            renterMarker.setLatLng([lat, lng], { animate: true, duration: 0.5 });
            
            // Update icon color based on geofence status
            renterMarker.setIcon(createBikeIcon(isWithin ? '#3388ff' : '#ff3333'));
            
            // Update popup content
            renterMarker.setPopupContent(`
                <div style="text-align: center;">
                    <strong>Your Location</strong><br>
                    <code style="font-size: 0.9em;">${lat.toFixed(6)}, ${lng.toFixed(6)}</code><br>
                    <small style="color: #666;">
                        <i class="bi bi-circle-fill" style="color: #28a745; font-size: 0.6em;"></i> Live
                    </small>
                </div>
            `);
        }

        // Update UI
        document.getElementById('locationStatus').style.display = 'none';
        document.getElementById('locationInfo').style.display = 'block';
        
        const statusText = document.getElementById('statusText');
        const distanceText = document.getElementById('distanceText');
        const coordinatesText = document.getElementById('coordinatesText');
        const lastUpdateText = document.getElementById('lastUpdateText');
        const warningAlert = document.getElementById('warningAlert');
        const warningMessage = document.getElementById('warningMessage');

        distanceText.textContent = distance.toFixed(2) + ' km';
        coordinatesText.textContent = lat.toFixed(6) + ', ' + lng.toFixed(6);
        lastUpdateText.textContent = new Date().toLocaleTimeString();

        // Check if outside geofence
        if (distance > radius) {
            statusText.textContent = '⚠️ Outside Geofence';
            statusText.style.color = 'var(--error)';
            distanceText.style.color = 'var(--error)';
            warningAlert.style.display = 'block';
            warningMessage.textContent = `You are ${(distance - radius).toFixed(2)} km outside the allowed radius. Please return to the geofence area.`;
        } else {
            statusText.textContent = '✓ Within Geofence';
            statusText.style.color = 'var(--success)';
            distanceText.style.color = 'var(--sage-primary)';
            warningAlert.style.display = 'none';
        }
        
        // Always send location to server for live tracking (regardless of geofence status)
        sendLocationToServer(lat, lng, distance, distance > radius);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    let lastSentLocation = null;
    let isSendingLocation = false;
    
    function sendLocationToServer(lat, lng, distance, isOutside) {
        // Prevent duplicate sends if already sending
        if (isSendingLocation) {
            console.log('Location send already in progress, skipping...');
            return;
        }
        
        // Skip if location hasn't changed significantly (more than 10 meters)
        if (lastSentLocation) {
            const distanceChange = calculateDistance(
                lat, lng, 
                lastSentLocation.lat, lastSentLocation.lng
            ) * 1000; // Convert to meters
            
            if (distanceChange < 0.01) { // Less than 10 meters
                console.log('Location change too small, skipping send');
                return;
            }
        }
        
        isSendingLocation = true;
        
        fetch('/api/location/track', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                bookingId: @Model.Booking.BookingId,
                latitude: lat,
                longitude: lng
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Location sent successfully:', data);
                // Update last sent location
                lastSentLocation = { lat: lat, lng: lng, timestamp: Date.now() };
            } else {
                console.error('Error sending location:', data.error);
            }
            isSendingLocation = false;
        })
        .catch(error => {
            console.error('Error sending location:', error);
            isSendingLocation = false;
            // Retry after 5 seconds if failed
            setTimeout(() => {
                if (!isSendingLocation) {
                    sendLocationToServer(lat, lng, distance, isOutside);
                }
            }, 5000);
        });
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
