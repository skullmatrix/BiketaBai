@page "{bookingId:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@model ConfirmationModel
@{
    ViewData["Title"] = "Booking Confirmation";
}

<div class="container-minimal my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            @if (Model.Booking == null)
            {
                <div class="alert-minimal alert-minimal-error">Booking not found</div>
            }
            else
            {
                <div class="card-minimal">
                    <div class="card-body-minimal text-center">
                        <!-- Success Icon -->
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: var(--color-sage-primary);"></i>
                        </div>
                        
                        <h1 class="page-title-minimal mb-3">Booking Confirmed!</h1>
                        <p class="text-muted-minimal mb-4">Your booking has been successfully created and payment processed.</p>

                        <!-- Countdown Timer - Prominent Display -->
                        @if (Model.Booking.BookingStatus == "Active")
                        {
                            <div class="card-minimal mb-4" style="background: linear-gradient(135deg, var(--sage-primary) 0%, var(--sage-secondary) 100%); border: none; box-shadow: 0 8px 24px rgba(135, 169, 107, 0.3);">
                                <div class="card-body-minimal text-center" style="padding: var(--space-5);">
                                    <h3 style="color: white; margin-bottom: var(--space-3); font-weight: 600;">
                                        <i class="bi bi-clock-history"></i> Rental Time Remaining
                                    </h3>
                                    <div id="countdownTimer" style="font-size: 3rem; font-weight: 700; color: white; font-family: 'Courier New', monospace; letter-spacing: 2px; margin: var(--space-4) 0;">
                                        <div id="countdownDisplay">Calculating...</div>
                                    </div>
                                    <p style="color: rgba(255, 255, 255, 0.9); margin: 0; font-size: 0.875rem;">
                                        Your rental ends on <strong>@TimeZoneHelper.FormatPhilippineTime(Model.Booking.EndDate, "MMM dd, yyyy hh:mm tt")</strong>
                                    </p>
                                </div>
                            </div>
                        }

                        <!-- Booking ID/Number -->
                        <div class="alert-minimal alert-minimal-info mb-4" style="background: var(--sage-subtle); border: 2px solid var(--sage-primary);">
                            <div style="text-align: center;">
                                <p class="text-muted-minimal mb-2" style="font-size: 0.875rem;">Booking Reference Number</p>
                                <h2 class="mb-0" style="color: var(--sage-primary); font-weight: 700; letter-spacing: 1px;">
                                    #@Model.Booking.BookingId.ToString("D6")
                                </h2>
                                <p class="text-muted-minimal mt-2 mb-0" style="font-size: 0.75rem;">Please save this number for your records</p>
                            </div>
                        </div>

                        <!-- Booking Details -->
                        <div class="card-minimal card-minimal-secondary mb-4">
                            <div class="card-body-minimal">
                                <h5 class="card-title-minimal mb-3">Booking Details</h5>
                                <div class="divider-minimal mb-3"></div>
                                
                                <div class="row text-start">
                                    <div class="col-md-6 mb-3">
                                        <p class="text-muted-minimal mb-1"><strong>Booking ID:</strong></p>
                                        <p class="mb-3" style="font-weight: 600; color: var(--sage-primary);">#@Model.Booking.BookingId.ToString("D6")</p>
                                        
                                        <p class="text-muted-minimal mb-1"><strong>Bike:</strong></p>
                                        <p class="mb-3">@Model.Booking.Bike.Brand @Model.Booking.Bike.Model</p>
                                        
                                        <p class="text-muted-minimal mb-1"><strong>Type:</strong></p>
                                        <p class="mb-3">@Model.Booking.Bike.BikeType.TypeName</p>
                                        
                                        <p class="text-muted-minimal mb-1"><strong>Owner:</strong></p>
                                        <p class="mb-0">@Model.Booking.Bike.Owner.FullName</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <p class="text-muted-minimal mb-1"><strong>Start Time:</strong></p>
                                        <p class="mb-3">@TimeZoneHelper.FormatPhilippineTime(Model.Booking.StartDate, "MMM dd, yyyy hh:mm tt")</p>
                                        
                                        <p class="text-muted-minimal mb-1"><strong>End Time:</strong></p>
                                        <p class="mb-3">@TimeZoneHelper.FormatPhilippineTime(Model.Booking.EndDate, "MMM dd, yyyy hh:mm tt")</p>
                                        
                                        <p class="text-muted-minimal mb-1"><strong>Duration:</strong></p>
                                        <p class="mb-0">@Model.Booking.RentalHours.ToString("F1") hours</p>
                                    </div>
                                </div>
                                
                                <div class="divider-minimal my-3"></div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted-minimal"><strong>Total Amount:</strong></span>
                                    <h4 class="mb-0 text-sage-primary">â‚±@Model.Booking.TotalAmount.ToString("F2")</h4>
                                </div>
                                
                                @if (Model.Booking.Payments.Any())
                                {
                                    var payment = Model.Booking.Payments.First();
                                    <div class="mt-3 pt-3" style="border-top: 1px solid var(--color-gray-200);">
                                        <small class="text-muted-minimal">
                                            <i class="bi bi-check-circle"></i> Payment Status: <strong>@payment.PaymentStatus</strong>
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Payment Waiting Status (for Cash Payments) -->
                        @if (Model.Booking.BookingStatus == "Pending" && Model.Booking.Payments.Any())
                        {
                            var latestPayment = Model.Booking.Payments.OrderByDescending(p => p.PaymentDate).First();
                            var isCashPayment = latestPayment.PaymentMethod == "Cash";
                            var canContinuePayment = (latestPayment.PaymentStatus == "Pending" || 
                                                     latestPayment.PaymentStatus == "Cancelled" || 
                                                     latestPayment.PaymentStatus == "Failed") && 
                                                    !string.IsNullOrEmpty(latestPayment.TransactionReference) &&
                                                    !isCashPayment;
                            
                            @if (isCashPayment && latestPayment.PaymentStatus == "Pending")
                            {
                                <div class="alert-minimal alert-minimal-info mb-4" id="paymentWaitingAlert">
                                    <i class="bi bi-hourglass-split"></i>
                                    <div>
                                        <strong>Waiting for Payment Verification</strong>
                                        <p class="mb-0" id="paymentWaitingText">Your cash payment is pending verification by the owner. Once verified, your rental will automatically start and you'll be redirected to location tracking.</p>
                                    </div>
                                </div>
                            }
                            else if (canContinuePayment)
                            {
                                <div class="alert-minimal @(latestPayment.PaymentStatus == "Pending" ? "alert-minimal-warning" : latestPayment.PaymentStatus == "Cancelled" ? "alert-minimal-info" : "alert-minimal-error") mb-4">
                                    <i class="bi @(latestPayment.PaymentStatus == "Pending" ? "bi-hourglass-split" : latestPayment.PaymentStatus == "Cancelled" ? "bi-x-circle-fill" : "bi-exclamation-triangle-fill")"></i>
                                    <div>
                                        <strong>Payment @latestPayment.PaymentStatus</strong>
                                        <p class="mb-2">Your @latestPayment.PaymentMethod payment is @latestPayment.PaymentStatus.ToLower(). You can continue the payment process to complete your booking.</p>
                                        <form method="post" asp-page="/Bookings/Payment" asp-page-handler="ContinuePayment" style="margin-top: var(--space-2);">
                                            <input type="hidden" name="bookingId" value="@Model.Booking.BookingId" />
                                            <input type="hidden" name="paymentIntentId" value="@latestPayment.TransactionReference" />
                                            <button type="submit" class="btn-minimal btn-minimal-primary btn-minimal-sm">
                                                <i class="bi bi-arrow-right-circle"></i> Continue Payment
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            }
                        }

                        <!-- Location Tracking Info -->
                        @if (Model.Booking.BookingStatus == "Active")
                        {
                            <div class="alert-minimal alert-minimal-success mb-4" id="locationStatusAlert">
                                <i class="bi bi-geo-alt-fill"></i>
                                <div>
                                    <strong>Location Tracking Active</strong>
                                    <p class="mb-0" id="locationStatusText">Requesting your location to start geofencing...</p>
                                </div>
                            </div>
                        }

                        <!-- Condition Photos Section -->
                        @if (Model.Booking.BikeConditionPhotos.Any())
                        {
                            <div class="card-minimal card-minimal-secondary mb-4">
                                <div class="card-body-minimal">
                                    <h5 class="card-title-minimal mb-3">
                                        <i class="bi bi-camera-fill"></i> Condition Photos (@Model.Booking.BikeConditionPhotos.Count)
                                    </h5>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--space-2);">
                                        @foreach (var photo in Model.Booking.BikeConditionPhotos.OrderByDescending(p => p.TakenAt))
                                        {
                                            <a href="@photo.PhotoUrl" target="_blank" style="display: block;">
                                                <img src="@photo.PhotoUrl" 
                                                     alt="Condition photo"
                                                     style="width: 100%; height: 120px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--neutral-200);" />
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            @{
                                var hasCompletedPayment = Model.Booking.Payments.Any(p => p.PaymentStatus == "Completed");
                            }
                            @if (hasCompletedPayment)
                            {
                                @if (!Model.Booking.BikeConditionPhotos.Any())
                                {
                                    <a href="/Bookings/UploadConditionPhoto/@Model.Booking.BookingId" class="btn-minimal btn-minimal-primary" style="background: var(--warning); border-color: var(--warning);">
                                        <i class="bi bi-camera-fill"></i> Upload Bike Condition Photo (Recommended)
                                    </a>
                                }
                                else
                                {
                                    <a href="/Bookings/UploadConditionPhoto/@Model.Booking.BookingId" class="btn-minimal btn-minimal-outline">
                                        <i class="bi bi-camera-fill"></i> Add More Condition Photos
                                    </a>
                                }
                            }
                            @if (Model.Booking.BookingStatus == "Active")
                            {
                                <a href="/Bookings/TrackLocation/@Model.Booking.BookingId" class="btn-minimal btn-minimal-primary" id="trackLocationBtn">
                                    <i class="bi bi-geo-alt-fill"></i> Track Location
                                </a>
                            }
                            <a href="/Dashboard/Renter" class="btn-minimal btn-minimal-ghost">
                                <i class="bi bi-speedometer2"></i> Go to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (Model.Booking != null)
{
    <!-- SignalR Library -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    
    @if (Model.Booking.BookingStatus == "Active")
    {
        var endDatePHT = TimeZoneHelper.FormatPhilippineTime(Model.Booking.EndDate, "yyyy-MM-ddTHH:mm:ss");
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Helper function to get current Philippine time (UTC+8)
                function getPhilippineTime() {
                    const now = new Date();
                    const phTimeStr = now.toLocaleString('en-US', { 
                        timeZone: 'Asia/Manila',
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false
                    });
                    const parts = phTimeStr.split(', ');
                    const dateParts = parts[0].split('/');
                    const timeParts = parts[1].split(':');
                    return new Date(
                        parseInt(dateParts[2]), parseInt(dateParts[0]) - 1, parseInt(dateParts[1]),
                        parseInt(timeParts[0]), parseInt(timeParts[1]), parseInt(timeParts[2])
                    );
                }
                
                // Parse end date in Philippine time format
                const endDateStr = '@endDatePHT';
                const endDateParts = endDateStr.split('T');
                const dateParts = endDateParts[0].split('-');
                const timeParts = endDateParts[1].split(':');
                
                const endDate = new Date(
                    parseInt(dateParts[0]), // year
                    parseInt(dateParts[1]) - 1, // month (0-indexed)
                    parseInt(dateParts[2]), // day
                    parseInt(timeParts[0]), // hour
                    parseInt(timeParts[1]), // minute
                    parseInt(timeParts[2] || 0) // second
                );
                
                const countdownDisplay = document.getElementById('countdownDisplay');
                
                if (countdownDisplay) {
                    function updateCountdown() {
                        const nowPhilippine = getPhilippineTime();
                        const timeLeft = endDate.getTime() - nowPhilippine.getTime();
                        
                        if (timeLeft <= 0) {
                            countdownDisplay.innerHTML = '<span style="color: #fee2e2;">RENTAL EXPIRED</span>';
                            countdownDisplay.parentElement.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
                            return;
                        }
                        
                        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        
                        let displayText = '';
                        if (days > 0) {
                            displayText = days + 'd ' + hours + 'h ' + minutes + 'm ' + seconds + 's';
                        } else if (hours > 0) {
                            displayText = hours + 'h ' + minutes + 'm ' + seconds + 's';
                        } else if (minutes > 0) {
                            displayText = minutes + 'm ' + seconds + 's';
                        } else {
                            displayText = seconds + 's';
                        }
                        
                        countdownDisplay.innerHTML = displayText;
                        
                        // Reset to default colors first
                        countdownDisplay.style.color = 'white';
                        countdownDisplay.parentElement.style.background = 'linear-gradient(135deg, var(--sage-primary) 0%, var(--sage-secondary) 100%)';
                        
                        // Change color as time runs out
                        const oneHour = 3600000;
                        const threeHours = 10800000;
                        const isLessThanOneHour = timeLeft < oneHour;
                        const isLessThanThreeHours = timeLeft < threeHours;
                        if (isLessThanOneHour) {
                            countdownDisplay.style.color = '#fee2e2';
                            countdownDisplay.parentElement.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                        } else if (isLessThanThreeHours) {
                            countdownDisplay.style.color = '#fef3c7';
                            countdownDisplay.parentElement.style.background = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
                        }
                    }
                    
                    // Update countdown immediately and then every second
                    updateCountdown();
                    setInterval(updateCountdown, 1000);
                }
            });
        </script>
    }
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bookingId = @Model.Booking.BookingId;
            const bookingStatus = '@Model.Booking.BookingStatus';
            const isPendingCashPayment = bookingStatus === 'Pending' && @(Model.Booking.Payments.Any() && Model.Booking.Payments.First().PaymentStatus == "Pending" ? "true" : "false");
            
            // Initialize SignalR connection for real-time updates
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .withAutomaticReconnect()
                .build();

            // Listen for booking updates (e.g., payment verification)
            connection.on("ReceiveBookingUpdate", function(data) {
                console.log("Received booking update:", data);
                
                // Check if this update is for the current booking and is a payment verification
                if (data.bookingId === bookingId && data.updateType === "payment_verified") {
                    console.log("Payment verified! Rental is now active.");
                    
                    // Update UI to show success message and reload page to show countdown
                    const paymentWaitingAlert = document.getElementById('paymentWaitingAlert');
                    if (paymentWaitingAlert) {
                        paymentWaitingAlert.className = 'alert-minimal alert-minimal-success mb-4';
                        paymentWaitingAlert.innerHTML = `
                            <i class="bi bi-check-circle-fill"></i>
                            <div>
                                <strong>Payment Verified!</strong>
                                <p class="mb-0">Your rental has started. The countdown timer will appear shortly.</p>
                            </div>
                        `;
                    }
                    
                    // Reload page after a short delay to show countdown and active status
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000); // 2 second delay to show success message
                }
            });

            // Start SignalR connection
            connection.start()
                .then(function() {
                    console.log("SignalR connected. Listening for payment verification...");
                })
                .catch(function(err) {
                    console.error("SignalR connection error:", err);
                });

            // Handle connection state changes
            connection.onreconnecting(function() {
                console.log("SignalR reconnecting...");
            });

            connection.onreconnected(function() {
                console.log("SignalR reconnected");
            });

            connection.onclose(function() {
                console.log("SignalR connection closed");
            });

            // Automatically capture user location when booking becomes active (non-cash payments)
            if (bookingStatusId === 2 && !isPendingCashPayment) {
                const locationStatusText = document.getElementById('locationStatusText');
                const locationStatusAlert = document.getElementById('locationStatusAlert');

                if (!navigator.geolocation) {
                    if (locationStatusText) {
                        locationStatusText.textContent = 'Geolocation is not supported by your browser. Please use the Track Location page.';
                        locationStatusAlert.className = 'alert-minimal alert-minimal-warning mb-4';
                    }
                    return;
                }

                // Request location permission and capture initial location
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        try {
                            // Send location to API to start tracking
                            const response = await fetch('/api/location/track', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    bookingId: bookingId,
                                    latitude: lat,
                                    longitude: lon
                                })
                            });

                            const result = await response.json();

                            if (result.success && locationStatusText) {
                                locationStatusText.innerHTML = '<strong>Location captured successfully!</strong> Geofencing is now active. Your location will be monitored during the rental.';
                                locationStatusAlert.className = 'alert-minimal alert-minimal-success mb-4';
                            } else if (locationStatusText) {
                                locationStatusText.textContent = 'Location captured but tracking setup failed. Please use the Track Location page.';
                                locationStatusAlert.className = 'alert-minimal alert-minimal-warning mb-4';
                            }
                        } catch (error) {
                            console.error('Error sending location:', error);
                            if (locationStatusText) {
                                locationStatusText.textContent = 'Failed to send location. Please use the Track Location page to start tracking.';
                                locationStatusAlert.className = 'alert-minimal alert-minimal-warning mb-4';
                            }
                        }
                    },
                    async (error) => {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'Unable to get your location. ';
                        let isPermissionDenied = false;
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Location permission denied. Please allow location access and use the Track Location page.';
                                isPermissionDenied = true;
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Location information unavailable. Please use the Track Location page.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Location request timed out. Please use the Track Location page.';
                                break;
                            default:
                                errorMessage += 'An unknown error occurred. Please use the Track Location page.';
                                break;
                        }
                        
                        if (locationStatusText) {
                            locationStatusText.textContent = errorMessage;
                            locationStatusAlert.className = 'alert-minimal alert-minimal-warning mb-4';
                        }
                        
                        // Notify owner if location permission is denied
                        if (isPermissionDenied) {
                            try {
                                const response = await fetch('/Api/LocationPermissionDenied', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        bookingId: bookingId
                                    })
                                });
                                
                                const result = await response.json();
                                if (result.success) {
                                    console.log('Owner notified about location permission denial');
                                }
                            } catch (err) {
                                console.error('Error notifying owner:', err);
                            }
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        });
    </script>
}

