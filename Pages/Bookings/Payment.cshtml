@page "{bookingId:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@model PaymentModel
@{
    ViewData["Title"] = "Payment";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            @if (Model.Booking == null)
            {
                <div class="alert alert-danger">Booking not found</div>
            }
            else
            {
                <div class="card shadow-eco">
                    <div class="card-body p-5">
                        <h2 class="text-eco-green mb-4">
                            <i class="bi bi-credit-card"></i> Complete Payment
                        </h2>

                        <!-- Booking Summary -->
                        <div class="card bg-eco-light mb-4">
                            <div class="card-body">
                                <h5 class="text-eco-green">Booking Summary</h5>
                                <hr />
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Bike:</strong> @Model.Booking.Bike.Brand @Model.Booking.Bike.Model</p>
                                        <p><strong>Type:</strong> @Model.Booking.Bike.BikeType.TypeName</p>
                                        <p><strong>Owner:</strong> @Model.Booking.Bike.Owner.FullName</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Start:</strong> @Model.Booking.StartDate.ToString("MMM dd, yyyy hh:mm tt")</p>
                                        <p><strong>End:</strong> @Model.Booking.EndDate.ToString("MMM dd, yyyy hh:mm tt")</p>
                                        <p><strong>Duration:</strong> @Model.Booking.RentalHours.ToString("F1") hours</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Details -->
                        <div class="card bg-eco-light mb-4">
                            <div class="card-body">
                                <h5 class="text-eco-green">Pricing Details</h5>
                                <hr />
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Base Rate</span>
                                    <strong>₱@Model.Booking.BaseRate.ToString("F2")</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Service Fee (10%)</span>
                                    <strong>₱@Model.Booking.ServiceFee.ToString("F2")</strong>
                                </div>
                                <hr />
                                <div class="d-flex justify-content-between">
                                    <h5>Total Amount</h5>
                                    <h5 class="text-eco-green">₱@Model.Booking.TotalAmount.ToString("F2")</h5>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                        {
                            <div class="alert alert-danger">@Model.ErrorMessage</div>
                        }

                        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                        {
                            <div class="alert alert-success">@Model.SuccessMessage</div>
                        }

                        @if (Model.ExistingPayment != null)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-info-circle"></i>
                                <strong>Current Payment Method:</strong> 
                                @Model.ExistingPayment.PaymentMethod.MethodName 
                                (@Model.ExistingPayment.PaymentStatus)
                                <br />
                                <small>You can change your payment method below. The previous payment will be cancelled.</small>
                            </div>
                        }

                        <!-- Payment Methods -->
                        <h5 class="mb-3">Select Payment Method</h5>

                        <form method="post">
                            <div class="list-group mb-4">
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="1" @(Model.PaymentMethodId == 1 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-wallet2 fs-3 me-3 text-eco-green"></i>
                                        <div>
                                            <strong>Wallet</strong>
                                            <br />
                                            <small class="text-muted">Current Balance: ₱<span id="walletBalance">@Model.WalletBalance.ToString("F2")</span></small>
                                            @if (Model.WalletBalance < Model.Booking.TotalAmount)
                                            {
                                                <br />
                                                <small class="text-danger">Insufficient balance</small>
                                            }
                                        </div>
                                    </div>
                                </label>
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="2" @(Model.PaymentMethodId == 2 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-phone fs-3 me-3 text-primary"></i>
                                        <div>
                                            <strong>GCash</strong>
                                            <br />
                                            <small class="text-muted">Pay via GCash mobile payment</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="3" @(Model.PaymentMethodId == 3 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-qr-code fs-3 me-3 text-info"></i>
                                        <div>
                                            <strong>QRPH</strong>
                                            <br />
                                            <small class="text-muted">Pay via QR PH</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="5" @(Model.PaymentMethodId == 5 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-phone fs-3 me-3" style="color: #00D9FF;"></i>
                                        <div>
                                            <strong>PayMaya</strong>
                                            <br />
                                            <small class="text-muted">Pay via PayMaya mobile payment</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="6" @(Model.PaymentMethodId == 6 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-credit-card fs-3 me-3 text-warning"></i>
                                        <div>
                                            <strong>Credit/Debit Card</strong>
                                            <br />
                                            <small class="text-muted">Visa, Mastercard, JCB, and more</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="list-group-item" style="cursor: pointer;">
                                    <input class="form-check-input me-3" type="radio" name="PaymentMethodId" value="4" @(Model.PaymentMethodId == 4 ? "checked" : "") />
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-cash fs-3 me-3 text-success"></i>
                                        <div>
                                            <strong>Cash</strong>
                                            <br />
                                            <small class="text-muted">Pay directly to the owner</small>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Card Payment Form (shown when card is selected) -->
                            <div id="cardPaymentForm" style="display: none;" class="card bg-light p-4 mb-4">
                                <h6 class="mb-3">Card Details</h6>
                                <div class="mb-3">
                                    <label class="form-label">Cardholder Name</label>
                                    <input type="text" class="form-control" id="cardholderName" placeholder="John Doe" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Card Number</label>
                                    <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Expiry Date</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="text" class="form-control" id="expMonth" placeholder="MM" maxlength="2" />
                                            </div>
                                            <div class="col-6">
                                                <input type="text" class="form-control" id="expYear" placeholder="YYYY" maxlength="4" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4" />
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-eco-primary btn-lg" id="submitBtn">
                                    <i class="bi bi-check-circle"></i> <span id="submitBtnText">Confirm Payment</span>
                                </button>
                                <a href="/Dashboard/Renter" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    // Ensure radio buttons are clickable and handle selection
    document.addEventListener('DOMContentLoaded', function() {
        const radioButtons = document.querySelectorAll('input[name="PaymentMethodId"]');
        const listGroupItems = document.querySelectorAll('.list-group-item');
        
        // Make entire label clickable
        listGroupItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // Don't trigger if clicking directly on the radio button
                if (e.target.type !== 'radio') {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio && !radio.disabled) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });
            
            // Add visual feedback on hover
            item.addEventListener('mouseenter', function() {
                if (!this.querySelector('input[type="radio"]:checked')) {
                    this.style.backgroundColor = '#f8f9fa';
                }
            });
            
            item.addEventListener('mouseleave', function() {
                if (!this.querySelector('input[type="radio"]:checked')) {
                    this.style.backgroundColor = '';
                }
            });
        });
        
        // Show/hide card form based on payment method selection
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                const cardForm = document.getElementById('cardPaymentForm');
                const submitBtn = document.getElementById('submitBtnText');
                
                // Update visual state of selected item
                listGroupItems.forEach(item => {
                    if (item.querySelector('input[type="radio"]:checked')) {
                        item.style.backgroundColor = '#e8f5e9';
                        item.style.borderColor = '#28a745';
                    } else {
                        item.style.backgroundColor = '';
                        item.style.borderColor = '';
                    }
                });
                
                if (this.value === '6') {
                    cardForm.style.display = 'block';
                    submitBtn.textContent = 'Pay with Card';
                } else {
                    cardForm.style.display = 'none';
                    submitBtn.textContent = 'Confirm Payment';
                }
            });
            
            // Trigger change event on page load if already checked
            if (radio.checked) {
                radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        // Format card number input
        document.getElementById('cardNumber')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });
    });
</script>

