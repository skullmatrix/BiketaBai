@page
@using Microsoft.AspNetCore.Authorization
@using BiketaBai.Helpers
@attribute [Authorize]
@model OwnerDashboardModel
@{
    ViewData["Title"] = "Owner Dashboard";
}

<div class="page-container">
    <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: var(--space-4);">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </h1>
                <p class="page-subtitle">Manage your bike rental business</p>
            </div>
            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                <a href="/Owner/AddBike" class="btn-minimal btn-minimal-primary">
                    <i class="bi bi-plus-circle-fill"></i> Add Bike
                </a>
                <a href="/Owner/MyBikes" class="btn-minimal btn-minimal-ghost">
                    <i class="bi bi-list-ul"></i> Manage
                </a>
            </div>
        </div>
    </div>

    <!-- Alerts Section -->
    @if (Model.PendingRequestsCount > 0 || Model.OverdueCount > 0 || Model.UnreadNotifications > 0)
    {
        <div class="card-minimal mb-5" style="border-left: 4px solid var(--sage-primary);">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-bell-fill" style="color: var(--sage-primary);"></i> Alerts & Notifications
                </h2>
            </div>
            <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                @if (Model.PendingRequestsCount > 0)
                {
                    <a href="/Owner/RentalRequests" class="alert-badge alert-badge-warning" style="text-decoration: none;">
                        <i class="bi bi-clock-history"></i>
                        <strong>@Model.PendingRequestsCount</strong> Pending Request(s)
                    </a>
                }
                @if (Model.OverdueCount > 0)
                {
                    <a href="/Owner/MyBikes?filter=active" class="alert-badge alert-badge-danger" style="text-decoration: none;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>@Model.OverdueCount</strong> Overdue Return(s)
                    </a>
                }
                @if (Model.UnreadNotifications > 0)
                {
                    <a href="/Notifications/Index" class="alert-badge alert-badge-info" style="text-decoration: none;">
                        <i class="bi bi-bell-fill"></i>
                        <strong>@Model.UnreadNotifications</strong> Unread Notification(s)
                    </a>
                }
            </div>
        </div>
    }

    <!-- Stats Grid -->
    <div class="grid-minimal grid-minimal-4 mb-5">
        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-bicycle"></i>
            </div>
            <div class="stat-value">@Model.TotalBikes</div>
            <div class="stat-label">Total Bikes</div>
            <div style="font-size: 0.75rem; color: var(--neutral-600); margin-top: var(--space-2);">
                @{
                    var availableBikes = Model.Bikes.Count(b => b.AvailabilityStatusId == 1);
                }
                <i class="bi bi-check-circle"></i> @availableBikes Available
            </div>
        </div>

        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-value">@Model.ActiveRentalsCount</div>
            <div class="stat-label">Active Rentals</div>
            @if (Model.PendingRequestsCount > 0)
            {
                <div style="font-size: 0.75rem; color: var(--warning); margin-top: var(--space-2);">
                    <i class="bi bi-exclamation-circle"></i> @Model.PendingRequestsCount Pending
                </div>
            }
        </div>

        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-value">₱@Model.TotalEarnings.ToString("F0")</div>
            <div class="stat-label">Total Earnings</div>
            @if (Model.PendingEarnings > 0)
            {
                <div style="font-size: 0.75rem; color: var(--neutral-600); margin-top: var(--space-2);">
                    <i class="bi bi-hourglass-split"></i> ₱@Model.PendingEarnings.ToString("F0") Pending
                </div>
            }
        </div>

        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-star-fill"></i>
            </div>
            <div class="stat-value">@Model.AverageRating.ToString("F1")</div>
            <div class="stat-label">Average Rating</div>
            <div style="margin-top: var(--space-2);">
                @for (int i = 1; i <= 5; i++)
                {
                    <i class="bi bi-star-fill @(i <= Model.AverageRating ? "text-sage" : "")" 
                       style="color: @(i <= Model.AverageRating ? "var(--sage-primary)" : "var(--neutral-300)"); font-size: 0.875rem;"></i>
                }
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card-minimal mb-5">
        <div class="card-minimal-header">
            <h2 class="card-minimal-title">
                <i class="bi bi-lightning-charge"></i> Quick Actions
            </h2>
        </div>
        <div class="grid-minimal grid-minimal-4">
            <a href="/Owner/MyBikes" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-grid-3x3-gap"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Manage Listings</div>
            </a>
            <a href="/Owner/RentalRequests" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-inbox"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">View Requests</div>
            </a>
            <a href="/Wallet/Index" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">My Wallet</div>
            </a>
            <a href="/Owner/GeofenceSettings" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Geofence</div>
            </a>
        </div>
    </div>

    <!-- Pending Bookings (Need Approval) -->
    @if (Model.PendingBookings.Any())
    {
        <div class="card-minimal mb-5" style="border-left: 4px solid var(--warning);">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-clock-history" style="color: var(--warning);"></i> Pending Approval (@Model.PendingRequestsCount)
                </h2>
                <a href="/Owner/RentalRequests" class="btn-minimal btn-minimal-primary btn-minimal-sm">Review All</a>
            </div>
            <div class="grid-minimal">
                @foreach (var booking in Model.PendingBookings.Take(3))
                {
                    <div class="card-minimal card-minimal-compact" style="background: #fffbf0;">
                        <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: var(--space-4); align-items: center;">
                            <div>
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" 
                                         alt="@booking.Bike.Brand @booking.Bike.Model"
                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-md);" />
                                }
                                else
                                {
                                    <div style="width: 100px; height: 100px; background: var(--neutral-200); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-bicycle" style="font-size: 2rem; color: var(--neutral-400);"></i>
                                    </div>
                                }
                            </div>
                            <div>
                                <h5 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-2);">@booking.Bike.Brand @booking.Bike.Model</h5>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-person"></i> @booking.Renter.FullName
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-calendar"></i> @TimeZoneHelper.FormatPhilippineTime(booking.StartDate, "MMM dd, yyyy hh:mm tt")
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-hash"></i> Quantity: @booking.Quantity
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin: 0;">
                                    <strong>Amount:</strong> <span class="text-sage">₱@booking.TotalAmount.ToString("F0")</span>
                                </p>
                            </div>
                            <div>
                                <a href="/Owner/RentalRequests" class="btn-minimal btn-minimal-primary btn-minimal-sm">
                                    Review
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Overdue Rentals -->
    @if (Model.OverdueBookings.Any())
    {
        <div class="card-minimal mb-5" style="border-left: 4px solid var(--danger);">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-exclamation-triangle-fill" style="color: var(--danger);"></i> Overdue Returns (@Model.OverdueCount)
                </h2>
                <a href="/Owner/MyBikes?filter=active" class="btn-minimal btn-minimal-danger btn-minimal-sm">View All</a>
            </div>
            <div class="grid-minimal">
                @foreach (var booking in Model.OverdueBookings.Take(3))
                {
                    var overdueTime = DateTime.UtcNow - booking.EndDate;
                    <div class="card-minimal card-minimal-compact" style="background: #fee2e2;">
                        <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: var(--space-4); align-items: center;">
                            <div>
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" 
                                         alt="@booking.Bike.Brand @booking.Bike.Model"
                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-md);" />
                                }
                                else
                                {
                                    <div style="width: 100px; height: 100px; background: var(--neutral-200); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-bicycle" style="font-size: 2rem; color: var(--neutral-400);"></i>
                                    </div>
                                }
                            </div>
                            <div>
                                <h5 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-2); color: var(--danger);">@booking.Bike.Brand @booking.Bike.Model</h5>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-person"></i> @booking.Renter.FullName
                                </p>
                                <p style="font-size: 0.875rem; color: var(--danger); margin-bottom: var(--space-1); font-weight: 600;">
                                    <i class="bi bi-calendar-x"></i> Was due: @BiketaBai.Helpers.TimeZoneHelper.FormatPhilippineTime(booking.EndDate)
                                </p>
                                <p style="font-size: 0.875rem; color: var(--danger); margin: 0; font-weight: 600;">
                                    <i class="bi bi-clock"></i> Overdue by: @((int)overdueTime.TotalHours)h @((int)overdueTime.TotalMinutes % 60)m
                                </p>
                            </div>
                            <div>
                                <a href="/Owner/MyBikes?filter=active" class="btn-minimal btn-minimal-danger btn-minimal-sm">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Active Rentals -->
    @if (Model.ActiveBookings.Any())
    {
        <div class="card-minimal mb-5">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-bicycle"></i> Active Rentals
                </h2>
            </div>
            <div class="grid-minimal">
                @foreach (var booking in Model.ActiveBookings)
                {
                    <div class="card-minimal card-minimal-compact">
                        <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: var(--space-4); align-items: center;">
                            <div>
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" 
                                         alt="@booking.Bike.Brand @booking.Bike.Model"
                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: var(--radius-md);" />
                                }
                                else
                                {
                                    <div style="width: 100px; height: 100px; background: var(--neutral-200); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-bicycle" style="font-size: 2rem; color: var(--neutral-400);"></i>
                                    </div>
                                }
                            </div>
                            <div>
                                <h5 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-2);">@booking.Bike.Brand @booking.Bike.Model</h5>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-person"></i> @booking.Renter.FullName
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-telephone"></i> @booking.Renter.Phone
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-calendar-x"></i> Return by: @TimeZoneHelper.FormatPhilippineTime(booking.EndDate, "MMM dd, yyyy hh:mm tt")
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin: 0;">
                                    <strong>Earning:</strong> <span class="text-sage">₱@((booking.TotalAmount * 0.9m).ToString("F0"))</span>
                                </p>
                            </div>
                            <div>
                                <a href="/Bookings/Details/@booking.BookingId" class="btn-minimal btn-minimal-primary btn-minimal-sm">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- My Bikes -->
    <div class="card-minimal mb-5">
        <div class="card-minimal-header">
            <h2 class="card-minimal-title">
                <i class="bi bi-bicycle"></i> My Bikes
            </h2>
            <a href="/Owner/MyBikes" class="btn-minimal btn-minimal-ghost btn-minimal-sm">View All</a>
        </div>
        @if (Model.Bikes.Any())
        {
            <div style="overflow-x: auto;">
                <table class="table-minimal">
                    <thead>
                        <tr>
                            <th>Bike</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Rate</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bike in Model.Bikes.Take(5))
                        {
                            <tr>
                                <td><strong>@bike.Brand @bike.Model</strong></td>
                                <td><span class="badge-minimal badge-minimal-primary">@bike.BikeType.TypeName</span></td>
                                <td>
                                    @switch (bike.AvailabilityStatusId)
                                    {
                                        case 1:
                                            <span class="badge-minimal badge-minimal-success">Available</span>
                                            break;
                                        case 2:
                                            <span class="badge-minimal badge-minimal-primary">Rented</span>
                                            break;
                                        case 3:
                                            <span class="badge-minimal badge-minimal-warning">Maintenance</span>
                                            break;
                                        case 4:
                                            <span class="badge-minimal badge-minimal-danger">Inactive</span>
                                            break;
                                    }
                                </td>
                                <td>₱@bike.HourlyRate/hr</td>
                                <td>
                                    @{
                                        var avgRating = Model.BikeRatings.ContainsKey(bike.BikeId) ? Model.BikeRatings[bike.BikeId] : 0;
                                        for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star-fill" 
                                               style="color: @(i <= avgRating ? "var(--sage-primary)" : "var(--neutral-300)"); font-size: 0.875rem;"></i>
                                        }
                                    }
                                </td>
                                <td>
                                    <a href="/Owner/EditBike/@bike.BikeId" class="btn-minimal btn-minimal-outline btn-minimal-sm">Edit</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div style="text-align: center; padding: var(--space-8);">
                <i class="bi bi-bicycle" style="font-size: 3rem; color: var(--neutral-300); margin-bottom: var(--space-4);"></i>
                <p style="color: var(--neutral-600); margin-bottom: var(--space-4);">No bikes listed yet.</p>
                <a href="/Owner/AddBike" class="btn-minimal btn-minimal-primary">Add Your First Bike</a>
            </div>
        }
    </div>

    <!-- Recent Bookings -->
    <div class="card-minimal">
        <div class="card-minimal-header">
            <h2 class="card-minimal-title">
                <i class="bi bi-clock-history"></i> Recent Bookings
            </h2>
        </div>
        @if (Model.RecentBookings.Any())
        {
            <div style="overflow-x: auto;">
                <table class="table-minimal">
                    <thead>
                        <tr>
                            <th>Bike</th>
                            <th>Renter</th>
                            <th>Dates</th>
                            <th>Earning</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.RecentBookings.Take(10))
                        {
                            <tr>
                                <td><strong>@booking.Bike.Brand @booking.Bike.Model</strong></td>
                                <td>@booking.Renter.FullName</td>
                                <td>
                                    <div style="font-size: 0.875rem;">
                                        @TimeZoneHelper.FormatPhilippineTime(booking.StartDate, "MMM dd")<br />
                                        <span style="color: var(--neutral-500);">to @TimeZoneHelper.FormatPhilippineTime(booking.EndDate, "MMM dd")</span>
                                    </div>
                                </td>
                                <td><strong class="text-sage">₱@((booking.TotalAmount * 0.9m).ToString("F0"))</strong></td>
                                <td>
                                    @switch (booking.BookingStatusId)
                                    {
                                        case 1:
                                            <span class="badge-minimal badge-minimal-warning">Pending</span>
                                            break;
                                        case 2:
                                            <span class="badge-minimal badge-minimal-primary">Active</span>
                                            break;
                                        case 3:
                                            <span class="badge-minimal badge-minimal-success">Completed</span>
                                            break;
                                        case 4:
                                            <span class="badge-minimal badge-minimal-danger">Cancelled</span>
                                            break;
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div style="text-align: center; padding: var(--space-8);">
                <i class="bi bi-clock-history" style="font-size: 3rem; color: var(--neutral-300); margin-bottom: var(--space-4);"></i>
                <p style="color: var(--neutral-600);">No bookings yet</p>
            </div>
        }
    </div>
</div>

<style>
    .alert-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all var(--transition-base);
    }
    
    .alert-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .alert-badge-warning {
        background: #fffbf0;
        color: #f57c00;
        border: 1px solid #ffcc80;
    }
    
    .alert-badge-danger {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fca5a5;
    }
    
    .alert-badge-info {
        background: #e0f2fe;
        color: #0284c7;
        border: 1px solid #7dd3fc;
    }
</style>
