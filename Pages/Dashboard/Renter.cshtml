@page
@using Microsoft.AspNetCore.Authorization
@using BiketaBai.Helpers
@attribute [Authorize]
@model RenterDashboardModel
@{
    ViewData["Title"] = "Renter Dashboard";
}

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
        <p class="page-subtitle">Manage your bike rentals and track your eco impact</p>
    </div>

    <!-- Stats Overview -->
    <div class="grid-minimal grid-minimal-4 mb-5">
        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-bicycle"></i>
            </div>
            <div class="stat-value">@Model.ActiveRentalsCount</div>
            <div class="stat-label">Active Rentals</div>
        </div>
        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-value">@Model.TotalRentalsCount</div>
            <div class="stat-label">Total Rentals</div>
        </div>
        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-value">₱@Model.TotalSpent.ToString("F0")</div>
            <div class="stat-label">Total Spent</div>
        </div>
        <div class="stat-card-minimal">
            <div class="stat-icon stat-icon-primary">
                <i class="bi bi-leaf"></i>
            </div>
            <div class="stat-value">@Model.CO2Saved.ToString("F0")</div>
            <div class="stat-label">kg CO₂ Saved</div>
        </div>
    </div>

    <!-- Active Rentals -->
    @if (Model.ActiveBookings.Any())
    {
        <div class="card-minimal mb-4">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-bicycle"></i> Active Rentals
                </h2>
            </div>
            <div class="grid-minimal">
                @foreach (var booking in Model.ActiveBookings)
                {
                    <div class="card-minimal card-minimal-compact">
                        <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: var(--space-4); align-items: center;">
                            <div>
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" 
                                         class="img-fluid rounded-minimal" 
                                         alt="Bike"
                                         style="width: 100px; height: 100px; object-fit: cover;" />
                                }
                                else
                                {
                                    <div style="width: 100px; height: 100px; background: var(--neutral-200); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-bicycle" style="font-size: 2rem; color: var(--neutral-400);"></i>
                                    </div>
                                }
                            </div>
                            <div>
                                <h5 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-2);">@booking.Bike.Brand @booking.Bike.Model</h5>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-tag"></i> @booking.Bike.BikeType.TypeName
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-person"></i> @booking.Bike.Owner.FullName
                                </p>
                                <p style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">
                                    <i class="bi bi-calendar-x"></i> Return by: @TimeZoneHelper.FormatPhilippineTime(booking.EndDate)
                                </p>
                                <div style="font-size: 0.875rem; font-weight: 600; color: var(--sage-primary);">
                                    <i class="bi bi-clock"></i> <span class="time-remaining" data-end-date="@TimeZoneHelper.FormatPhilippineTimeIso(booking.EndDate)">Calculating...</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--sage-primary); margin-bottom: var(--space-3);">
                                    ₱@booking.TotalAmount.ToString("F0")
                                </div>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <a href="/Bookings/TrackLocation/@booking.BookingId" class="btn-minimal btn-minimal-outline btn-minimal-sm w-100">
                                        <i class="bi bi-geo-alt-fill"></i> Track
                                    </a>
                                    <a href="/Bookings/Details/@booking.BookingId" class="btn-minimal btn-minimal-primary btn-minimal-sm w-100">View</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Quick Actions -->
    <div class="card-minimal mb-4">
        <div class="card-minimal-header">
            <h2 class="card-minimal-title">
                <i class="bi bi-lightning-charge"></i> Quick Actions
            </h2>
        </div>
        <div class="grid-minimal grid-minimal-4">
            <a href="/Bikes/Browse" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-search"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Browse Bikes</div>
            </a>
            <a href="/Renter/RentalHistory" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Rental History</div>
            </a>
            <a href="/Wallet/Index" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">My Wallet</div>
            </a>
        </div>
        <div class="grid-minimal grid-minimal-4" style="margin-top: var(--space-3);">
            <a href="/Notifications/Index" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-bell"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Notifications</div>
            </a>
            <a href="/Account/Profile" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Profile</div>
            </a>
            <a href="/Renter/Review" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-star"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Write Review</div>
            </a>
            <a href="/Bookings/Payment" class="card-minimal card-minimal-compact" style="text-decoration: none; text-align: center; transition: all var(--transition-base);">
                <div style="font-size: 2rem; color: var(--sage-primary); margin-bottom: var(--space-2);">
                    <i class="bi bi-credit-card"></i>
                </div>
                <div style="font-weight: 600; color: var(--neutral-800);">Payment</div>
            </a>
        </div>
    </div>

    <!-- Recent Bookings -->
    <div class="card-minimal">
        <div class="card-minimal-header">
            <h2 class="card-minimal-title">
                <i class="bi bi-clock-history"></i> Recent Bookings
            </h2>
            <a href="/Renter/RentalHistory" class="btn-minimal btn-minimal-ghost btn-minimal-sm">View All</a>
        </div>
        @if (Model.RecentBookings.Any())
        {
            <div style="overflow-x: auto;">
                <table class="table-minimal">
                    <thead>
                        <tr>
                            <th>Bike</th>
                            <th>Dates</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.RecentBookings)
                        {
                            <tr>
                                <td><strong>@booking.Bike.Brand @booking.Bike.Model</strong></td>
                                <td>
                                    <div style="font-size: 0.875rem;">
                                        @TimeZoneHelper.FormatPhilippineTime(booking.StartDate, "MMM dd")<br />
                                        <span style="color: var(--neutral-500);">to @TimeZoneHelper.FormatPhilippineTime(booking.EndDate, "MMM dd")</span>
                                    </div>
                                </td>
                                <td><strong>₱@booking.TotalAmount.ToString("F0")</strong></td>
                                <td>
                                    @switch (booking.BookingStatus)
                                    {
                                        case "Pending":
                                            <span class="badge-minimal badge-minimal-warning">Pending</span>
                                            break;
                                        case "Active":
                                            <span class="badge-minimal badge-minimal-primary">Active</span>
                                            break;
                                        case "Completed":
                                            <span class="badge-minimal badge-minimal-success">Completed</span>
                                            break;
                                        case "Cancelled":
                                            <span class="badge-minimal badge-minimal-danger">Cancelled</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <a href="/Bookings/Details/@booking.BookingId" class="btn-minimal btn-minimal-outline btn-minimal-sm">
                                        View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div style="text-align: center; padding: var(--space-8);">
                <i class="bi bi-bicycle" style="font-size: 3rem; color: var(--neutral-300); margin-bottom: var(--space-4);"></i>
                <p style="color: var(--neutral-600); margin-bottom: var(--space-4);">No bookings yet.</p>
                <a href="/Bikes/Browse" class="btn-minimal btn-minimal-primary">Browse Bikes</a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Helper function to get current Philippine time (UTC+8)
        function getPhilippineTime() {
            const now = new Date();
            // Get current time in Philippine timezone
            const phTimeStr = now.toLocaleString('en-US', { 
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // Parse the string to create a Date object
            // Format: "MM/DD/YYYY, HH:MM:SS"
            const parts = phTimeStr.split(', ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            
            // Create date in local timezone but representing Philippine time
            const phDate = new Date(
                parseInt(dateParts[2]), // year
                parseInt(dateParts[0]) - 1, // month (0-indexed)
                parseInt(dateParts[1]), // day
                parseInt(timeParts[0]), // hour
                parseInt(timeParts[1]), // minute
                parseInt(timeParts[2]) // second
            );
            
            return phDate;
        }
        
        // Time remaining countdown - uses Philippine time (UTC+8)
        function updateTimeRemaining() {
            document.querySelectorAll('.time-remaining').forEach(function(element) {
                const endDateStr = element.getAttribute('data-end-date');
                if (!endDateStr) return;
                
                // Parse the end date - it's in Philippine time format (YYYY-MM-DDTHH:mm:ss)
                const endDateParts = endDateStr.split('T');
                const dateParts = endDateParts[0].split('-');
                const timeParts = endDateParts[1].split(':');
                
                // Create end date in local timezone but representing Philippine time values
                const endDate = new Date(
                    parseInt(dateParts[0]), // year
                    parseInt(dateParts[1]) - 1, // month (0-indexed)
                    parseInt(dateParts[2]), // day
                    parseInt(timeParts[0]), // hour
                    parseInt(timeParts[1]), // minute
                    parseInt(timeParts[2]) // second
                );
                
                // Get current Philippine time
                const nowPhilippine = getPhilippineTime();
                
                // Calculate difference in milliseconds
                const diff = endDate.getTime() - nowPhilippine.getTime();
                
                if (diff <= 0) {
                    element.textContent = 'Time expired';
                    element.style.color = 'var(--danger)';
                    return;
                }
                
                const totalSeconds = Math.floor(diff / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                // Reset color to default
                element.style.color = 'var(--sage-primary)';
                
                if (hours > 0) {
                    element.textContent = hours + 'h ' + minutes + 'm remaining';
                } else if (minutes > 0) {
                    element.textContent = minutes + 'm ' + seconds + 's remaining';
                    if (minutes < 60) {
                        element.style.color = 'var(--warning)';
                    }
                } else {
                    element.textContent = seconds + 's remaining';
                    element.style.color = 'var(--danger)';
                }
            });
        }
        
        // Update immediately and then every second
        updateTimeRemaining();
        setInterval(updateTimeRemaining, 1000);
    </script>
}

