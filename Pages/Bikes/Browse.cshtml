@page
@model BrowseModel
@{
    ViewData["Title"] = "Find Bikes Near You";
}

<!-- Link Minimal CSS -->
<link rel="stylesheet" href="~/css/bikes-minimal.css" asp-append-version="true" />

<!-- Streamlined Browse Container -->
<div class="browse-streamlined-container">
    <!-- Simple Header Bar -->
    <div class="browse-top-bar">
        <div class="container">
            <div class="browse-header-content">
                <div class="browse-title-section">
                    <h1 class="browse-title">Available Bikes</h1>
                    <span class="browse-count">@Model.Bikes.Count bike(s) ready</span>
                </div>
                
                <!-- Filter Toggle Button -->
                <button type="button" class="btn-filter-toggle" id="filterToggleBtn">
                    <i class="bi bi-sliders"></i>
                    <span>Search & Filter</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Collapsible Filter Panel -->
    <div class="filter-panel-collapsible" id="filterPanel">
        <div class="filter-panel-overlay" id="filterPanelOverlay"></div>
        <div class="filter-panel-content">
            <div class="container">
                <div class="filter-panel-header">
                    <h3>
                        <i class="bi bi-search"></i>
                        Search & Filter Bikes
                    </h3>
                    <button type="button" class="btn-close-panel" id="closePanelBtn">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <form method="get" id="filterForm" class="filter-form-streamlined">
                    <!-- Search Location -->
                    <div class="filter-row">
                        <div class="filter-col">
                            <label class="filter-label-stream">
                                <i class="bi bi-geo-alt"></i> Location
                            </label>
                            <input type="text" name="location" class="filter-input-stream" 
                                   value="@Model.FilterLocation" 
                                   placeholder="Enter location..." />
                        </div>

                        <!-- Bike Type -->
                        <div class="filter-col">
                            <label class="filter-label-stream">
                                <i class="bi bi-bicycle"></i> Bike Type
                            </label>
                            <select name="bikeTypeId" class="filter-input-stream">
                                <option value="">All Types</option>
                                @foreach (var type in Model.BikeTypes)
                                {
                                    <option value="@type.BikeTypeId" selected="@(type.BikeTypeId == Model.FilterBikeTypeId)">
                                        @type.TypeName
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Price Range -->
                        <div class="filter-col">
                            <label class="filter-label-stream">
                                <i class="bi bi-cash-stack"></i> Price Range (₱/hr)
                            </label>
                            <div class="price-inputs-group">
                                <input type="number" name="minPrice" class="filter-input-stream filter-input-small" 
                                       value="@Model.FilterMinPrice" placeholder="Min" step="10" min="0" />
                                <span class="price-divider">to</span>
                                <input type="number" name="maxPrice" class="filter-input-stream filter-input-small" 
                                       value="@Model.FilterMaxPrice" placeholder="Max" step="10" min="0" />
                            </div>
                        </div>

                        <!-- Sort By -->
                        <div class="filter-col">
                            <label class="filter-label-stream">
                                <i class="bi bi-sort-down"></i> Sort By
                            </label>
                            <select name="sortBy" class="filter-input-stream">
                                <option value="newest" selected="@(Model.SortBy == "newest")">Newest First</option>
                                <option value="price-low" selected="@(Model.SortBy == "price-low")">Price: Low to High</option>
                                <option value="price-high" selected="@(Model.SortBy == "price-high")">Price: High to Low</option>
                                <option value="rating" selected="@(Model.SortBy == "rating")">Highest Rated</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-actions-stream">
                        <button type="submit" class="btn-stream-primary">
                            <i class="bi bi-search"></i> Apply Search
                        </button>
                        <a href="/Bikes/Browse" class="btn-stream-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Active Filters Display -->
    @if (Model.FilterBikeTypeId.HasValue || Model.FilterMinPrice.HasValue || Model.FilterMaxPrice.HasValue || !string.IsNullOrEmpty(Model.FilterLocation))
    {
        <div class="active-filters-bar">
            <div class="container">
                <div class="active-filters-content">
                    <span class="active-filters-label">
                        <i class="bi bi-funnel-fill"></i> Active Filters:
                    </span>
                    <div class="active-filters-tags">
                        @if (!string.IsNullOrEmpty(Model.FilterLocation))
                        {
                            <span class="filter-chip">
                                <i class="bi bi-geo-alt-fill"></i> @Model.FilterLocation
                                <a href="?bikeTypeId=@Model.FilterBikeTypeId&minPrice=@Model.FilterMinPrice&maxPrice=@Model.FilterMaxPrice&sortBy=@Model.SortBy" 
                                   class="chip-remove">×</a>
                            </span>
                        }
                        @if (Model.FilterBikeTypeId.HasValue)
                        {
                            var bikeType = Model.BikeTypes.FirstOrDefault(t => t.BikeTypeId == Model.FilterBikeTypeId.Value);
                            if (bikeType != null)
                            {
                                <span class="filter-chip">
                                    <i class="bi bi-bicycle"></i> @bikeType.TypeName
                                    <a href="?location=@Model.FilterLocation&minPrice=@Model.FilterMinPrice&maxPrice=@Model.FilterMaxPrice&sortBy=@Model.SortBy" 
                                       class="chip-remove">×</a>
                                </span>
                            }
                        }
                        @if (Model.FilterMinPrice.HasValue || Model.FilterMaxPrice.HasValue)
                        {
                            <span class="filter-chip">
                                <i class="bi bi-cash"></i> ₱@(Model.FilterMinPrice ?? 0) - ₱@(Model.FilterMaxPrice?.ToString() ?? "∞")
                                <a href="?location=@Model.FilterLocation&bikeTypeId=@Model.FilterBikeTypeId&sortBy=@Model.SortBy" 
                                   class="chip-remove">×</a>
                            </span>
                        }
                    </div>
                    <a href="/Bikes/Browse" class="btn-clear-all">Clear All</a>
                </div>
            </div>
        </div>
    }

    <!-- Bikes Grid - Main Focus -->
    <div class="bikes-display-main">
        <div class="container">
            @if (Model.Bikes.Any())
            {
                <div class="bikes-grid-streamlined">
                    @foreach (var bike in Model.Bikes)
                    {
                        var avgRating = Model.BikeRatings.ContainsKey(bike.BikeId) ? Model.BikeRatings[bike.BikeId] : 0;
                        <div class="bike-card-stream">
                            <!-- Bike Image -->
                            <a href="/Bikes/Details/@bike.BikeId" class="bike-image-link">
                                <div class="bike-image-stream">
                                    @if (bike.BikeImages.Any())
                                    {
                                        <img src="@bike.BikeImages.First(img => img.IsPrimary || bike.BikeImages.First() == img).ImageUrl" 
                                             alt="@bike.Brand @bike.Model" 
                                             loading="lazy" />
                                    }
                                    else
                                    {
                                        <div class="bike-image-placeholder-stream">
                                            <i class="bi bi-bicycle"></i>
                                        </div>
                                    }
                                    
                                    <!-- Type Badge -->
                                    <span class="bike-type-badge">@bike.BikeType.TypeName</span>
                                    
                                    <!-- Featured Badge -->
                                    @if (avgRating >= 4.5)
                                    {
                                        <span class="featured-badge-stream">
                                            <i class="bi bi-star-fill"></i> Top Rated
                                        </span>
                                    }
                                </div>
                            </a>

                            <!-- Card Info -->
                            <div class="bike-info-stream">
                                <h3 class="bike-name-stream">
                                    <a href="/Bikes/Details/@bike.BikeId">@bike.Brand @bike.Model</a>
                                </h3>
                                
                                <!-- Rating -->
                                <div class="bike-rating-stream">
                                    <div class="stars-stream">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= avgRating)
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                    </div>
                                    <span class="rating-number">@avgRating.ToString("F1")</span>
                                </div>
                                
                                <!-- Location -->
                                <div class="bike-location-stream">
                                    <i class="bi bi-bicycle-fill"></i>
                                    <span>@bike.BikeType.TypeName</span>
                                </div>
                                
                                <!-- Price & CTA -->
                                <div class="bike-footer-stream">
                                    <div class="bike-pricing">
                                        <span class="price-main">₱@bike.HourlyRate<small>/hr</small></span>
                                        <span class="price-sub">₱@bike.DailyRate/day</span>
                                    </div>
                                    <a href="/Bikes/Details/@bike.BikeId" class="btn-rent-now">
                                        <span>Rent Now</span>
                                        <i class="bi bi-arrow-right-circle-fill"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Empty State -->
                <div class="empty-state-stream">
                    <div class="empty-icon-stream">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3>No bikes found</h3>
                    <p>Try adjusting your search filters or browse all available bikes</p>
                    <a href="/Bikes/Browse" class="btn-stream-primary">
                        <i class="bi bi-grid-3x2-gap"></i> View All Bikes
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const filterToggleBtn = $('#filterToggleBtn');
            const filterPanel = $('#filterPanel');
            const filterPanelOverlay = $('#filterPanelOverlay');
            const closePanelBtn = $('#closePanelBtn');
            const body = $('body');
            
            // Open filter panel
            filterToggleBtn.click(function() {
                filterPanel.addClass('show');
                body.addClass('filter-panel-open');
            });
            
            // Close filter panel
            function closeFilterPanel() {
                filterPanel.removeClass('show');
                body.removeClass('filter-panel-open');
            }
            
            closePanelBtn.click(closeFilterPanel);
            filterPanelOverlay.click(closeFilterPanel);
            
            // Close on ESC key
            $(document).keydown(function(e) {
                if (e.key === 'Escape' && filterPanel.hasClass('show')) {
                    closeFilterPanel();
                }
            });
            
            // Close panel after form submit
            $('#filterForm').submit(function() {
                setTimeout(closeFilterPanel, 300);
            });
            
            // Smooth scroll animations
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 400,
                    once: true,
                    offset: 50
                });
            }
            
            // Add animation class to cards on load
            $('.bike-card-stream').each(function(index) {
                $(this).css('animation-delay', (index * 0.05) + 's');
            });
        });
    </script>
    
    <script src="https://unpkg.com/aos@@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@@2.3.1/dist/aos.css" rel="stylesheet">
}
