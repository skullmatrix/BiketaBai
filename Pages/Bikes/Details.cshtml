@page "{id:int}"
@model DetailsModel
@{
    ViewData["Title"] = $"{Model.Bike?.Brand} {Model.Bike?.Model}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/bike-rental.css" asp-append-version="true" />
    <style>
        /* Force styles to load and override Bootstrap */
        .bike-details-page {
            background: #fafafa !important;
        }
        
        .bike-details-grid {
            display: grid !important;
            grid-template-columns: 1fr 400px !important;
            gap: 2rem !important;
        }
        
        .bike-specs-card,
        .bike-reviews-card,
        .booking-card,
        .rules-compact {
            background: #ffffff !important;
            border-radius: 12px !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
            border: 1px solid #e5e5e5 !important;
        }
        
        .btn-sage-primary {
            background: #6b8e5f !important;
            color: #ffffff !important;
            border-radius: 8px !important;
        }
        
        @@media (max-width: 992px) {
            .bike-details-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
}

@if (Model.Bike == null)
{
    <div class="bike-details-not-found">
        <div class="container">
            <div class="not-found-content">
                <i class="bi bi-bicycle"></i>
                <h2>Bike not found</h2>
                <p>The bike you're looking for doesn't exist or has been removed.</p>
                <a href="/Bikes/Browse" class="btn-sage-primary">Browse Bikes</a>
            </div>
        </div>
    </div>
}
else
{
    <div class="bike-details-page">
        <div class="container">
            <!-- Compact Breadcrumb -->
            <nav class="bike-breadcrumb" aria-label="breadcrumb">
                <a href="/" class="breadcrumb-link">Home</a>
                <i class="bi bi-chevron-right"></i>
                <a href="/Bikes/Browse" class="breadcrumb-link">Browse</a>
                <i class="bi bi-chevron-right"></i>
                <span class="breadcrumb-current">@Model.Bike.Brand @Model.Bike.Model</span>
            </nav>

            <div class="bike-details-grid">
                <!-- Left Column: Images & Info -->
                <div class="bike-details-main">
                    <!-- Image Gallery - Compact -->
                    <div class="bike-gallery-wrapper">
                        @if (Model.Bike.BikeImages.Any())
                        {
                            <div id="bikeCarousel" class="carousel slide bike-gallery-main" data-bs-ride="carousel" data-bs-interval="false">
                                <div class="carousel-inner">
                                    @for (int i = 0; i < Model.Bike.BikeImages.Count; i++)
                                    {
                                        var img = Model.Bike.BikeImages.ToList()[i];
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@img.ImageUrl" class="d-block w-100" alt="@Model.Bike.Brand @Model.Bike.Model" />
                                        </div>
                                    }
                                </div>
                                @if (Model.Bike.BikeImages.Count > 1)
                                {
                                    <button class="carousel-control-prev" type="button" data-bs-target="#bikeCarousel" data-bs-slide="prev">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#bikeCarousel" data-bs-slide="next">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    <div class="gallery-indicator">
                                        <span id="currentImage">1</span> / <span id="totalImages">@Model.Bike.BikeImages.Count</span>
                                    </div>
                                }
                            </div>
                            
                            @if (Model.Bike.BikeImages.Count > 1)
                            {
                                <div class="bike-gallery-thumbs">
                                    @for (int i = 0; i < Math.Min(Model.Bike.BikeImages.Count, 5); i++)
                                    {
                                        var img = Model.Bike.BikeImages.ToList()[i];
                                        <div class="gallery-thumb @(i == 0 ? "active" : "")" data-slide-to="@i">
                                            <img src="@img.ImageUrl" alt="Thumbnail @(i + 1)" />
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="bike-gallery-placeholder">
                                <i class="bi bi-bicycle"></i>
                                <p>No images available</p>
                            </div>
                        }
                    </div>

                    <!-- Compact Specs Card -->
                    <div class="bike-specs-card">
                        <div class="specs-header">
                            <h3><i class="bi bi-info-circle"></i> Details</h3>
                        </div>
                        <div class="specs-grid">
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-tag"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Brand</span>
                                    <span class="spec-value">@Model.Bike.Brand</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-gear"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Model</span>
                                    <span class="spec-value">@Model.Bike.Model</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-bicycle"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Type</span>
                                    <span class="spec-badge badge-sage">@Model.Bike.BikeType.TypeName</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-check-circle"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Status</span>
                                    <span class="spec-badge badge-success">@Model.Bike.AvailabilityStatus.StatusName</span>
                                </div>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.Bike.Description))
                        {
                            <div class="specs-description">
                                <h4><i class="bi bi-chat-left-text"></i> About this bike</h4>
                                <p>@Model.Bike.Description</p>
                            </div>
                        }
                    </div>

                    <!-- Compact Reviews Section -->
                    <div class="bike-reviews-card">
                        <div class="reviews-header">
                            <div>
                                <h3><i class="bi bi-star-fill"></i> Reviews</h3>
                                <p class="reviews-subtitle">@Model.AverageRating.ToString("F1") · @Model.RatingCount review(s)</p>
                            </div>
                            <div class="rating-display">
                                <span class="rating-number">@Model.AverageRating.ToString("F1")</span>
                                <div class="rating-stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi bi-star-fill @(i <= Model.AverageRating ? "filled" : "")"></i>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (Model.Ratings.Any())
                        {
                            <div class="reviews-list">
                                @foreach (var rating in Model.Ratings.Take(5))
                                {
                                    <div class="review-item">
                                        <div class="review-header">
                                            <div class="reviewer-info">
                                                <strong>@(rating.Rater?.FullName ?? "Anonymous")</strong>
                                                <div class="review-stars">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        <i class="bi bi-star-fill @(i <= rating.RatingValue ? "filled" : "")"></i>
                                                    }
                                                </div>
                                            </div>
                                            <span class="review-date">@rating.CreatedAt.ToString("MMM yyyy")</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(rating.Review))
                                        {
                                            <p class="review-text">@rating.Review</p>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="reviews-empty">
                                <i class="bi bi-chat-left-dots"></i>
                                <p>No reviews yet. Be the first to review!</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Right Column: Booking Card -->
                <div class="bike-booking-sidebar">
                    <div class="booking-card">
                        <!-- Header -->
                        <div class="booking-header">
                            <div class="price-section">
                                <div class="price-main">
                                    <span class="price-amount">₱@Model.Bike.HourlyRate</span>
                                    <span class="price-unit">/hour</span>
                                </div>
                                <div class="price-alt">₱@Model.Bike.DailyRate /day</div>
                            </div>
                            
                            @if (Model.Bike.Owner != null)
                            {
                                <div class="owner-section">
                                    <div class="owner-label">Owner</div>
                                    <div class="owner-name">@Model.Bike.Owner.FullName</div>
                                    <div class="owner-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star-fill @(i <= Model.OwnerRating ? "filled" : "")"></i>
                                        }
                                        <span>@Model.OwnerRating.ToString("F1")</span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Booking Form -->
                        <div class="booking-body">
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                @if (AuthHelper.IsRenter(User))
                                {
                                    @if (TempData["ErrorMessage"] != null)
                                    {
                                        <div class="alert alert-danger-compact" role="alert">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <span>@TempData["ErrorMessage"]</span>
                                        </div>
                                    }
                                    @if (TempData["SuccessMessage"] != null)
                                    {
                                        <div class="alert alert-success-compact" role="alert">
                                            <i class="bi bi-check-circle"></i>
                                            <span>@TempData["SuccessMessage"]</span>
                                        </div>
                                    }

                                    <form method="post" id="bookingForm">
                                        <div class="date-inputs">
                                            <div class="date-input-group">
                                                <label>
                                                    <i class="bi bi-calendar-event"></i>
                                                    <span>Start</span>
                                                </label>
                                                <input type="datetime-local" 
                                                       asp-for="Input.StartDate" 
                                                       class="input-sage" 
                                                       required 
                                                       min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" 
                                                       value="@(Model.Input.StartDate?.ToString("yyyy-MM-ddTHH:mm"))" />
                                            </div>
                                            <div class="date-input-group">
                                                <label>
                                                    <i class="bi bi-calendar-x"></i>
                                                    <span>End</span>
                                                </label>
                                                <input type="datetime-local" 
                                                       asp-for="Input.EndDate" 
                                                       class="input-sage" 
                                                       required 
                                                       min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" 
                                                       value="@(Model.Input.EndDate?.ToString("yyyy-MM-ddTHH:mm"))" />
                                            </div>
                                        </div>

                                        <div id="pricingPreview" class="pricing-breakdown" style="display: none;">
                                            <div class="pricing-row">
                                                <span>Duration</span>
                                                <span id="rentalDuration">-</span>
                                            </div>
                                            <div class="pricing-row">
                                                <span>Base Rate</span>
                                                <span id="baseRate">₱0.00</span>
                                            </div>
                                            <div class="pricing-row">
                                                <span>Service Fee (10%)</span>
                                                <span id="serviceFee">₱0.00</span>
                                            </div>
                                            <div class="pricing-total">
                                                <span>Total</span>
                                                <span id="totalAmount">₱0.00</span>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn-sage-primary btn-booking">
                                            <i class="bi bi-calendar-check"></i>
                                            <span>Reserve Now</span>
                                        </button>
                                        
                                        <div class="booking-note">
                                            <i class="bi bi-shield-check"></i>
                                            <span>Free cancellation up to 24 hours before start</span>
                                        </div>
                                    </form>
                                }
                                else
                                {
                                    <div class="alert alert-info-compact" role="alert">
                                        <i class="bi bi-info-circle"></i>
                                        <div>
                                            <strong>Renter account required</strong>
                                            <p>Update your profile to book bikes.</p>
                                            <a href="/Account/Profile" class="link-sage">Update Profile →</a>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <a href="/Account/Login?returnUrl=/Bikes/Details/@Model.Bike.BikeId" class="btn-sage-primary btn-booking">
                                    <i class="bi bi-box-arrow-in-right"></i>
                                    <span>Login to Book</span>
                                </a>
                            }
                        </div>
                    </div>

                    <!-- Quick Rules -->
                    <div class="rules-compact">
                        <h4><i class="bi bi-shield-check"></i> Rental Guidelines</h4>
                        <ul class="rules-list">
                            <li><i class="bi bi-check-circle"></i> Valid ID required</li>
                            <li><i class="bi bi-clock"></i> Return on time</li>
                            <li><i class="bi bi-shield-exclamation"></i> Responsible for damage</li>
                            <li><i class="bi bi-x-circle"></i> No subletting</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @if (Model.Bike != null)
    {
        <script>
            $(document).ready(function() {
                const hourlyRate = @Model.Bike.HourlyRate;
                const dailyRate = @Model.Bike.DailyRate;
                const totalImages = @Model.Bike.BikeImages.Count;

                // Gallery thumbnail navigation
                $('.gallery-thumb').on('click', function() {
                    const slideTo = $(this).data('slide-to');
                    $('#bikeCarousel').carousel(slideTo);
                    $('.gallery-thumb').removeClass('active');
                    $(this).addClass('active');
                });

                // Update image counter
                $('#bikeCarousel').on('slid.bs.carousel', function() {
                    const activeIndex = $(this).find('.carousel-item.active').index() + 1;
                    $('#currentImage').text(activeIndex);
                    $('.gallery-thumb').removeClass('active');
                    $('.gallery-thumb').eq(activeIndex - 1).addClass('active');
                });

                function formatDuration(hours) {
                    if (hours < 1) {
                        return Math.round(hours * 60) + ' min';
                    } else if (hours < 24) {
                        return hours.toFixed(1) + ' hrs';
                    } else {
                        const days = Math.floor(hours / 24);
                        const remainingHours = Math.round(hours % 24);
                        return days + (days === 1 ? ' day' : ' days') + 
                               (remainingHours > 0 ? ' ' + remainingHours + 'h' : '');
                    }
                }

                function calculatePricing() {
                    const startDateVal = $('#Input_StartDate').val();
                    const endDateVal = $('#Input_EndDate').val();

                    if (!startDateVal || !endDateVal) {
                        $('#pricingPreview').hide();
                        return;
                    }

                    const startDate = new Date(startDateVal);
                    const endDate = new Date(endDateVal);

                    if (startDate && endDate && endDate > startDate) {
                        const hours = (endDate - startDate) / (1000 * 60 * 60);
                        const days = hours / 24;

                        let baseRate = 0;
                        if (days >= 1) {
                            const fullDays = Math.floor(days);
                            const remainingHours = hours - (fullDays * 24);
                            baseRate = (fullDays * dailyRate) + (remainingHours * hourlyRate);
                        } else {
                            baseRate = hours * hourlyRate;
                        }

                        const serviceFee = baseRate * 0.1;
                        const total = baseRate + serviceFee;

                        $('#rentalDuration').text(formatDuration(hours));
                        $('#baseRate').text('₱' + baseRate.toFixed(2));
                        $('#serviceFee').text('₱' + serviceFee.toFixed(2));
                        $('#totalAmount').text('₱' + total.toFixed(2));
                        
                        // Show pricing preview - use show() for immediate display on page load
                        $('#pricingPreview').show();
                    } else {
                        $('#pricingPreview').hide();
                    }
                }

                $('#Input_StartDate, #Input_EndDate').on('change input', calculatePricing);

                $('#Input_EndDate').on('change', function() {
                    const startDateVal = $('#Input_StartDate').val();
                    const endDateVal = $(this).val();
                    
                    if (startDateVal && endDateVal) {
                        const startDate = new Date(startDateVal);
                        const endDate = new Date(endDateVal);
                        
                        if (endDate <= startDate) {
                            alert('End date must be after start date');
                            $(this).val('');
                        }
                    }
                });

                $('#Input_StartDate').on('change', function() {
                    const startDate = $(this).val();
                    if (startDate) {
                        $('#Input_EndDate').attr('min', startDate);
                    }
                });

                // Calculate pricing on page load if dates are already set (after error reload)
                function initializePricing() {
                    const startDateVal = $('#Input_StartDate').val();
                    const endDateVal = $('#Input_EndDate').val();
                    
                    if (startDateVal && endDateVal) {
                        // Set min date for end date based on start date
                        if (startDateVal) {
                            $('#Input_EndDate').attr('min', startDateVal);
                        }
                        // Calculate pricing immediately
                        calculatePricing();
                    }
                }
                
                // Run on page load
                initializePricing();
                
                // Also run after a short delay to ensure DOM is ready
                setTimeout(function() {
                    initializePricing();
                }, 100);
            });
        </script>
    }
}
