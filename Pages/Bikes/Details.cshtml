@page "{id:int}"
@model DetailsModel
@{
    ViewData["Title"] = $"{Model.Bike?.Brand} {Model.Bike?.Model}";
}

@if (Model.Bike == null)
{
    <div class="container my-5 text-center">
        <h2 class="text-muted">Bike not found</h2>
        <a href="/Bikes/Browse" class="btn btn-eco-primary">Browse Bikes</a>
    </div>
}
else
{
    <div class="container my-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/Bikes/Browse">Browse Bikes</a></li>
                <li class="breadcrumb-item active">@Model.Bike.Brand @Model.Bike.Model</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Image Gallery -->
            <div class="col-md-7">
                @if (Model.Bike.BikeImages.Any())
                {
                    <div id="bikeCarousel" class="carousel slide shadow-eco rounded" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Bike.BikeImages.Count; i++)
                            {
                                var img = Model.Bike.BikeImages.ToList()[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@img.ImageUrl" class="d-block w-100" alt="@Model.Bike.Brand @Model.Bike.Model" style="height: 400px; object-fit: cover;" />
                                </div>
                            }
                        </div>
                        @if (Model.Bike.BikeImages.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#bikeCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#bikeCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        }
                    </div>
                }
                else
                {
                    <img src="/images/placeholder-bike.jpg" class="img-fluid rounded shadow-eco" alt="Bike" />
                }

                <!-- Bike Details -->
                <div class="card mt-4 shadow-sm border-0">
                    <div class="card-body">
                        <h4 class="mb-4"><i class="bi bi-info-circle text-success"></i> Bike Specifications</h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-tag text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Brand</small>
                                        <p class="mb-0 fw-bold">@Model.Bike.Brand</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-gear text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Model</small>
                                        <p class="mb-0 fw-bold">@Model.Bike.Model</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-bicycle text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Type</small>
                                        <p class="mb-0"><span class="badge bg-success">@Model.Bike.BikeType.TypeName</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-speedometer text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Mileage</small>
                                        <p class="mb-0 fw-bold">@Model.Bike.Mileage km</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-geo-alt text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Location</small>
                                        <p class="mb-0 fw-bold">@Model.Bike.Location</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="spec-item">
                                    <i class="bi bi-check-circle text-muted"></i>
                                    <div class="spec-content">
                                        <small class="text-muted">Status</small>
                                        <p class="mb-0"><span class="badge bg-success">@Model.Bike.AvailabilityStatus.StatusName</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.Bike.Description))
                        {
                            <hr class="my-4" />
                            <h5 class="mb-3"><i class="bi bi-chat-left-text text-success"></i> Description</h5>
                            <p class="text-muted">@Model.Bike.Description</p>
                        }
                    </div>
                </div>

                <!-- Rental Rules Section -->
                <div class="card mt-4 shadow-sm border-0">
                    <div class="card-body">
                        <h4 class="mb-4"><i class="bi bi-shield-check text-warning"></i> Rental Rules & Guidelines</h4>
                        
                        <div class="rules-section">
                            <div class="rule-item">
                                <div class="rule-icon bg-success">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>Valid ID Required</h6>
                                    <p class="text-muted small mb-0">Present a valid government-issued ID upon bike pickup</p>
                                </div>
                            </div>
                            
                            <div class="rule-item">
                                <div class="rule-icon bg-primary">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>Return on Time</h6>
                                    <p class="text-muted small mb-0">Late returns incur additional charges. Please respect the agreed return time</p>
                                </div>
                            </div>
                            
                            <div class="rule-item">
                                <div class="rule-icon bg-warning">
                                    <i class="bi bi-shield-exclamation"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>Damage Responsibility</h6>
                                    <p class="text-muted small mb-0">Renter is responsible for any damage beyond normal wear and tear</p>
                                </div>
                            </div>
                            
                            <div class="rule-item">
                                <div class="rule-icon bg-info">
                                    <i class="bi bi-bicycle"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>Proper Use Only</h6>
                                    <p class="text-muted small mb-0">Use bike for its intended purpose only. No racing or extreme conditions</p>
                                </div>
                            </div>
                            
                            <div class="rule-item">
                                <div class="rule-icon bg-danger">
                                    <i class="bi bi-x-circle"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>No Subletting</h6>
                                    <p class="text-muted small mb-0">Bike cannot be sublet or loaned to third parties</p>
                                </div>
                            </div>
                            
                            <div class="rule-item">
                                <div class="rule-icon bg-secondary">
                                    <i class="bi bi-arrow-left-right"></i>
                                </div>
                                <div class="rule-content">
                                    <h6>Return in Same Condition</h6>
                                    <p class="text-muted small mb-0">Clean and return bike in the same condition as received</p>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4 mb-0">
                            <i class="bi bi-info-circle"></i> <strong>Cancellation Policy:</strong> Free cancellation up to 24 hours before rental start time. Cancellations within 24 hours may incur a 50% fee.
                        </div>
                    </div>
                </div>

                <!-- Ratings and Reviews -->
                <div class="card mt-4 shadow-sm border-0">
                    <div class="card-body">
                        <h4 class="mb-4"><i class="bi bi-star-fill text-warning"></i> Ratings & Reviews</h4>
                        
                        <!-- Rating Summary -->
                        <div class="rating-summary-box">
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center">
                                    <div class="average-rating-display">
                                        <h1 class="display-3 fw-bold mb-0">@Model.AverageRating.ToString("F1")</h1>
                                        <div class="rating-stars mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= Model.AverageRating)
                                                {
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star text-warning"></i>
                                                }
                                            }
                                        </div>
                                        <p class="text-muted mb-0">Based on @Model.RatingCount review(s)</p>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="rating-breakdown">
                                        @for (int star = 5; star >= 1; star--)
                                        {
                                            var count = Model.Ratings.Count(r => r.RatingValue == star);
                                            var percentage = Model.RatingCount > 0 ? (count * 100.0 / Model.RatingCount) : 0;
                                            <div class="rating-bar-row">
                                                <span class="rating-label">@star <i class="bi bi-star-fill text-warning small"></i></span>
                                                <div class="progress flex-grow-1 mx-2">
                                                    <div class="progress-bar bg-warning" role="progressbar" style="width: @percentage%"></div>
                                                </div>
                                                <span class="rating-count">@count</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.Ratings.Any())
                        {
                            <hr class="my-4" />
                            <h5 class="mb-3">Customer Reviews</h5>
                            @foreach (var rating in Model.Ratings.Take(10))
                            {
                                <div class="review-card">
                                    <div class="d-flex align-items-start">
                                        <div class="reviewer-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <h6 class="mb-1">@rating.Rater.FullName</h6>
                                                    <div class="rating-stars">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (i <= rating.RatingValue)
                                                            {
                                                                <i class="bi bi-star-fill text-warning"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-star text-warning"></i>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                                <small class="text-muted">
                                                    <i class="bi bi-clock"></i> @rating.CreatedAt.ToString("MMM dd, yyyy")
                                                </small>
                                            </div>
                                            @if (!string.IsNullOrEmpty(rating.Review))
                                            {
                                                <p class="review-text mb-0">@rating.Review</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-chat-left-dots" style="font-size: 3rem; color: #ddd;"></i>
                                <p class="text-muted mt-3 mb-0">No reviews yet. Be the first to review this bike!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Booking Card -->
            <div class="col-md-5">
                <div class="card shadow-eco sticky-top" style="top: 20px;">
                    <div class="card-body">
                        <h3 class="text-eco-green mb-3">@Model.Bike.Brand @Model.Bike.Model</h3>
                        
                        <div class="mb-3">
                            <div class="price-tag">₱@Model.Bike.HourlyRate<span class="fs-6 text-muted">/hr</span></div>
                            <div class="text-muted">₱@Model.Bike.DailyRate per day</div>
                        </div>

                        <!-- Owner Info -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="text-eco-green">Bike Owner</h6>
                                <p class="mb-1"><strong>@Model.Bike.Owner.FullName</strong></p>
                                <div class="rating-stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Model.OwnerRating)
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star"></i>
                                        }
                                    }
                                    <span class="text-muted">(@Model.OwnerRating.ToString("F1"))</span>
                                </div>
                                <p class="text-muted small mb-0">Member since @Model.Bike.Owner.CreatedAt.ToString("MMM yyyy")</p>
                            </div>
                        </div>

                        @if (User.Identity?.IsAuthenticated == true && AuthHelper.IsRenter(User))
                        {
                            <form method="post">
                                <!-- Date & Time Selection -->
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="text-eco-green mb-3"><i class="bi bi-calendar-event"></i> Rental Period</h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-play-circle"></i> Start Date & Time
                                            </label>
                                            <input type="datetime-local" asp-for="Input.StartDate" class="form-control form-control-lg" required min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                                            <small class="text-muted">When you'll pick up the bike</small>
                                        </div>
                                        <div class="mb-0">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-stop-circle"></i> End Date & Time
                                            </label>
                                            <input type="datetime-local" asp-for="Input.EndDate" class="form-control form-control-lg" required />
                                            <small class="text-muted">When you'll return the bike</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Location Selection -->
                                <div class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 class="text-eco-green mb-3"><i class="bi bi-geo-alt"></i> Pickup & Return Locations</h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-geo-alt-fill text-success"></i> Pickup Location
                                            </label>
                                            <input type="text" asp-for="Input.PickupLocation" class="form-control" placeholder="Enter pickup address or landmark" required />
                                            <small class="text-muted">Where you'll collect the bike</small>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="sameAsPickup" />
                                            <label class="form-check-label" for="sameAsPickup">
                                                <small>Return to same location</small>
                                            </label>
                                        </div>
                                        <div class="mb-0" id="returnLocationDiv">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-geo-alt-fill text-danger"></i> Return Location
                                            </label>
                                            <input type="text" asp-for="Input.ReturnLocation" class="form-control" placeholder="Enter return address or landmark" id="returnLocationInput" />
                                            <small class="text-muted">Where you'll drop off the bike</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Optional Distance -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-speedometer2"></i> Estimated Distance (Optional)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" asp-for="Input.DistanceSavedKm" class="form-control" step="0.1" placeholder="0.0" />
                                        <span class="input-group-text">km</span>
                                    </div>
                                    <small class="text-muted">Help us track your eco-friendly impact!</small>
                                </div>

                                <!-- Pricing Preview -->
                                <div id="pricingPreview" class="card border-success mb-3" style="display: none;">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="bi bi-calculator"></i> Pricing Breakdown</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="bi bi-clock"></i> Rental Duration</span>
                                            <strong id="rentalDuration">-</strong>
                                        </div>
                                        <hr />
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Base Rate</span>
                                            <span id="baseRate">₱0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Service Fee (10%)</span>
                                            <span id="serviceFee">₱0.00</span>
                                        </div>
                                        <hr />
                                        <div class="d-flex justify-content-between">
                                            <strong class="text-eco-green">Total Amount</strong>
                                            <strong class="text-eco-green fs-5" id="totalAmount">₱0.00</strong>
                                        </div>
                                        <div class="alert alert-info mt-3 mb-0 small">
                                            <i class="bi bi-info-circle"></i> Free cancellation up to 24 hours before start time
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-eco-primary w-100 btn-lg shadow">
                                    <i class="bi bi-calendar-check"></i> Confirm Booking
                                </button>
                            </form>
                        }
                        else
                        {
                            <a href="/Account/Login?returnUrl=/Bikes/Details/@Model.Bike.BikeId" class="btn btn-eco-primary w-100 btn-lg">
                                Login to Book
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            const hourlyRate = @Model.Bike.HourlyRate;
            const dailyRate = @Model.Bike.DailyRate;

            // Handle "Same as pickup" checkbox
            $('#sameAsPickup').on('change', function() {
                if ($(this).is(':checked')) {
                    const pickupLocation = $('#Input_PickupLocation').val();
                    $('#Input_ReturnLocation').val(pickupLocation);
                    $('#returnLocationDiv').hide();
                } else {
                    $('#returnLocationDiv').show();
                }
            });

            // Auto-fill return location when pickup changes and checkbox is checked
            $('#Input_PickupLocation').on('input', function() {
                if ($('#sameAsPickup').is(':checked')) {
                    $('#Input_ReturnLocation').val($(this).val());
                }
            });

            function formatDuration(hours) {
                if (hours < 1) {
                    return Math.round(hours * 60) + ' minutes';
                } else if (hours < 24) {
                    return hours.toFixed(1) + ' hours';
                } else {
                    const days = Math.floor(hours / 24);
                    const remainingHours = Math.round(hours % 24);
                    return days + (days === 1 ? ' day' : ' days') + 
                           (remainingHours > 0 ? ' ' + remainingHours + ' hrs' : '');
                }
            }

            function calculatePricing() {
                const startDate = new Date($('#Input_StartDate').val());
                const endDate = new Date($('#Input_EndDate').val());

                if (startDate && endDate && endDate > startDate) {
                    const hours = (endDate - startDate) / (1000 * 60 * 60);
                    const days = hours / 24;

                    let baseRate = 0;
                    if (days >= 1) {
                        const fullDays = Math.floor(days);
                        const remainingHours = hours - (fullDays * 24);
                        baseRate = (fullDays * dailyRate) + (remainingHours * hourlyRate);
                    } else {
                        baseRate = hours * hourlyRate;
                    }

                    const serviceFee = baseRate * 0.1;
                    const total = baseRate + serviceFee;

                    $('#rentalDuration').text(formatDuration(hours));
                    $('#baseRate').text('₱' + baseRate.toFixed(2));
                    $('#serviceFee').text('₱' + serviceFee.toFixed(2));
                    $('#totalAmount').text('₱' + total.toFixed(2));
                    $('#pricingPreview').fadeIn();
                } else {
                    $('#pricingPreview').fadeOut();
                }
            }

            // Calculate pricing when dates change
            $('#Input_StartDate, #Input_EndDate').on('change', calculatePricing);

            // Validate that end date is after start date
            $('#Input_EndDate').on('change', function() {
                const startDate = new Date($('#Input_StartDate').val());
                const endDate = new Date($(this).val());
                
                if (startDate && endDate && endDate <= startDate) {
                    alert('End date must be after start date');
                    $(this).val('');
                }
            });

            // Set minimum end date based on start date
            $('#Input_StartDate').on('change', function() {
                const startDate = $(this).val();
                if (startDate) {
                    $('#Input_EndDate').attr('min', startDate);
                }
            });
        });
    </script>
}

