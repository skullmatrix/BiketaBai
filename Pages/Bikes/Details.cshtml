@page "{id:int}"
@model DetailsModel
@{
    ViewData["Title"] = $"{Model.Bike?.Brand} {Model.Bike?.Model}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/bike-rental.css" asp-append-version="true" />
    <style>
        /* Force styles to load and override Bootstrap */
        .bike-details-page {
            background: #fafafa !important;
        }
        
        .bike-details-grid {
            display: grid !important;
            grid-template-columns: 1fr 400px !important;
            gap: 2rem !important;
        }
        
        .bike-specs-card,
        .bike-reviews-card,
        .booking-card,
        .rules-compact {
            background: #ffffff !important;
            border-radius: 12px !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
            border: 1px solid #e5e5e5 !important;
        }
        
        .btn-sage-primary {
            background: #6b8e5f !important;
            color: #ffffff !important;
            border-radius: 8px !important;
        }
        
        @@media (max-width: 992px) {
            .bike-details-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
}

@if (Model.Bike == null)
{
    <div class="bike-details-not-found">
        <div class="container">
            <div class="not-found-content">
                <i class="bi bi-bicycle"></i>
                <h2>Bike not found</h2>
                <p>The bike you're looking for doesn't exist or has been removed.</p>
                <a href="/Bikes/Browse" class="btn-sage-primary">Browse Bikes</a>
            </div>
        </div>
    </div>
}
else
{
    <div class="bike-details-page">
        <div class="container">
            <!-- Compact Breadcrumb -->
            <nav class="bike-breadcrumb" aria-label="breadcrumb">
                <a href="/" class="breadcrumb-link">Home</a>
                <i class="bi bi-chevron-right"></i>
                <a href="/Bikes/Browse" class="breadcrumb-link">Browse</a>
                <i class="bi bi-chevron-right"></i>
                <span class="breadcrumb-current">@Model.Bike.Brand @Model.Bike.Model</span>
            </nav>

            <div class="bike-details-grid">
                <!-- Left Column: Images & Info -->
                <div class="bike-details-main">
                    <!-- Image Gallery - Compact -->
                    <div class="bike-gallery-wrapper">
                        @if (Model.Bike.BikeImages.Any())
                        {
                            <div id="bikeCarousel" class="carousel slide bike-gallery-main" data-bs-ride="carousel" data-bs-interval="false">
                                <div class="carousel-inner">
                                    @for (int i = 0; i < Model.Bike.BikeImages.Count; i++)
                                    {
                                        var img = Model.Bike.BikeImages.ToList()[i];
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@img.ImageUrl" class="d-block w-100" alt="@Model.Bike.Brand @Model.Bike.Model" />
                                        </div>
                                    }
                                </div>
                                @if (Model.Bike.BikeImages.Count > 1)
                                {
                                    <button class="carousel-control-prev" type="button" data-bs-target="#bikeCarousel" data-bs-slide="prev">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#bikeCarousel" data-bs-slide="next">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    <div class="gallery-indicator">
                                        <span id="currentImage">1</span> / <span id="totalImages">@Model.Bike.BikeImages.Count</span>
                                    </div>
                                }
                            </div>
                            
                            @if (Model.Bike.BikeImages.Count > 1)
                            {
                                <div class="bike-gallery-thumbs">
                                    @for (int i = 0; i < Math.Min(Model.Bike.BikeImages.Count, 5); i++)
                                    {
                                        var img = Model.Bike.BikeImages.ToList()[i];
                                        <div class="gallery-thumb @(i == 0 ? "active" : "")" data-slide-to="@i">
                                            <img src="@img.ImageUrl" alt="Thumbnail @(i + 1)" />
                                        </div>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="bike-gallery-placeholder">
                                <i class="bi bi-bicycle"></i>
                                <p>No images available</p>
                            </div>
                        }
                    </div>

                    <!-- Compact Specs Card -->
                    <div class="bike-specs-card">
                        <div class="specs-header">
                            <h3><i class="bi bi-info-circle"></i> Details</h3>
                        </div>
                        <div class="specs-grid">
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-tag"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Brand</span>
                                    <span class="spec-value">@Model.Bike.Brand</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-gear"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Model</span>
                                    <span class="spec-value">@Model.Bike.Model</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-bicycle"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Type</span>
                                    <span class="spec-badge badge-sage">@Model.Bike.BikeType.TypeName</span>
                                </div>
                            </div>
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-check-circle"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Status</span>
                                    <span class="spec-badge badge-success">@Model.Bike.AvailabilityStatus.StatusName</span>
                                </div>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.Bike.Description))
                        {
                            <div class="specs-description">
                                <h4><i class="bi bi-chat-left-text"></i> About this bike</h4>
                                <p>@Model.Bike.Description</p>
                            </div>
                        }
                    </div>

                    <!-- Compact Reviews Section -->
                    <div class="bike-reviews-card">
                        <div class="reviews-header">
                            <div>
                                <h3><i class="bi bi-star-fill"></i> Reviews</h3>
                                <p class="reviews-subtitle">@Model.AverageRating.ToString("F1") · @Model.RatingCount review(s)</p>
                            </div>
                            <div class="rating-display">
                                <span class="rating-number">@Model.AverageRating.ToString("F1")</span>
                                <div class="rating-stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi bi-star-fill @(i <= Model.AverageRating ? "filled" : "")"></i>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (Model.Ratings.Any())
                        {
                            <div class="reviews-list">
                                @foreach (var rating in Model.Ratings.Take(5))
                                {
                                    <div class="review-item">
                                        <div class="review-header">
                                            <div class="reviewer-info">
                                                <strong>@(rating.Rater?.FullName ?? "Anonymous")</strong>
                                                <div class="review-stars">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        <i class="bi bi-star-fill @(i <= rating.RatingValue ? "filled" : "")"></i>
                                                    }
                                                </div>
                                            </div>
                                            <span class="review-date">@rating.CreatedAt.ToString("MMM yyyy")</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(rating.Review))
                                        {
                                            <p class="review-text">@rating.Review</p>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="reviews-empty">
                                <i class="bi bi-chat-left-dots"></i>
                                <p>No reviews yet. Be the first to review!</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Right Column: Booking Card -->
                <div class="bike-booking-sidebar">
                    <div class="booking-card">
                        <!-- Header -->
                        <div class="booking-header">
                            <div class="price-section">
                                <div class="price-main">
                                    <span class="price-amount">₱@Model.Bike.HourlyRate</span>
                                    <span class="price-unit">/hour</span>
                                </div>
                                <div class="price-alt">₱@Model.Bike.DailyRate /day</div>
                            </div>
                            
                            @if (Model.Bike.Owner != null)
                            {
                                <div class="owner-section">
                                    <div class="owner-label">Owner</div>
                                    <div class="owner-name">@Model.Bike.Owner.FullName</div>
                                    <div class="owner-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star-fill @(i <= Model.OwnerRating ? "filled" : "")"></i>
                                        }
                                        <span>@Model.OwnerRating.ToString("F1")</span>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Booking Form -->
                        <div class="booking-body">
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                @if (AuthHelper.IsRenter(User))
                                {
                                    @if (TempData["ErrorMessage"] != null)
                                    {
                                        <div class="alert-minimal alert-minimal-error mb-3">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                            <div>@TempData["ErrorMessage"]</div>
                                        </div>
                                    }
                                    @if (TempData["SuccessMessage"] != null)
                                    {
                                        <div class="alert-minimal alert-minimal-success mb-3">
                                            <i class="bi bi-check-circle-fill"></i>
                                            <div>@TempData["SuccessMessage"]</div>
                                        </div>
                                    }
                                    
                                    <form method="post" id="bookingForm">
                                        <!-- Booking Mode Toggle -->
                                        <div class="booking-mode-toggle mb-3">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2);">
                                                <input type="radio" class="btn-check" name="bookingMode" id="modeHours" value="hours" checked style="display: none;">
                                                <label class="btn-minimal btn-minimal-ghost" for="modeHours" style="margin: 0; justify-content: center;">
                                                    <i class="bi bi-clock"></i> By Hours
                                                </label>
                                                <input type="radio" class="btn-check" name="bookingMode" id="modeDateTime" value="datetime" style="display: none;">
                                                <label class="btn-minimal btn-minimal-ghost" for="modeDateTime" style="margin: 0; justify-content: center;">
                                                    <i class="bi bi-calendar"></i> Specific Time
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Hours Input Mode -->
                                        <div id="hoursMode" class="booking-mode-content">
                                            <div class="mb-3">
                                                <label for="rentalHours" class="form-label" style="font-size: 0.875rem; font-weight: 500; color: #495057;">
                                                    <i class="bi bi-clock"></i> Rental Duration
                                                </label>
                                                <div style="display: flex; gap: var(--space-2);">
                                                    <input type="number" 
                                                           id="rentalHours" 
                                                           class="input-minimal" 
                                                           min="1" 
                                                           max="168" 
                                                           step="0.5" 
                                                           value="2"
                                                           placeholder="Enter hours"
                                                           style="flex: 1;">
                                                    <span style="display: flex; align-items: center; padding: 0 var(--space-3); background: var(--neutral-100); border-radius: var(--radius-md); font-size: 0.875rem; color: var(--neutral-600);">hours</span>
                                                </div>
                                                <small class="form-text text-muted">Start time will be now. Booking activates immediately after payment.</small>
                                            </div>
                                            
                                            <!-- Quick Hour Selection -->
                                            <div class="quick-hours-section mb-3">
                                                <label class="mb-2" style="font-size: 0.875rem; font-weight: 500; color: #495057;">
                                                    <i class="bi bi-lightning"></i> Quick Select
                                                </label>
                                                <div class="quick-hours-buttons">
                                                    <button type="button" class="btn-quick-hour" data-hours="2">2 hrs</button>
                                                    <button type="button" class="btn-quick-hour" data-hours="4">4 hrs</button>
                                                    <button type="button" class="btn-quick-hour" data-hours="8">8 hrs</button>
                                                    <button type="button" class="btn-quick-hour" data-hours="12">12 hrs</button>
                                                    <button type="button" class="btn-quick-hour" data-hours="24">1 day</button>
                                                    <button type="button" class="btn-quick-hour" data-hours="48">2 days</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- DateTime Input Mode -->
                                        <div id="datetimeMode" class="booking-mode-content" style="display: none;">
                                            <div class="date-inputs">
                                                <div class="date-input-group">
                                                    <label>
                                                        <i class="bi bi-calendar-event"></i>
                                                        <span>Start</span>
                                                    </label>
                                                    <input type="datetime-local" 
                                                           asp-for="Input.StartDate" 
                                                           id="Input_StartDate"
                                                           class="input-minimal" 
                                                           min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" 
                                                           value="@(Model.Input.StartDate?.ToString("yyyy-MM-ddTHH:mm"))" />
                                                </div>
                                                <div class="date-input-group">
                                                    <label>
                                                        <i class="bi bi-calendar-x"></i>
                                                        <span>End</span>
                                                    </label>
                                                    <input type="datetime-local" 
                                                           asp-for="Input.EndDate" 
                                                           id="Input_EndDate"
                                                           class="input-minimal" 
                                                           min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" 
                                                           value="@(Model.Input.EndDate?.ToString("yyyy-MM-ddTHH:mm"))" />
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Hidden inputs for form submission -->
                                        <input type="hidden" asp-for="Input.StartDate" id="hidden_StartDate" />
                                        <input type="hidden" asp-for="Input.EndDate" id="hidden_EndDate" />

                                        <div id="pricingPreview" class="pricing-breakdown" style="display: none;">
                                            <div class="pricing-row">
                                                <span>Duration</span>
                                                <span id="rentalDuration">-</span>
                                            </div>
                                            <div class="pricing-row">
                                                <span>Base Rate</span>
                                                <span id="baseRate">₱0.00</span>
                                            </div>
                                            <div class="pricing-row">
                                                <span>Service Fee (10%)</span>
                                                <span id="serviceFee">₱0.00</span>
                                            </div>
                                            <div class="pricing-total">
                                                <span>Total</span>
                                                <span id="totalAmount">₱0.00</span>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn-minimal btn-minimal-primary w-100" id="submitBtn" style="padding: 1rem;">
                                            <i class="bi bi-calendar-check"></i>
                                            <span>Reserve Now</span>
                                        </button>
                                        
                                        <div style="text-align: center; margin-top: var(--space-3); font-size: 0.875rem; color: var(--neutral-600);">
                                            <i class="bi bi-shield-check"></i>
                                            <span>Free cancellation up to 24 hours before start</span>
                                        </div>
                                    </form>
                                }
                                else
                                {
                                    <div class="alert alert-info-compact" role="alert">
                                        <i class="bi bi-info-circle"></i>
                                        <div>
                                            <strong>Renter account required</strong>
                                            <p>Update your profile to book bikes.</p>
                                            <a href="/Account/Profile" class="link-sage">Update Profile →</a>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <a href="/Account/Login?returnUrl=/Bikes/Details/@Model.Bike.BikeId" class="btn-sage-primary btn-booking">
                                    <i class="bi bi-box-arrow-in-right"></i>
                                    <span>Login to Book</span>
                                </a>
                            }
                        </div>
                    </div>

                    <!-- Quick Rules -->
                    <div class="rules-compact">
                        <h4><i class="bi bi-shield-check"></i> Rental Guidelines</h4>
                        <ul class="rules-list">
                            <li><i class="bi bi-check-circle"></i> Valid ID required</li>
                            <li><i class="bi bi-clock"></i> Return on time</li>
                            <li><i class="bi bi-shield-exclamation"></i> Responsible for damage</li>
                            <li><i class="bi bi-x-circle"></i> No subletting</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @if (Model.Bike != null)
    {
        <script>
            $(document).ready(function() {
                const hourlyRate = @Model.Bike.HourlyRate;
                const dailyRate = @Model.Bike.DailyRate;
                const totalImages = @Model.Bike.BikeImages.Count;

                // Gallery thumbnail navigation
                $('.gallery-thumb').on('click', function() {
                    const slideTo = $(this).data('slide-to');
                    $('#bikeCarousel').carousel(slideTo);
                    $('.gallery-thumb').removeClass('active');
                    $(this).addClass('active');
                });

                // Update image counter
                $('#bikeCarousel').on('slid.bs.carousel', function() {
                    const activeIndex = $(this).find('.carousel-item.active').index() + 1;
                    $('#currentImage').text(activeIndex);
                    $('.gallery-thumb').removeClass('active');
                    $('.gallery-thumb').eq(activeIndex - 1).addClass('active');
                });

                // Booking mode toggle
                $('input[name="bookingMode"]').on('change', function() {
                    const mode = $(this).val();
                    if (mode === 'hours') {
                        $('#hoursMode').show();
                        $('#datetimeMode').hide();
                        $('#Input_StartDate, #Input_EndDate').removeAttr('required');
                        $('#rentalHours').attr('required', 'required');
                    } else {
                        $('#hoursMode').hide();
                        $('#datetimeMode').show();
                        $('#rentalHours').removeAttr('required');
                        $('#Input_StartDate, #Input_EndDate').attr('required', 'required');
                    }
                    calculatePricing();
                });

                // Hours input change handler
                $('#rentalHours').on('input change', function() {
                    const hours = parseFloat($(this).val()) || 0;
                    if (hours > 0) {
                        updateDatesFromHours(hours);
                        calculatePricing();
                    }
                });

                // Quick hour selection buttons
                $('.btn-quick-hour').on('click', function() {
                    const hours = parseFloat($(this).data('hours'));
                    $('#rentalHours').val(hours);
                    updateDatesFromHours(hours);
                    
                    // Update active state
                    $('.btn-quick-hour').removeClass('active');
                    $(this).addClass('active');
                    
                    // Calculate pricing
                    calculatePricing();
                });

                function updateDatesFromHours(hours) {
                    const now = new Date();
                    const startDate = new Date(now.getTime()); // Current time
                    const endDate = new Date(now.getTime() + hours * 60 * 60 * 1000);
                    
                    // Format dates for datetime-local input
                    const formatDateTime = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    };
                    
                    // Update hidden inputs for form submission
                    $('#hidden_StartDate').val(formatDateTime(startDate));
                    $('#hidden_EndDate').val(formatDateTime(endDate));
                    
                    // Also update visible datetime inputs if in datetime mode
                    $('#Input_StartDate').val(formatDateTime(startDate));
                    $('#Input_EndDate').val(formatDateTime(endDate));
                }

                // Form submission handler
                $('#bookingForm').on('submit', function(e) {
                    const mode = $('input[name="bookingMode"]:checked').val();
                    
                    if (mode === 'hours') {
                        // Ensure dates are set from hours input
                        const hours = parseFloat($('#rentalHours').val()) || 0;
                        if (hours <= 0) {
                            e.preventDefault();
                            alert('Please enter a valid number of hours (minimum 1 hour)');
                            return false;
                        }
                        updateDatesFromHours(hours);
                    } else {
                        // Validate datetime inputs
                        const startDate = $('#Input_StartDate').val();
                        const endDate = $('#Input_EndDate').val();
                        
                        if (!startDate || !endDate) {
                            e.preventDefault();
                            alert('Please select both start and end dates');
                            return false;
                        }
                        
                        // Update hidden inputs
                        $('#hidden_StartDate').val(startDate);
                        $('#hidden_EndDate').val(endDate);
                    }
                });

                // Initialize hours mode on page load
                updateDatesFromHours(parseFloat($('#rentalHours').val()) || 2);

                function formatDuration(hours) {
                    if (hours < 1) {
                        return Math.round(hours * 60) + ' min';
                    } else if (hours < 24) {
                        return hours.toFixed(1) + ' hrs';
                    } else {
                        const days = Math.floor(hours / 24);
                        const remainingHours = Math.round(hours % 24);
                        return days + (days === 1 ? ' day' : ' days') + 
                               (remainingHours > 0 ? ' ' + remainingHours + 'h' : '');
                    }
                }

                function calculatePricing() {
                    let startDate, endDate, hours;
                    
                    // Check which mode is active
                    const mode = $('input[name="bookingMode"]:checked').val();
                    
                    if (mode === 'hours') {
                        // Calculate from hours input
                        const rentalHours = parseFloat($('#rentalHours').val()) || 0;
                        if (rentalHours <= 0) {
                            $('#pricingPreview').hide();
                            return;
                        }
                        hours = rentalHours;
                    } else {
                        // Calculate from datetime inputs
                        const startDateVal = $('#Input_StartDate').val();
                        const endDateVal = $('#Input_EndDate').val();

                        if (!startDateVal || !endDateVal) {
                            $('#pricingPreview').hide();
                            return;
                        }

                        startDate = new Date(startDateVal);
                        endDate = new Date(endDateVal);

                        if (!startDate || !endDate || endDate <= startDate) {
                            $('#pricingPreview').hide();
                            return;
                        }

                        hours = (endDate - startDate) / (1000 * 60 * 60);
                    }

                    if (hours > 0) {
                        const days = hours / 24;

                        let baseRate = 0;
                        if (days >= 1) {
                            const fullDays = Math.floor(days);
                            const remainingHours = hours - (fullDays * 24);
                            baseRate = (fullDays * dailyRate) + (remainingHours * hourlyRate);
                        } else {
                            baseRate = hours * hourlyRate;
                        }

                        const serviceFee = baseRate * 0.1;
                        const total = baseRate + serviceFee;

                        $('#rentalDuration').text(formatDuration(hours));
                        $('#baseRate').text('₱' + baseRate.toFixed(2));
                        $('#serviceFee').text('₱' + serviceFee.toFixed(2));
                        $('#totalAmount').text('₱' + total.toFixed(2));
                        
                        // Show pricing preview
                        $('#pricingPreview').show();
                    } else {
                        $('#pricingPreview').hide();
                    }
                }

                $('#Input_StartDate, #Input_EndDate').on('change input', function() {
                    // Update hidden inputs when datetime inputs change
                    $('#hidden_StartDate').val($('#Input_StartDate').val());
                    $('#hidden_EndDate').val($('#Input_EndDate').val());
                    calculatePricing();
                });

                $('#Input_EndDate').on('change', function() {
                    const startDateVal = $('#Input_StartDate').val();
                    const endDateVal = $(this).val();
                    
                    if (startDateVal && endDateVal) {
                        const startDate = new Date(startDateVal);
                        const endDate = new Date(endDateVal);
                        
                        if (endDate <= startDate) {
                            alert('End date must be after start date');
                            $(this).val('');
                        }
                    }
                });

                $('#Input_StartDate').on('change', function() {
                    const startDate = $(this).val();
                    if (startDate) {
                        $('#Input_EndDate').attr('min', startDate);
                    }
                });

                // Calculate pricing on page load if dates are already set (after error reload)
                function initializePricing() {
                    const startDateVal = $('#Input_StartDate').val();
                    const endDateVal = $('#Input_EndDate').val();
                    
                    if (startDateVal && endDateVal) {
                        // Set min date for end date based on start date
                        if (startDateVal) {
                            $('#Input_EndDate').attr('min', startDateVal);
                        }
                        // Calculate pricing immediately
                        calculatePricing();
                    }
                }
                
                // Run on page load
                initializePricing();
                
                // Also run after a short delay to ensure DOM is ready
                setTimeout(function() {
                    initializePricing();
                }, 100);
            });
        </script>
    }
}
