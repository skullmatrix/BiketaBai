@page
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@model TestNotificationsModel
@{
    ViewData["Title"] = "Test Notifications";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

<style>
    .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    .test-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h3 {
        color: #333;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
    }
    .status-card {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }
    .debug-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 1rem;
        font-family: monospace;
        font-size: 0.875rem;
    }
    .btn-test {
        background: #667eea;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    .btn-test:hover {
        background: #5568d3;
    }
</style>

<div class="test-container">
    <h1 class="text-center mb-4">
        <i class="bi bi-bell-fill"></i> Notification System Test
    </h1>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Connection Status -->
    <div class="test-section">
        <h3><i class="bi bi-wifi"></i> SignalR Connection Status</h3>
        <div class="status-card">
            <strong>Current User ID:</strong> @(Model.CurrentUserId?.ToString() ?? "Not logged in")<br>
            <strong>Unread Notifications:</strong> @(Model.UnreadCount?.ToString() ?? "0")
        </div>
        <div class="debug-section" id="connectionStatus">
            <strong>Connection Status:</strong> <span id="connectionState">Checking...</span><br>
            <strong>Handlers Registered:</strong> <span id="handlersStatus">Checking...</span><br>
            <strong>Last Notification:</strong> <span id="lastNotification">None</span>
        </div>
        <button type="button" class="btn btn-primary btn-test" onclick="checkConnectionStatus()">
            <i class="bi bi-arrow-clockwise"></i> Refresh Status
        </button>
        <button type="button" class="btn btn-success btn-test" onclick="forceInitialize()">
            <i class="bi bi-power"></i> Force Initialize
        </button>
        <button type="button" class="btn btn-secondary btn-test" onclick="testSound()">
            <i class="bi bi-volume-up"></i> Test Sound
        </button>
        <button type="button" class="btn btn-secondary btn-test" onclick="testBadge()">
            <i class="bi bi-badge"></i> Test Badge
        </button>
    </div>

    <!-- Send Test Notification to Current User -->
    <div class="test-section">
        <h3><i class="bi bi-send"></i> Send Test Notification to Current User</h3>
        <p class="text-muted">This will send a notification to your own account to test the badge and sound.</p>
        <form method="post" asp-page-handler="SendToCurrentUser">
            <div class="mb-3">
                <label for="notificationTitle" class="form-label">Title</label>
                <input type="text" class="form-control" id="notificationTitle" asp-for="NotificationTitle" 
                       placeholder="Test Notification" />
            </div>
            <div class="mb-3">
                <label for="notificationMessage" class="form-label">Message</label>
                <textarea class="form-control" id="notificationMessage" asp-for="NotificationMessage" rows="3" 
                          placeholder="This is a test notification..."></textarea>
            </div>
            <div class="mb-3">
                <label for="notificationType" class="form-label">Type</label>
                <select class="form-control" id="notificationType" asp-for="NotificationType">
                    <option value="Test">Test</option>
                    <option value="Booking">Booking</option>
                    <option value="Payment">Payment</option>
                    <option value="Geofence">Geofence</option>
                    <option value="Reminder">Reminder</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send Notification to Me
            </button>
        </form>
    </div>

    <!-- Send Test Notification to Specific User -->
    <div class="test-section">
        <h3><i class="bi bi-person-plus"></i> Send Test Notification to Specific User</h3>
        <p class="text-muted">Enter a user ID to send a test notification to that user.</p>
        <form method="post" asp-page-handler="SendToUser">
            <div class="mb-3">
                <label for="testUserId" class="form-label">User ID</label>
                <input type="number" class="form-control" id="testUserId" asp-for="TestUserId" 
                       placeholder="Enter user ID" required />
            </div>
            <div class="mb-3">
                <label for="notificationTitle2" class="form-label">Title</label>
                <input type="text" class="form-control" id="notificationTitle2" asp-for="NotificationTitle" 
                       placeholder="Test Notification" />
            </div>
            <div class="mb-3">
                <label for="notificationMessage2" class="form-label">Message</label>
                <textarea class="form-control" id="notificationMessage2" asp-for="NotificationMessage" rows="3" 
                          placeholder="This is a test notification..."></textarea>
            </div>
            <div class="mb-3">
                <label for="notificationType2" class="form-label">Type</label>
                <select class="form-control" id="notificationType2" asp-for="NotificationType">
                    <option value="Test">Test</option>
                    <option value="Booking">Booking</option>
                    <option value="Payment">Payment</option>
                    <option value="Geofence">Geofence</option>
                    <option value="Reminder">Reminder</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send Notification
            </button>
        </form>
    </div>

    <!-- Send Test Booking Update -->
    <div class="test-section">
        <h3><i class="bi bi-calendar-check"></i> Send Test Booking Update</h3>
        <p class="text-muted">This will send a booking update notification to test the ReceiveBookingUpdate handler.</p>
        <form method="post" asp-page-handler="SendBookingUpdate">
            <div class="mb-3">
                <label for="notificationMessage3" class="form-label">Message</label>
                <textarea class="form-control" id="notificationMessage3" asp-for="NotificationMessage" rows="3" 
                          placeholder="This is a test booking update..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send Booking Update
            </button>
        </form>
    </div>

    <!-- Debug Information -->
    <div class="test-section">
        <h3><i class="bi bi-bug"></i> Debug Information</h3>
        <div class="debug-section" id="debugInfo">
            <strong>SignalR Library:</strong> <span id="signalRLibrary">Checking...</span><br>
            <strong>Global Connection:</strong> <span id="globalConnection">Checking...</span><br>
            <strong>Badge Element:</strong> <span id="badgeElement">Checking...</span><br>
            <strong>Authentication:</strong> <span id="authStatus">Checking...</span><br>
            <strong>Notification Permission:</strong> <span id="notificationPermission">Checking...</span>
        </div>
        <button type="button" class="btn btn-secondary btn-test" onclick="runDebugCheck()">
            <i class="bi bi-search"></i> Run Debug Check
        </button>
        <button type="button" class="btn btn-secondary btn-test" onclick="openConsole()">
            <i class="bi bi-terminal"></i> Open Console Guide
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script>
    // Check connection status
    function checkConnectionStatus() {
        // Check multiple sources for connection
        const conn = window.BiketaBaiNotifications?.connection || 
                     (typeof notificationHubConnection !== 'undefined' ? notificationHubConnection : null);
        const handlers = window.BiketaBaiNotifications?.handlersRegistered || false;
        const signalRLoaded = typeof signalR !== 'undefined';
        
        console.log('Checking connection status...', {
            globalConnection: !!window.BiketaBaiNotifications?.connection,
            localConnection: typeof notificationHubConnection !== 'undefined',
            signalRLoaded: signalRLoaded,
            handlers: handlers
        });
        
        if (!signalRLoaded) {
            document.getElementById('connectionState').innerHTML = '<span style="color: red;">‚ùå SignalR Library Not Loaded</span>';
            document.getElementById('handlersStatus').innerHTML = '<span style="color: red;">‚ùå N/A</span>';
            console.error('SignalR library not loaded!');
            return;
        }
        
        if (conn) {
            const state = conn.state;
            let stateText = 'Unknown';
            let stateNum = state;
            
            // Convert state number to text
            if (state === signalR.HubConnectionState.Connected || state === 1) {
                stateText = '<span style="color: green;">‚úÖ Connected</span>';
            } else if (state === signalR.HubConnectionState.Connecting || state === 0) {
                stateText = '<span style="color: orange;">üîÑ Connecting...</span>';
            } else if (state === signalR.HubConnectionState.Disconnected || state === 2) {
                stateText = '<span style="color: red;">‚ùå Disconnected</span>';
            } else if (state === signalR.HubConnectionState.Reconnecting || state === 3) {
                stateText = '<span style="color: orange;">üîÑ Reconnecting...</span>';
            } else {
                stateText = `<span style="color: orange;">‚ö†Ô∏è Unknown State (${state})</span>`;
            }
            
            document.getElementById('connectionState').innerHTML = stateText + ` (State: ${stateNum})`;
            document.getElementById('handlersStatus').innerHTML = handlers ? 
                '<span style="color: green;">‚úÖ Registered</span>' : 
                '<span style="color: red;">‚ùå Not Registered</span>';
            
            // If disconnected, try to reconnect
            if (state === signalR.HubConnectionState.Disconnected || state === 2) {
                console.warn('Connection is disconnected, attempting to reconnect...');
                if (typeof reconnectNotifications === 'function') {
                    reconnectNotifications();
                } else if (typeof initializeSignalR === 'function') {
                    initializeSignalR();
                }
            }
        } else {
            document.getElementById('connectionState').innerHTML = '<span style="color: red;">‚ùå No Connection Object</span>';
            document.getElementById('handlersStatus').innerHTML = '<span style="color: red;">‚ùå N/A</span>';
            console.warn('No connection object found. Attempting to initialize...');
            
            // Try to initialize if function exists
            if (typeof initializeSignalR === 'function') {
                console.log('Calling initializeSignalR()...');
                initializeSignalR();
                // Check again after a delay
                setTimeout(checkConnectionStatus, 2000);
            }
        }
    }

    // Test sound
    function testSound() {
        console.log('üîä Testing notification sound...');
        if (typeof playNotificationSound === 'function') {
            console.log('‚úÖ playNotificationSound function found, calling...');
            try {
                playNotificationSound();
                console.log('‚úÖ Sound function called successfully');
                alert('Sound test triggered! You should hear a notification sound. Check console for details.');
            } catch (error) {
                console.error('‚ùå Error playing sound:', error);
                alert('Error playing sound: ' + error.message);
            }
        } else {
            console.error('‚ùå playNotificationSound function not found');
            alert('playNotificationSound function not found. Make sure you are on a page with the notification system loaded.');
        }
    }

    // Test badge
    function testBadge() {
        console.log('üîî Testing notification badge...');
        const $badge = $('#notificationCountHeader');
        console.log('Badge element exists:', $badge.length > 0);
        
        if ($badge.length > 0) {
            console.log('Badge element details:', {
                id: $badge.attr('id'),
                class: $badge.attr('class'),
                currentDisplay: $badge.css('display'),
                currentText: $badge.text(),
                parent: $badge.parent().attr('id')
            });
        }
        
        if (typeof updateNotificationBadge === 'function') {
            const testCount = Math.floor(Math.random() * 10) + 1;
            console.log('Calling updateNotificationBadge with count:', testCount);
            updateNotificationBadge(testCount);
            
            // Check if badge is visible after update
            setTimeout(() => {
                const display = $badge.length > 0 ? window.getComputedStyle($badge[0]).display : 'element not found';
                const isVisible = $badge.length > 0 ? $badge.is(':visible') : false;
                console.log('Badge visibility after update:', { display, isVisible, text: $badge.text() });
                
                if (!isVisible || display === 'none') {
                    console.warn('‚ö†Ô∏è Badge is not visible! Trying to force show...');
                    $badge[0].style.setProperty('display', 'flex', 'important');
                    $badge.show();
                    
                    setTimeout(() => {
                        const newDisplay = window.getComputedStyle($badge[0]).display;
                        if (newDisplay === 'none') {
                            alert(`Badge test triggered but badge is still not visible! Count: ${testCount}\nCheck console for details.`);
                        } else {
                            alert(`Badge test triggered! Badge should now show ${testCount}.`);
                        }
                    }, 200);
                } else {
                    alert(`Badge test triggered! Badge should show ${testCount}.`);
                }
            }, 300);
        } else {
            console.error('‚ùå updateNotificationBadge function not found');
            alert('updateNotificationBadge function not found. Make sure you are on a page with the notification system loaded.');
        }
    }

    // Run debug check
    function runDebugCheck() {
        const conn = window.BiketaBaiNotifications?.connection;
        const connState = conn ? conn.state : 'N/A';
        const connStateText = conn ? 
            (connState === signalR.HubConnectionState.Connected || connState === 1 ? 'Connected' :
             connState === signalR.HubConnectionState.Connecting || connState === 0 ? 'Connecting' :
             connState === signalR.HubConnectionState.Disconnected || connState === 2 ? 'Disconnected' :
             connState === signalR.HubConnectionState.Reconnecting || connState === 3 ? 'Reconnecting' :
             `Unknown (${connState})`) : 'No Connection';
        
        const checks = {
            signalRLibrary: typeof signalR !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not Loaded',
            globalConnection: conn ? `‚úÖ Exists (${connStateText})` : '‚ùå Not Found',
            badgeElement: $('#notificationCountHeader').length > 0 ? '‚úÖ Found' : '‚ùå Not Found',
            authStatus: typeof isAuthenticated !== 'undefined' && isAuthenticated === "true" ? '‚úÖ Authenticated' : '‚ùå Not Authenticated',
            notificationPermission: 'Notification' in window ? 
                (Notification.permission === 'granted' ? '‚úÖ Granted' : 
                 Notification.permission === 'denied' ? '‚ùå Denied' : '‚ö†Ô∏è Default') : 
                '‚ùå Not Supported',
            handlersRegistered: window.BiketaBaiNotifications?.handlersRegistered ? '‚úÖ Yes' : '‚ùå No',
            initialized: window.BiketaBaiNotifications?.initialized ? '‚úÖ Yes' : '‚ùå No'
        };

        document.getElementById('signalRLibrary').textContent = checks.signalRLibrary;
        document.getElementById('globalConnection').textContent = checks.globalConnection;
        document.getElementById('badgeElement').textContent = checks.badgeElement;
        document.getElementById('authStatus').textContent = checks.authStatus;
        document.getElementById('notificationPermission').textContent = checks.notificationPermission;
        
        // Add more debug info
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.innerHTML = `
                <strong>SignalR Library:</strong> ${checks.signalRLibrary}<br>
                <strong>Global Connection:</strong> ${checks.globalConnection}<br>
                <strong>Badge Element:</strong> ${checks.badgeElement}<br>
                <strong>Authentication:</strong> ${checks.authStatus}<br>
                <strong>Notification Permission:</strong> ${checks.notificationPermission}<br>
                <strong>Handlers Registered:</strong> ${checks.handlersRegistered}<br>
                <strong>Initialized:</strong> ${checks.initialized}<br>
                <strong>Connection ID:</strong> ${conn?.connectionId || 'N/A'}<br>
                <strong>Hub URL:</strong> ${conn?.baseUrl || '/notificationHub'}
            `;
        }
        
        // If SignalR not loaded, show warning
        if (typeof signalR === 'undefined') {
            console.error('‚ùå SignalR library not loaded! Check if script tag is present.');
            alert('SignalR library not loaded! Please refresh the page.');
        }
        
        // If no connection and SignalR is loaded, try to initialize
        if (!conn && typeof signalR !== 'undefined' && typeof initializeSignalR === 'function') {
            console.log('No connection found but SignalR is loaded, attempting to initialize...');
            initializeSignalR();
        }
    }

    // Force initialize connection
    function forceInitialize() {
        console.log('üîß Force initializing SignalR connection...');
        
        // Reset global state
        if (window.BiketaBaiNotifications) {
            window.BiketaBaiNotifications.initialized = false;
            window.BiketaBaiNotifications.handlersRegistered = false;
            if (window.BiketaBaiNotifications.connection) {
                window.BiketaBaiNotifications.connection.stop().then(() => {
                    window.BiketaBaiNotifications.connection = null;
                    if (typeof initializeSignalR === 'function') {
                        initializeSignalR();
                    } else {
                        alert('initializeSignalR function not found. Please refresh the page.');
                    }
                }).catch(() => {
                    window.BiketaBaiNotifications.connection = null;
                    if (typeof initializeSignalR === 'function') {
                        initializeSignalR();
                    } else {
                        alert('initializeSignalR function not found. Please refresh the page.');
                    }
                });
            } else {
                if (typeof initializeSignalR === 'function') {
                    initializeSignalR();
                } else {
                    alert('initializeSignalR function not found. Please refresh the page.');
                }
            }
        } else {
            alert('BiketaBaiNotifications global object not found. Please refresh the page.');
        }
        
        // Check status after a delay
        setTimeout(checkConnectionStatus, 2000);
    }

    // Open console guide
    function openConsole() {
        const guide = `
=== Console Testing Commands ===

1. Check connection:
   window.BiketaBaiNotifications?.connection?.state

2. Test sound:
   playNotificationSound()

3. Test badge:
   updateNotificationBadge(5)

4. Load notification count:
   loadNotificationCount()

5. Check badge element:
   $('#notificationCountHeader').length

6. Manually show badge:
   $('#notificationCountHeader').text('5').css('display', 'flex')

7. Check authentication:
   isAuthenticated

8. Check SignalR:
   typeof signalR

9. Check global connection:
   window.BiketaBaiNotifications

10. Listen for notifications:
    window.BiketaBaiNotifications?.connection?.on("ReceiveNotification", console.log)
        `;
        console.log(guide);
        alert('Debug commands have been printed to the console. Open Developer Tools (F12) to see them.');
    }

    // Monitor for notifications
    if (window.BiketaBaiNotifications?.connection) {
        window.BiketaBaiNotifications.connection.on("ReceiveNotification", function(notification) {
            document.getElementById('lastNotification').textContent = 
                `Received: ${notification.title || 'Notification'} at ${new Date().toLocaleTimeString()}`;
            checkConnectionStatus();
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkConnectionStatus();
        runDebugCheck();
        
        // Auto-refresh status every 5 seconds
        setInterval(checkConnectionStatus, 5000);
    });
</script>

