@using BiketaBai.Helpers
@using System.Security.Claims
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="theme-color" content="#28a745" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>@ViewData["Title"] - Bike Ta Bai</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/mobile-first.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/premium-minimal.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/unified-design-system.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/global-overrides.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/loading-animation.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/bike-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/booking-module.css" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <!-- Loading Animation -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="bike-loader">
            <!-- Bike Frame -->
            <div class="bike-frame">
                <div class="seat-tube"></div>
                <div class="handlebars"></div>
                <div class="seat"></div>
                <div class="pedal"></div>
            </div>
            
            <!-- Front Wheel -->
            <div class="front-wheel">
                <div class="wheel-hub"></div>
            </div>
            
            <!-- Back Wheel -->
            <div class="back-wheel">
                <div class="wheel-hub"></div>
            </div>
        </div>
        
        <div class="loading-text">
            Loading<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
        
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>
    <!-- Premium Minimalist Header -->
    <header class="header-minimal">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container">
                <!-- Brand -->
                <a class="navbar-brand brand-minimal" href="/">
                    <i class="bi bi-bicycle"></i>
                    <span>Bike Ta Bai</span>
                </a>
                
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <!-- Mobile: User Name Button (replaces burger) - Hidden, use bottom nav Profile button instead -->
                    <button class="btn btn-minimal-account d-none" type="button" id="openSidebarBtnMobile" style="display: none;">
                        <i class="bi bi-person-circle"></i>
                        <span class="ms-1">@User.Identity.Name</span>
                    </button>
                }
                else
                {
                    <!-- Mobile Toggle (for non-authenticated users) -->
                    <button class="navbar-toggler border-0 d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                }
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Center Navigation -->
                    <ul class="navbar-nav mx-auto align-items-lg-center">
                        <li class="nav-item hide-on-mobile-nav">
                            <a class="nav-link-minimal" href="/">Home</a>
                        </li>
                        <li class="nav-item hide-on-mobile-nav">
                            <a class="nav-link-minimal" href="/Bikes/Browse">Browse</a>
                        </li>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            @if (AuthHelper.IsRenter(User))
                            {
                                <li class="nav-item hide-on-mobile-nav">
                                    <a class="nav-link-minimal" href="/Renter/RentalHistory">Rentals</a>
                                </li>
                            }
                            @if (AuthHelper.IsOwner(User))
                            {
                                <li class="nav-item hide-on-mobile-nav">
                                    <a class="nav-link-minimal" href="/Dashboard/Owner">Dashboard</a>
                                </li>
                                <li class="nav-item hide-on-mobile-nav">
                                    <a class="nav-link-minimal" href="/Owner/MyBikes">My Bikes</a>
                                </li>
                            }
                            @if (AuthHelper.IsAdmin(User))
                            {
                                <li class="nav-item hide-on-mobile-nav">
                                    <a class="nav-link-minimal" href="/Admin/Dashboard">Admin</a>
                                </li>
                            }
                        }
                    </ul>
                    
                    <!-- Right Side -->
                    <ul class="navbar-nav align-items-lg-center">
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <!-- Desktop: User Name Button - Opens Sidebar -->
                            <li class="nav-item d-none d-lg-block">
                                <button class="btn btn-minimal-account d-none d-lg-block" type="button" id="openSidebarBtn" style="position: relative;">
                                    <i class="bi bi-person-circle"></i>
                                    <span class="ms-1">@User.Identity.Name</span>
                                    <span class="notification-badge-header" id="notificationCountHeader" style="display: none;"></span>
                                </button>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="btn btn-minimal-ghost me-2" href="/Account/Login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="btn btn-minimal-primary" href="/Account/Register">Register</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Account Sidebar Navigation -->
    @if (User.Identity?.IsAuthenticated == true)
    {
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <aside class="account-sidebar" id="accountSidebar">
            <div class="sidebar-header">
                <div class="sidebar-user-info">
                    <div class="sidebar-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <div class="sidebar-user-details">
                        <h3 class="sidebar-user-name">@User.Identity.Name</h3>
                        <p class="sidebar-user-role">
                            @if (AuthHelper.IsAdmin(User))
                            {
                                <span class="role-badge-sidebar admin">Admin</span>
                            }
                            @if (AuthHelper.IsOwner(User))
                            {
                                <span class="role-badge-sidebar owner">Owner</span>
                            }
                            @if (AuthHelper.IsRenter(User))
                            {
                                <span class="role-badge-sidebar renter">Renter</span>
                            }
                        </p>
                    </div>
                </div>
                <button class="sidebar-close-btn" id="closeSidebarBtn" aria-label="Close sidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <h4 class="sidebar-section-title">Account</h4>
                    <a href="/Account/Profile" class="sidebar-link">
                        <i class="bi bi-person"></i>
                        <span>My Profile</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <h4 class="sidebar-section-title">Balance</h4>
                    <a href="/Wallet/Index" class="sidebar-link">
                        <i class="bi bi-wallet2"></i>
                        <span>Wallet</span>
                        <span class="sidebar-badge sage" id="walletBalanceSidebar">â‚±0</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <h4 class="sidebar-section-title">Activity</h4>
                    <a href="/Notifications/Index" class="sidebar-link">
                        <i class="bi bi-bell"></i>
                        <span>Notifications</span>
                        <span class="sidebar-badge danger" id="notificationCountSidebar" style="display: none;">0</span>
                    </a>
                    @if (AuthHelper.IsRenter(User))
                    {
                        <a href="/Renter/RentalHistory" class="sidebar-link">
                            <i class="bi bi-clock-history"></i>
                            <span>Rental History</span>
                        </a>
                    }
                    @if (AuthHelper.IsOwner(User))
                    {
                        <a href="/Dashboard/Owner" class="sidebar-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Owner Dashboard</span>
                        </a>
                        <a href="/Owner/MyBikes" class="sidebar-link">
                            <i class="bi bi-bicycle"></i>
                            <span>My Bikes</span>
                        </a>
                        <a href="/Owner/RentalRequests" class="sidebar-link">
                            <i class="bi bi-inbox-fill"></i>
                            <span>Rental Requests</span>
                        </a>
                    }
                    @if (AuthHelper.IsAdmin(User))
                    {
                        <a href="/Admin/Dashboard" class="sidebar-link">
                            <i class="bi bi-speedometer2"></i>
                            <span>Admin Dashboard</span>
                        </a>
                        <a href="/Admin/VerifyOwners" class="sidebar-link">
                            <i class="bi bi-shield-check"></i>
                            <span>Verify Owners</span>
                        </a>
                        <a href="/Admin/ManageUsers" class="sidebar-link">
                            <i class="bi bi-people-fill"></i>
                            <span>Manage Users</span>
                        </a>
                        <a href="/Admin/Reviews" class="sidebar-link">
                            <i class="bi bi-star-fill"></i>
                            <span>Reviews</span>
                        </a>
                        <a href="/Admin/Reports" class="sidebar-link">
                            <i class="bi bi-flag-fill"></i>
                            <span>Reports</span>
                        </a>
                    }
                </div>

                <div class="sidebar-section sidebar-section-logout">
                    <a href="/Account/Logout" class="sidebar-link sidebar-link-logout">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </nav>
        </aside>
    }

    <main role="main">
        @RenderBody()
    </main>

    <!-- Premium Minimalist Footer -->
    <footer class="footer-minimal">
        <div class="container">
            <div class="row align-items-center py-4">
                <!-- Brand & Copyright -->
                <div class="col-lg-4 col-md-6 mb-3 mb-lg-0 text-center text-md-start">
                    <div class="footer-brand-minimal mb-2">
                        <i class="bi bi-bicycle"></i>
                        <span>Bike Ta Bai</span>
                    </div>
                    <p class="footer-text-minimal mb-0">&copy; 2025 All rights reserved.</p>
                </div>
                
                <!-- Quick Links -->
                <div class="col-lg-4 col-md-6 mb-3 mb-lg-0 text-center">
                    <div class="footer-links-minimal">
                        <a href="/">Home</a>
                        <a href="/Bikes/Browse">Browse</a>
                        <a href="/About">About</a>
                        <a href="/Contact">Contact</a>
                    </div>
                </div>
                
                <!-- Social & Tagline -->
                <div class="col-lg-4 col-12 text-center text-lg-end">
                    <div class="social-links-minimal mb-2">
                        <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                        <a href="#" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
                    </div>
                    <p class="footer-tagline-minimal mb-0">Ride Green, Live Clean ðŸŒ¿</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- SignalR must load before notification scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js" 
            onload="console.log('âœ… SignalR library loaded successfully')"
            onerror="console.error('âŒ Failed to load SignalR library')"></script>
    
    <!-- Loading Animation Script -->
    <script>
        // Hide loading animation when page is fully loaded
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    // Add fade-in to main content
                    document.querySelector('main').classList.add('fade-in');
                }
            }, 800); // Show loading for at least 800ms for smooth transition
        });
        
        // Show loading on page navigation (optional)
        document.addEventListener('DOMContentLoaded', function() {
            const links = document.querySelectorAll('a[href^="/"]');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href && href !== '#' && !href.startsWith('#')) {
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        if (loadingOverlay) {
                            loadingOverlay.classList.remove('hidden');
                        }
                    }
                });
            });
        });
    </script>
    
    @if (User.Identity?.IsAuthenticated == true)
    {
        <script>
            // Use global scope to persist connection across page navigations
            // This ensures SignalR stays connected when navigating between pages
            if (typeof window.BiketaBaiNotifications === 'undefined') {
                window.BiketaBaiNotifications = {
                    connection: null,
                    handlersRegistered: false,
                    previousNotificationCount: 0,
                    healthMonitorInterval: null,
                    initialized: false
                };
            }
            
            let previousNotificationCount = window.BiketaBaiNotifications.previousNotificationCount || 0;
            const isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
            
            // SignalR Connection for Real-time Notifications (use global scope)
            let notificationHubConnection = window.BiketaBaiNotifications.connection;
            
            // Track if handlers are registered to avoid duplicates
            let notificationHandlersRegistered = window.BiketaBaiNotifications.handlersRegistered || false;
            
            // Initialize SignalR connection
            function initializeSignalR() {
                console.log('ðŸ”§ Initializing SignalR connection...');
                
                // Check if SignalR library is loaded
                if (typeof signalR === 'undefined') {
                    console.error('âŒ SignalR library not loaded, retrying in 2 seconds...');
                    setTimeout(initializeSignalR, 2000);
                    // Fallback to polling while retrying
                    if (!window.BiketaBaiNotifications.pollingInterval) {
                        window.BiketaBaiNotifications.pollingInterval = setInterval(function() {
                            loadNotificationCount();
                        }, 15000);
                    }
                    return;
                }
                
                console.log('âœ… SignalR library loaded');
                
                // Get connection from global scope (might be null on first load)
                notificationHubConnection = window.BiketaBaiNotifications.connection || notificationHubConnection;
                
                // If connection exists and is connected, just ensure handlers are registered
                if (notificationHubConnection && notificationHubConnection.state === signalR.HubConnectionState.Connected) {
                    console.log('âœ… SignalR connection already active, ensuring handlers are registered');
                    // Ensure handlers are registered (they should be, but double-check)
                    if (!notificationHandlersRegistered && !window.BiketaBaiNotifications.handlersRegistered) {
                        registerNotificationHandlers();
                    }
                    window.BiketaBaiNotifications.initialized = true;
                    return;
                }
                
                // If connection exists but is disconnected, try to reconnect
                if (notificationHubConnection && notificationHubConnection.state === signalR.HubConnectionState.Disconnected) {
                    console.log('ðŸ”„ SignalR connection exists but disconnected, attempting to reconnect...');
                    notificationHubConnection.start()
                        .then(() => {
                            console.log('âœ… SignalR reconnected successfully');
                            if (!notificationHandlersRegistered && !window.BiketaBaiNotifications.handlersRegistered) {
                                registerNotificationHandlers();
                            }
                            window.BiketaBaiNotifications.initialized = true;
                            loadNotificationCount();
                        })
                        .catch((err) => {
                            console.error('âŒ Failed to reconnect, creating new connection:', err);
                            notificationHubConnection = null;
                            window.BiketaBaiNotifications.connection = null;
                            createNewConnection();
                        });
                    return;
                }
                
                // If connection exists but is connecting/reconnecting, wait a bit
                if (notificationHubConnection && 
                    (notificationHubConnection.state === signalR.HubConnectionState.Connecting ||
                     notificationHubConnection.state === signalR.HubConnectionState.Reconnecting)) {
                    console.log('â³ SignalR connection is connecting/reconnecting, waiting...');
                    setTimeout(() => {
                        initializeSignalR();
                    }, 2000);
                    return;
                }
                
                // If connection exists but is in another state, close it first
                if (notificationHubConnection && notificationHubConnection.state !== signalR.HubConnectionState.Disconnected) {
                    console.log('ðŸ”„ Closing existing connection to recreate...');
                    notificationHubConnection.stop().then(() => {
                        notificationHubConnection = null;
                        window.BiketaBaiNotifications.connection = null;
                        notificationHandlersRegistered = false;
                        window.BiketaBaiNotifications.handlersRegistered = false;
                        window.BiketaBaiNotifications.initialized = false;
                        createNewConnection();
                    }).catch(() => {
                        notificationHubConnection = null;
                        window.BiketaBaiNotifications.connection = null;
                        notificationHandlersRegistered = false;
                        window.BiketaBaiNotifications.handlersRegistered = false;
                        window.BiketaBaiNotifications.initialized = false;
                        createNewConnection();
                    });
                    return;
                }
                
                // No connection exists, create a new one
                console.log('ðŸ†• No connection found, creating new connection...');
                createNewConnection();
            }
            
            function createNewConnection() {
                // Create new connection
                console.log('ðŸ”¨ Creating new SignalR connection for notifications...');
                
                try {
                    notificationHubConnection = new signalR.HubConnectionBuilder()
                        .withUrl("/notificationHub")
                        .withAutomaticReconnect({
                            nextRetryDelayInMilliseconds: retryContext => {
                                // Exponential backoff: 0s, 2s, 10s, 30s, then 30s
                                if (retryContext.elapsedMilliseconds < 2000) return 0;
                                if (retryContext.elapsedMilliseconds < 10000) return 2000;
                                if (retryContext.elapsedMilliseconds < 30000) return 10000;
                                return 30000;
                            }
                        })
                        .build();
                    
                    console.log('âœ… SignalR connection object created');
                    
                    // Store connection in global scope for persistence across page navigations
                    window.BiketaBaiNotifications.connection = notificationHubConnection;
                    console.log('âœ… Connection stored in global scope');
                    
                    // Register notification handlers BEFORE starting connection
                    registerNotificationHandlers();
                    
                    // Start the connection
                    console.log('ðŸš€ Starting SignalR connection...');
                    notificationHubConnection.start()
                        .then(() => {
                            console.log("âœ… SignalR connected successfully for notifications");
                            console.log("Connection ID:", notificationHubConnection.connectionId);
                            window.BiketaBaiNotifications.initialized = true;
                            // Load initial notification count
                            loadNotificationCount();
                            
                            // Set up connection health monitoring (only once)
                            if (!window.BiketaBaiNotifications.healthMonitorInterval) {
                                monitorConnectionHealth();
                            }
                        })
                        .catch((err) => {
                            console.error("âŒ SignalR connection error:", err);
                            console.error("Error details:", {
                                message: err.message,
                                stack: err.stack,
                                name: err.name
                            });
                            notificationHandlersRegistered = false;
                            window.BiketaBaiNotifications.handlersRegistered = false;
                            window.BiketaBaiNotifications.initialized = false;
                            // Retry connection after a delay
                            setTimeout(() => {
                                console.log("ðŸ”„ Retrying SignalR connection...");
                                initializeSignalR();
                            }, 5000);
                        });
                } catch (error) {
                    console.error("âŒ Error creating SignalR connection:", error);
                    setTimeout(() => {
                        console.log("ðŸ”„ Retrying after error...");
                        initializeSignalR();
                    }, 3000);
                }
            }
            
            // Monitor connection health and reconnect if needed
            function monitorConnectionHealth() {
                // Clear existing interval if any
                if (window.BiketaBaiNotifications.healthMonitorInterval) {
                    clearInterval(window.BiketaBaiNotifications.healthMonitorInterval);
                }
                
                window.BiketaBaiNotifications.healthMonitorInterval = setInterval(() => {
                    // Get connection from global scope
                    const conn = window.BiketaBaiNotifications.connection || notificationHubConnection;
                    
                    if (conn) {
                        const state = conn.state;
                        if (state === signalR.HubConnectionState.Disconnected) {
                            console.warn("âš ï¸ SignalR connection is disconnected, attempting to reconnect...");
                            window.BiketaBaiNotifications.handlersRegistered = false;
                            notificationHandlersRegistered = false;
                            window.BiketaBaiNotifications.initialized = false;
                            initializeSignalR();
                        } else if (state === signalR.HubConnectionState.Connected) {
                            // Connection is healthy
                            if (!window.BiketaBaiNotifications.handlersRegistered) {
                                console.warn("âš ï¸ Handlers not registered but connection is active, re-registering...");
                                registerNotificationHandlers();
                            }
                        }
                    } else {
                        console.warn("âš ï¸ No SignalR connection found, initializing...");
                        window.BiketaBaiNotifications.initialized = false;
                        initializeSignalR();
                    }
                }, 30000); // Check every 30 seconds
            }
            
            // Notification queue system - shows one notification at a time
            if (typeof window.BiketaBaiNotifications === 'undefined') {
                window.BiketaBaiNotifications = {};
            }
            
            window.BiketaBaiNotifications.notificationQueue = window.BiketaBaiNotifications.notificationQueue || [];
            window.BiketaBaiNotifications.isShowingNotification = window.BiketaBaiNotifications.isShowingNotification || false;
            window.BiketaBaiNotifications.processedNotificationIds = window.BiketaBaiNotifications.processedNotificationIds || new Set();

            // Add notification to queue
            function queueNotification(notification) {
                // Skip if we've already processed this notification
                if (notification.notificationId && window.BiketaBaiNotifications.processedNotificationIds.has(notification.notificationId)) {
                    console.log("â­ï¸ Skipping already processed notification:", notification.notificationId);
                    return;
                }

                // Mark as processed
                if (notification.notificationId) {
                    window.BiketaBaiNotifications.processedNotificationIds.add(notification.notificationId);
                }

                // Add to queue
                window.BiketaBaiNotifications.notificationQueue.push(notification);
                console.log("ðŸ“¥ Notification queued. Queue length:", window.BiketaBaiNotifications.notificationQueue.length);

                // Process queue if not currently showing
                if (!window.BiketaBaiNotifications.isShowingNotification) {
                    processNotificationQueue();
                }
            }

            // Process notification queue - shows one at a time
            function processNotificationQueue() {
                if (window.BiketaBaiNotifications.isShowingNotification) {
                    console.log("â¸ï¸ Already showing notification, waiting...");
                    return;
                }

                if (window.BiketaBaiNotifications.notificationQueue.length === 0) {
                    console.log("âœ… Notification queue is empty");
                    window.BiketaBaiNotifications.isShowingNotification = false;
                    
                    // Check for more unread notifications from server
                    checkForMoreNotifications();
                    return;
                }

                // Get next notification from queue
                const notification = window.BiketaBaiNotifications.notificationQueue.shift();
                window.BiketaBaiNotifications.isShowingNotification = true;
                
                console.log("ðŸ“¤ Showing notification from queue:", notification.title);
                showMiniNotification(notification, function() {
                    // Callback when notification is dismissed
                    window.BiketaBaiNotifications.isShowingNotification = false;
                    console.log("âœ… Notification dismissed, processing next in queue...");
                    
                    // Process next notification after a short delay
                    setTimeout(() => {
                        processNotificationQueue();
                    }, 500);
                });
            }

            // Check for more unread notifications from server
            function checkForMoreNotifications() {
                fetch('/Api/UnreadNotifications')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.notifications && data.notifications.length > 0) {
                            console.log(`ðŸ“¬ Found ${data.notifications.length} unread notifications from server`);
                            
                            // Add unread notifications to queue (filter out already processed)
                            let addedCount = 0;
                            data.notifications.forEach(notif => {
                                if (!window.BiketaBaiNotifications.processedNotificationIds.has(notif.notificationId)) {
                                    queueNotification({
                                        notificationId: notif.notificationId,
                                        title: notif.title,
                                        message: notif.message,
                                        type: notif.notificationType,
                                        actionUrl: notif.actionUrl
                                    });
                                    addedCount++;
                                }
                            });
                            
                            if (addedCount > 0) {
                                console.log(`âœ… Added ${addedCount} new notifications to queue`);
                            }
                            
                            // Process queue if we added new notifications
                            if (!window.BiketaBaiNotifications.isShowingNotification && window.BiketaBaiNotifications.notificationQueue.length > 0) {
                                processNotificationQueue();
                            }
                        } else {
                            console.log("âœ… No more unread notifications");
                        }
                    })
                    .catch(err => {
                        console.error("Error checking for unread notifications:", err);
                    });
            }

            // Show mini notification popup at the top of the page
            function showMiniNotification(notification, onDismiss) {
                console.log("ðŸ“¢ showMiniNotification called with:", notification);
                
                // Create notification container if it doesn't exist
                let container = document.getElementById('miniNotificationContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'miniNotificationContainer';
                    container.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 500px; width: 90%; pointer-events: none;';
                    document.body.appendChild(container);
                    console.log("âœ… Created mini notification container");
                }

                // Clear any existing notifications (only show one at a time)
                container.innerHTML = '';

                // Create notification element
                const notificationEl = document.createElement('div');
                notificationEl.className = 'mini-notification';
                notificationEl.style.cssText = `
                    background: white;
                    border-left: 4px solid #3B82F6;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    padding: 1rem 1.25rem;
                    display: flex;
                    align-items: flex-start;
                    gap: 0.75rem;
                    animation: slideDown 0.3s ease-out;
                    pointer-events: auto;
                    cursor: pointer;
                `;

                // Determine icon and color based on notification type
                let icon = 'bi-bell';
                let color = '#3B82F6';
                if (notification.type === 'Booking' || notification.type === 'Payment') {
                    icon = 'bi-cash-coin';
                    color = '#10B981';
                } else if (notification.type === 'Alert') {
                    icon = 'bi-exclamation-triangle';
                    color = '#EF4444';
                }

                const title = notification.title || 'New Notification';
                const message = notification.message || '';
                
                notificationEl.innerHTML = `
                    <i class="bi ${icon}" style="font-size: 1.5rem; color: ${color}; flex-shrink: 0;"></i>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 0.9375rem; color: #1F2937; margin-bottom: 0.25rem;">
                            ${escapeHtml(title)}
                        </div>
                        <div style="font-size: 0.875rem; color: #6B7280; line-height: 1.4;">
                            ${escapeHtml(message)}
                        </div>
                    </div>
                    <button type="button" class="mini-notification-close" style="background: none; border: none; color: #9CA3AF; font-size: 1.25rem; cursor: pointer; padding: 0; line-height: 1; flex-shrink: 0;">Ã—</button>
                `;

                // Function to dismiss notification
                const dismissNotification = function() {
                    notificationEl.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => {
                        if (notificationEl.parentNode) {
                            notificationEl.remove();
                        }
                        if (onDismiss) {
                            onDismiss();
                        }
                    }, 300);
                };

                // Add click handler to navigate to action URL
                if (notification.actionUrl) {
                    notificationEl.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('mini-notification-close') && !e.target.closest('.mini-notification-close')) {
                            // Mark notification as read if it has an ID
                            if (notification.notificationId) {
                                fetch('/Notifications?handler=MarkAsRead', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: `notificationId=${notification.notificationId}`
                                }).catch(err => console.error('Error marking notification as read:', err));
                            }
                            window.location.href = notification.actionUrl;
                        }
                    });
                }

                // Add close button handler
                const closeBtn = notificationEl.querySelector('.mini-notification-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dismissNotification();
                    });
                }

                // Add to container
                container.appendChild(notificationEl);
                console.log("âœ… Mini notification popup added to DOM");

                // Auto-dismiss after 8 seconds
                const autoDismissTimeout = setTimeout(() => {
                    dismissNotification();
                }, 8000);

                // Clear timeout if user interacts
                notificationEl.addEventListener('mouseenter', () => {
                    clearTimeout(autoDismissTimeout);
                });
            }

            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Add CSS for animations (only once)
            if (!document.getElementById('miniNotificationStyles')) {
                const notificationStyle = document.createElement('style');
                notificationStyle.id = 'miniNotificationStyles';
                notificationStyle.textContent = `
                    @@keyframes slideDown {
                        from {
                            transform: translateY(-100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    @@keyframes slideUp {
                        from {
                            transform: translateY(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateY(-100%);
                            opacity: 0;
                        }
                    }
                    .mini-notification:hover {
                        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
                    }
                    .mini-notification-close:hover {
                        color: #374151 !important;
                    }
                `;
                document.head.appendChild(notificationStyle);
            }

            // Register notification handlers (separate function to avoid duplication)
            function registerNotificationHandlers() {
                // Get connection from global scope if local variable is null
                if (!notificationHubConnection) {
                    notificationHubConnection = window.BiketaBaiNotifications.connection;
                }
                
                if (!notificationHubConnection) {
                    console.warn("âŒ Cannot register handlers: no connection available");
                    console.warn("Attempting to create connection...");
                    createNewConnection();
                    return;
                }
                
                console.log('ðŸ“ Registering notification handlers...');
                
                // Remove existing handlers first to prevent duplicates
                try {
                    notificationHubConnection.off("ReceiveNotification");
                    notificationHubConnection.off("ReceiveBookingUpdate");
                } catch (e) {
                    // Ignore errors when removing handlers
                }
                
                // Listen for new notifications
                notificationHubConnection.on("ReceiveNotification", function (notification) {
                    console.log("ðŸ”” New notification received:", notification);
                    
                    if (!notification) {
                        console.error("Invalid notification data received");
                        return;
                    }
                    
                    // Update notification count
                    const currentCount = notification.unreadCount || 0;
                    console.log("Updating badge to:", currentCount);
                    updateNotificationBadge(currentCount);
                    
                    // Play sound immediately when notification is received
                    playNotificationSound();
                    
                    // Add to queue (will show one at a time)
                    try {
                        queueNotification(notification);
                    } catch (e) {
                        console.error("Error queueing notification:", e);
                    }
                    
                    // Show browser notification if permission granted
                    if (Notification.permission === "granted") {
                        try {
                            new Notification(notification.title || "New Notification", {
                                body: notification.message || "You have a new notification",
                                icon: '/favicon.ico',
                                badge: '/favicon.ico',
                                tag: 'biketabai-notification-' + Date.now()
                            });
                        } catch (e) {
                            console.error("Error showing browser notification:", e);
                        }
                    }
                });
                
                // Listen for booking updates
                notificationHubConnection.on("ReceiveBookingUpdate", function (update) {
                    console.log("ðŸ“‹ Booking update received:", update);
                    
                    if (!update) {
                        console.error("Invalid booking update data received");
                        return;
                    }
                    
                    // Reload notification count to get latest
                    loadNotificationCount();
                    
                    // Play sound for booking updates
                    playNotificationSound();
                    
                    // Show browser notification if permission granted
                    if (Notification.permission === "granted" && update.message) {
                        try {
                            new Notification("Booking Update", {
                                body: update.message,
                                icon: '/favicon.ico',
                                badge: '/favicon.ico',
                                tag: 'biketabai-booking-update-' + Date.now()
                            });
                        } catch (e) {
                            console.error("Error showing browser notification:", e);
                        }
                    }
                });
                
                // Handle connection events
                notificationHubConnection.onreconnecting((error) => {
                    console.log("ðŸ”„ SignalR reconnecting...", error);
                });
                
                notificationHubConnection.onreconnected((connectionId) => {
                    console.log("âœ… SignalR reconnected with connection ID:", connectionId);
                    // Reload notification count when reconnected
                    loadNotificationCount();
                    // Re-register handlers if needed
                    if (!notificationHandlersRegistered) {
                        registerNotificationHandlers();
                    }
                });
                
                notificationHubConnection.onclose((error) => {
                    console.log("âŒ SignalR connection closed", error);
                    notificationHandlersRegistered = false; // Reset flag on close
                    // Try to reconnect after a delay if connection was closed unexpectedly
                    setTimeout(() => {
                        console.log("Attempting to reconnect SignalR...");
                        initializeSignalR();
                    }, 3000);
                });
                
                notificationHandlersRegistered = true;
                window.BiketaBaiNotifications.handlersRegistered = true;
                console.log("âœ… Notification handlers registered successfully");
            }
            
            // Check for unread notifications on page load and show them one by one
            function initializeNotificationQueue() {
                console.log("ðŸ” Checking for unread notifications on page load...");
                checkForMoreNotifications();
                
                // Also check periodically (every 30 seconds) for new notifications
                setInterval(() => {
                    if (!window.BiketaBaiNotifications.isShowingNotification && window.BiketaBaiNotifications.notificationQueue.length === 0) {
                        checkForMoreNotifications();
                    }
                }, 30000);
            }

            // Initialize SignalR immediately when script loads (don't wait for document ready)
            // This ensures SignalR is always listening on all pages for all roles
            if (isAuthenticated === "true") {
                console.log('ðŸ”” Notification system: User is authenticated, initializing SignalR...');
                
                // Function to initialize after SignalR is loaded
                function doInitialize() {
                    console.log('âœ… SignalR library ready, initializing connection...');
                    // Try to initialize immediately
                    if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        initializeSignalR();
                        loadWalletBalance();
                        setupPageVisibilityHandlers();
                        // Initialize notification queue after DOM is ready
                        setTimeout(initializeNotificationQueue, 1000);
                    });
                } else {
                    // DOM already loaded
                    initializeSignalR();
                    loadWalletBalance();
                    setupPageVisibilityHandlers();
                    // Initialize notification queue
                    setTimeout(initializeNotificationQueue, 1000);
                }
                }
                
                // Wait for SignalR library to load, then initialize
                function waitForSignalRAndInit() {
                    if (typeof signalR !== 'undefined' && typeof signalR.HubConnectionBuilder !== 'undefined') {
                        doInitialize();
                    } else {
                        console.log('â³ Waiting for SignalR library to load... (attempt ' + (waitForSignalRAndInit.attempts || 0) + ')');
                        waitForSignalRAndInit.attempts = (waitForSignalRAndInit.attempts || 0) + 1;
                        
                        // Give up after 50 attempts (5 seconds)
                        if (waitForSignalRAndInit.attempts < 50) {
                            setTimeout(waitForSignalRAndInit, 100);
                        } else {
                            console.error('âŒ SignalR library failed to load after 5 seconds. Using fallback polling.');
                            // Fallback to polling
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', function() {
                                    loadNotificationCount();
                                    setInterval(function() {
                                        loadNotificationCount();
                                    }, 15000);
                                });
                            } else {
                                loadNotificationCount();
                                setInterval(function() {
                                    loadNotificationCount();
                                }, 15000);
                            }
                        }
                    }
                }
                
                // Start waiting for SignalR (with a small delay to ensure script tag has executed)
                setTimeout(waitForSignalRAndInit, 100);
            } else {
                // Fallback to polling if not authenticated
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        loadNotificationCount();
                        setInterval(function() {
                            loadNotificationCount();
                        }, 15000);
                        // Initialize notification queue even if not authenticated (for testing)
                        setTimeout(initializeNotificationQueue, 2000);
                    });
                } else {
                    loadNotificationCount();
                    setInterval(function() {
                        loadNotificationCount();
                    }, 15000);
                    // Initialize notification queue even if not authenticated (for testing)
                    setTimeout(initializeNotificationQueue, 2000);
                }
            }
            
            // Handle page visibility changes (tab switching, minimizing window, etc.)
            function setupPageVisibilityHandlers() {
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        // Page became visible, ensure connection is active
                        console.log('Page became visible, checking SignalR connection...');
                        const conn = window.BiketaBaiNotifications.connection || notificationHubConnection;
                        if (!conn || conn.state === signalR.HubConnectionState.Disconnected) {
                            console.log('Reconnecting SignalR after page became visible...');
                            initializeSignalR();
                        } else if (conn.state === signalR.HubConnectionState.Connected) {
                            // Connection is active, just refresh notification count
                            loadNotificationCount();
                        }
                    }
                });
                
                // Handle page unload - don't close connection, let it persist
                window.addEventListener('beforeunload', function() {
                    // Don't close connection on navigation - let it persist
                    // The connection will be reused on the next page
                    console.log('Page unloading, keeping SignalR connection alive...');
                });
            }
            
            // Load wallet balance and set up refresh
            $(document).ready(function() {
                // Refresh wallet every 30 seconds
                setInterval(function() {
                    loadWalletBalance();
                }, 30000);
            });

            function loadWalletBalance() {
                $.get('/Api/Wallet', function(data) {
                    const balance = 'â‚±' + Math.floor(data.balance);
                    $('#walletBalanceSidebar').text(balance);
                }).fail(function() {
                    $('#walletBalanceSidebar').text('â‚±0');
                });
            }


            // Update notification badge UI
            function updateNotificationBadge(count) {
                console.log('ðŸ”” updateNotificationBadge called with count:', count);
                const countText = count > 9 ? '9+' : String(count);
                
                if (count > 0) {
                    // Update sidebar badge
                    const $sidebarBadge = $('#notificationCountSidebar');
                    if ($sidebarBadge.length > 0) {
                        $sidebarBadge.text(countText).show();
                        console.log('âœ… Sidebar badge updated:', countText);
                    } else {
                        console.warn('âš ï¸ Sidebar badge element not found');
                    }
                    
                    // Update header badge for all authenticated users
                    const $headerBadge = $('#notificationCountHeader');
                    if ($headerBadge.length > 0) {
                        console.log('âœ… Header badge element found, updating...');
                        $headerBadge.text(countText);
                        
                        // Toggle class based on whether it's a single digit or multiple
                        if (count > 9 || countText.length > 1) {
                            $headerBadge.addClass('badge-multiple');
                        } else {
                            $headerBadge.removeClass('badge-multiple');
                        }
                        
                        // Show the badge - use multiple methods to ensure it displays
                        // Use !important to override any CSS rules
                        $headerBadge[0].style.setProperty('display', 'flex', 'important');
                        $headerBadge[0].style.setProperty('visibility', 'visible', 'important');
                        $headerBadge[0].style.setProperty('opacity', '1', 'important');
                        $headerBadge.show();
                        
                        // Double-check it's visible
                        const computedDisplay = window.getComputedStyle($headerBadge[0]).display;
                        console.log('âœ… Header badge updated:', countText, 'Display:', computedDisplay);
                        
                        if (computedDisplay === 'none') {
                            console.error('âŒ Badge display is still none after update! Trying alternative method...');
                            // Try removing and re-adding the element
                            const badgeHtml = $headerBadge[0].outerHTML;
                            $headerBadge.remove();
                            $('#openSidebarBtn').append(badgeHtml);
                            const $newBadge = $('#notificationCountHeader');
                            $newBadge.text(countText);
                            $newBadge[0].style.setProperty('display', 'flex', 'important');
                        }
                    } else {
                        console.error('âŒ Header badge element (#notificationCountHeader) not found!');
                        console.error('Available elements:', {
                            openSidebarBtn: $('#openSidebarBtn').length,
                            sidebarBadge: $('#notificationCountSidebar').length,
                            allSpans: $('span[id*="notification"]').map(function() { return this.id; }).get()
                        });
                    }
                    
                    // Play sound notification when new notification arrives
                    const shouldPlaySound = count > previousNotificationCount && previousNotificationCount >= 0;
                    if (shouldPlaySound) {
                        console.log('ðŸ”Š Playing notification sound (count increased from', previousNotificationCount, 'to', count, ')');
                        playNotificationSound();
                    }
                } else {
                    $('#notificationCountSidebar').hide();
                    const $headerBadge = $('#notificationCountHeader');
                    if ($headerBadge.length > 0) {
                        $headerBadge.hide().removeClass('badge-multiple');
                        console.log('âœ… Header badge hidden (count is 0)');
                    }
                }
                
                previousNotificationCount = count;
                // Store in global scope for persistence
                window.BiketaBaiNotifications.previousNotificationCount = count;
            }
            
            function loadNotificationCount() {
                console.log('ðŸ“Š Loading notification count from API...');
                $.get('/Api/Notifications', function(data) {
                    const currentCount = data.count || 0;
                    console.log('ðŸ“Š Notification count received:', currentCount);
                    updateNotificationBadge(currentCount);
                }).fail(function(xhr, status, error) {
                    console.error('âŒ Failed to load notification count:', status, error);
                    $('#notificationCountSidebar').hide();
                    const $headerBadge = $('#notificationCountHeader');
                    if ($headerBadge.length > 0) {
                        $headerBadge.hide().removeClass('badge-multiple');
                    }
                });
            }
            
            // Request browser notification permission on page load
            if (isAuthenticated === "true" && "Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // ============================================
            // DEBUGGING FUNCTIONS - Available in Console
            // ============================================
            // These functions can be called from browser console for testing
            
            // Make showMiniNotification available globally for testing
            window.showMiniNotification = showMiniNotification;

            // Test notification system (badge + sound)
            window.testNotification = function() {
                console.log("ðŸ§ª Testing notification system...");
                console.log("1. Checking authentication:", isAuthenticated);
                
                const $headerBadge = $('#notificationCountHeader');
                const badgeExists = $headerBadge.length > 0;
                console.log("2. Checking badge element:", badgeExists ? "âœ… Found" : "âŒ Not Found");
                
                if (badgeExists) {
                    console.log("   Badge element details:", {
                        id: $headerBadge.attr('id'),
                        class: $headerBadge.attr('class'),
                        currentDisplay: $headerBadge.css('display'),
                        currentText: $headerBadge.text(),
                        parent: $headerBadge.parent().attr('id'),
                        parentButton: $headerBadge.closest('button').attr('id')
                    });
                } else {
                    console.error("âŒ Badge element not found! Searching for alternatives...");
                    console.log("   Searching for openSidebarBtn:", $('#openSidebarBtn').length);
                    console.log("   All elements with 'notification' in id:", $('[id*="notification"]').map(function() { return this.id; }).get());
                }
                
                console.log("3. Checking SignalR connection:", window.BiketaBaiNotifications?.connection ? "âœ… Exists" : "âŒ Not Found");
                
                if (window.BiketaBaiNotifications?.connection) {
                    const state = window.BiketaBaiNotifications.connection.state;
                    console.log("4. Connection state:", state);
                }
                
                // Test badge
                console.log("5. Testing badge update with count 5...");
                updateNotificationBadge(5);
                
                // Verify badge is visible after update
                setTimeout(() => {
                    const $badge = $('#notificationCountHeader');
                    if ($badge.length > 0) {
                        const display = $badge.css('display');
                        const visibility = $badge.css('visibility');
                        const opacity = $badge.css('opacity');
                        const isVisible = $badge.is(':visible');
                        const computedStyle = window.getComputedStyle($badge[0]);
                        
                        console.log("   Badge visibility check:", {
                            display: display,
                            computedDisplay: computedStyle.display,
                            visibility: visibility,
                            opacity: opacity,
                            isVisible: isVisible,
                            text: $badge.text(),
                            position: computedStyle.position,
                            zIndex: computedStyle.zIndex
                        });
                        
                        if (!isVisible || display === 'none' || computedStyle.display === 'none') {
                            console.warn("âš ï¸ Badge is not visible! Trying to force show...");
                            $badge.css({
                                'display': 'flex !important',
                                'visibility': 'visible !important',
                                'opacity': '1 !important'
                            }).show();
                            
                            // Check again
                            setTimeout(() => {
                                const newDisplay = window.getComputedStyle($badge[0]).display;
                                console.log("   After force show, display:", newDisplay);
                                if (newDisplay === 'none') {
                                    console.error("âŒ Badge still not visible! There may be a CSS conflict.");
                                }
                            }, 100);
                        } else {
                            console.log("âœ… Badge is visible!");
                        }
                    } else {
                        console.error("âŒ Badge element disappeared after update!");
                    }
                }, 500);
                
                // Test sound
                console.log("6. Testing sound...");
                playNotificationSound();
                
                // Load actual count
                console.log("7. Loading actual notification count...");
                loadNotificationCount();
                
                console.log("âœ… Test complete! Check the badge and listen for sound.");
                console.log("ðŸ’¡ If badge is not visible, check console for details above.");
            };
            
            // Get connection status
            window.getNotificationStatus = function() {
                const status = {
                    authenticated: isAuthenticated,
                    signalRLoaded: typeof signalR !== 'undefined',
                    connectionExists: !!window.BiketaBaiNotifications?.connection,
                    connectionState: window.BiketaBaiNotifications?.connection?.state || 'N/A',
                    handlersRegistered: window.BiketaBaiNotifications?.handlersRegistered || false,
                    badgeElementExists: $('#notificationCountHeader').length > 0,
                    sidebarBadgeExists: $('#notificationCountSidebar').length > 0,
                    notificationPermission: 'Notification' in window ? Notification.permission : 'Not Supported'
                };
                console.table(status);
                return status;
            };
            
            // Force reconnect
            window.reconnectNotifications = function() {
                console.log("ðŸ”„ Forcing SignalR reconnection...");
                window.BiketaBaiNotifications.initialized = false;
                window.BiketaBaiNotifications.handlersRegistered = false;
                if (window.BiketaBaiNotifications.connection) {
                    window.BiketaBaiNotifications.connection.stop().then(() => {
                        console.log("Connection stopped, reinitializing...");
                        initializeSignalR();
                    });
                } else {
                    initializeSignalR();
                }
            };
            
            // Log all notification events
            window.enableNotificationLogging = function() {
                if (window.BiketaBaiNotifications?.connection) {
                    console.log("ðŸ“ Enabling detailed notification logging...");
                    window.BiketaBaiNotifications.connection.on("ReceiveNotification", function(notification) {
                        console.log("ðŸ”” [LOGGED] ReceiveNotification:", notification);
                    });
                    window.BiketaBaiNotifications.connection.on("ReceiveBookingUpdate", function(update) {
                        console.log("ðŸ“‹ [LOGGED] ReceiveBookingUpdate:", update);
                    });
                    console.log("âœ… Notification logging enabled. Check console for all notifications.");
                } else {
                    console.error("âŒ No SignalR connection found. Cannot enable logging.");
                }
            };
            

                console.log("âœ… Notification debugging functions loaded!");
                console.log("Available functions:");
                console.log("  - testNotification() - Test badge and sound");
                console.log("  - showMiniNotification({title, message, type, actionUrl}) - Test mini popup");
                console.log("  - getNotificationStatus() - Get connection status");
                console.log("  - reconnectNotifications() - Force reconnect");
                console.log("  - enableNotificationLogging() - Log all notifications");
                console.log("  - playNotificationSound() - Test sound directly");
                console.log("  - updateNotificationBadge(count) - Test badge directly");
                console.log("  - loadNotificationCount() - Load notification count from API");
            
            // Audio context for notification sounds (created once and reused)
            let notificationAudioContext = null;
            
            function getAudioContext() {
                if (!notificationAudioContext) {
                    try {
                        notificationAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error('Could not create audio context:', e);
                        return null;
                    }
                }
                return notificationAudioContext;
            }
            
            function playNotificationSound() {
                try {
                    const audioContext = getAudioContext();
                    if (!audioContext) {
                        console.log('Audio context not available');
                        return;
                    }
                    
                    // Resume audio context if suspended (browsers require user interaction first)
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            playTone(audioContext);
                        }).catch((e) => {
                            console.log('Could not resume audio context:', e);
                        });
                    } else {
                        playTone(audioContext);
                    }
                } catch (e) {
                    console.log('Sound notification not available:', e);
                }
            }
            
            function playTone(audioContext) {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Set sound properties - pleasant notification tone
                    oscillator.frequency.value = 800; // Higher pitch
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    // Play a second tone for emphasis
                    setTimeout(() => {
                        try {
                            const oscillator2 = audioContext.createOscillator();
                            const gainNode2 = audioContext.createGain();
                            
                            oscillator2.connect(gainNode2);
                            gainNode2.connect(audioContext.destination);
                            
                            oscillator2.frequency.value = 1000;
                            oscillator2.type = 'sine';
                            
                            gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                            gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                            
                            oscillator2.start(audioContext.currentTime);
                            oscillator2.stop(audioContext.currentTime + 0.2);
                        } catch (e2) {
                            console.log('Second tone not available:', e2);
                        }
                    }, 150);
                } catch (e) {
                    console.log('Tone playback error:', e);
                }
            }
        </script>
    }
    
    <script>
        // Header scroll effect
        $(window).on('scroll', function() {
            if ($(window).scrollTop() > 50) {
                $('.header-minimal').addClass('scrolled');
            } else {
                $('.header-minimal').removeClass('scrolled');
            }
        });
        
        // Close mobile menu on link click
        $('.navbar-nav a').on('click', function() {
            $('.navbar-collapse').collapse('hide');
        });
        
        // Close mobile menu when clicking outside
        $(document).on('click', function(event) {
            const $navbar = $('.navbar-collapse');
            const $toggler = $('.navbar-toggler');
            
            if (!$navbar.is(event.target) && $navbar.has(event.target).length === 0 && 
                !$toggler.is(event.target) && $toggler.has(event.target).length === 0) {
                if ($navbar.hasClass('show')) {
                    $('.navbar-collapse').collapse('hide');
                }
            }
        });
        
        // Prevent body scroll when mobile menu is open (optional)
        $('.navbar-toggler').on('click', function() {
            setTimeout(function() {
                if ($('.navbar-collapse').hasClass('show')) {
                    $('body').css('overflow', 'hidden');
                } else {
                    $('body').css('overflow', 'auto');
                }
            }, 350); // Wait for animation
        });
        
        // Re-enable scroll when menu closes
        $('.navbar-collapse').on('hidden.bs.collapse', function() {
            $('body').css('overflow', 'auto');
        });
        
        // Account Sidebar Functionality
        $(document).ready(function() {
            const $sidebar = $('#accountSidebar');
            const $overlay = $('#sidebarOverlay');
            const $openBtnDesktop = $('#openSidebarBtn');
            const $openBtnMobile = $('#openSidebarBtnMobile');
            const $closeBtn = $('#closeSidebarBtn');
            
            // Open sidebar function
            function openSidebar() {
                $sidebar.addClass('open');
                $overlay.addClass('active');
                $('body').css('overflow', 'hidden');
            }
            
            // Open sidebar - Desktop button
            $openBtnDesktop.on('click', openSidebar);
            
            // Open sidebar - Mobile button
            $openBtnMobile.on('click', openSidebar);
            
            // Close sidebar
            function closeSidebar() {
                $sidebar.removeClass('open');
                $overlay.removeClass('active');
                $('body').css('overflow', 'auto');
            }
            
            $closeBtn.on('click', closeSidebar);
            $overlay.on('click', closeSidebar);
            
            // Close sidebar when clicking on a link
            $('.sidebar-link').on('click', function() {
                setTimeout(closeSidebar, 200);
            });
            
            // Close sidebar on ESC key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $sidebar.hasClass('open')) {
                    closeSidebar();
                }
            });
            
            // Mobile Profile Buttons - Open sidebar on mobile
            $('#mobileProfileBtnRenter, #mobileProfileBtnOwner').on('click', function(e) {
                e.preventDefault();
                openSidebar();
            });
        });
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)

    <!-- Mobile Bottom Navigation -->
    @if (User.Identity?.IsAuthenticated == true)
    {
        <nav class="mobile-nav-bottom">
            <div class="mobile-nav-items">
                <a href="/" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString() == "/Index" ? "active" : "")">
                    <i class="bi bi-house-fill"></i>
                    <span>Home</span>
                </a>
                <a href="/Bikes/Browse" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("Browse") == true ? "active" : "")">
                    <i class="bi bi-search"></i>
                    <span>Browse</span>
                </a>
                @if (AuthHelper.IsRenter(User))
                {
                    <a href="/Renter/RentalHistory" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("RentalHistory") == true ? "active" : "")">
                        <i class="bi bi-clock-history"></i>
                        <span>History</span>
                    </a>
                    <a href="#" id="mobileProfileBtnRenter" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("Profile") == true ? "active" : "")">
                        <i class="bi bi-person-fill"></i>
                        <span>Profile</span>
                    </a>
                }
                @if (AuthHelper.IsOwner(User))
                {
                    <a href="/" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString() == "/Index" ? "active" : "")">
                        <i class="bi bi-house-fill"></i>
                        <span>Home</span>
                    </a>
                    <a href="/Bikes/Browse" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("Browse") == true ? "active" : "")">
                        <i class="bi bi-search"></i>
                        <span>Browse</span>
                    </a>
                    <a href="/Dashboard/Owner" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("Dashboard/Owner") == true ? "active" : "")">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" id="mobileProfileBtnOwner" class="mobile-nav-item @(ViewContext.RouteData.Values["Page"]?.ToString()?.Contains("Profile") == true ? "active" : "")">
                        <i class="bi bi-person-fill"></i>
                        <span>Profile</span>
                    </a>
                }
                @if (AuthHelper.IsAdmin(User))
                {
                    <a href="/Admin/Dashboard" class="mobile-nav-item">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/Admin/ManageUsers" class="mobile-nav-item">
                        <i class="bi bi-people-fill"></i>
                        <span>Users</span>
                    </a>
                    <a href="/Admin/Reviews" class="mobile-nav-item">
                        <i class="bi bi-star-fill"></i>
                        <span>Reviews</span>
                    </a>
                    <a href="/Admin/Reports" class="mobile-nav-item">
                        <i class="bi bi-flag-fill"></i>
                        <span>Reports</span>
                    </a>
                }
            </div>
        </nav>
    }
</body>
</html>