@page "{bookingId:int}"
@using Microsoft.AspNetCore.Authorization
@using BiketaBai.Helpers
@attribute [Authorize]
@model TrackRenterModel
@{
    ViewData["Title"] = "Track Renter";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="~/css/premium-minimal.css" asp-append-version="true" />

<div class="page-container">
    @if (Model.Booking == null)
    {
        <div class="alert-minimal alert-minimal-error">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <div>Booking not found</div>
        </div>
    }
    else
    {
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-4);">
                <div>
                    <h1 class="page-title">
                        <i class="bi bi-geo-alt-fill"></i> Track: @Model.Booking.Renter.FullName
                    </h1>
                    <p class="page-subtitle">@Model.Booking.Bike.Brand @Model.Booking.Bike.Model</p>
                </div>
                <a href="/Owner/TrackRenters" class="btn-minimal btn-minimal-ghost">
                    <i class="bi bi-arrow-left"></i> Back to All Renters
                </a>
            </div>
        </div>

        <!-- Booking Info -->
        <div class="card-minimal mb-4">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-calendar-check"></i> Booking Details
                </h2>
            </div>
            <div class="grid-minimal grid-minimal-2">
                <div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Renter</div>
                    <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.Renter.FullName</div>
                    
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Bike</div>
                    <div style="font-weight: 600; margin-bottom: var(--space-3);">@Model.Booking.Bike.Brand @Model.Booking.Bike.Model</div>
                    
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Quantity</div>
                    <div style="font-weight: 600;">@Model.Booking.Quantity bike(s)</div>
                </div>
                <div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Start</div>
                    <div style="font-weight: 600; margin-bottom: var(--space-3);">@TimeZoneHelper.FormatPhilippineTime(Model.Booking.StartDate)</div>
                    
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">End</div>
                    <div style="font-weight: 600; margin-bottom: var(--space-3);">@TimeZoneHelper.FormatPhilippineTime(Model.Booking.EndDate)</div>
                    
                    <div style="font-size: 0.875rem; color: var(--neutral-600); margin-bottom: var(--space-1);">Geofence Radius</div>
                    <div style="font-weight: 600; color: var(--sage-primary);">@(Model.GeofenceRadiusKm?.ToString("F1") ?? "5.0") km</div>
                </div>
            </div>
        </div>

        <!-- Location Status -->
        <div class="card-minimal mb-4" id="locationStatusCard">
            <div class="card-minimal-header">
                <h2 class="card-minimal-title">
                    <i class="bi bi-geo-alt"></i> Current Location
                </h2>
            </div>
            <div id="locationDisplay" style="padding: var(--space-4);">
                @if (Model.LatestLocation != null)
                {
                    <div id="locationInfo">
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <p style="margin: 0;"><strong>Distance from Store:</strong> 
                                <span id="distanceText" style="color: @(Model.LatestLocation.IsWithinGeofence ? "var(--success)" : "var(--error)"); font-weight: 600;">
                                    @Model.LatestLocation.DistanceFromStoreKm?.ToString("F2") km
                                </span>
                            </p>
                            <p style="margin: 0;"><strong>Coordinates:</strong> 
                                <span id="coordinatesText" style="font-family: monospace; color: var(--neutral-700);">
                                    @Model.LatestLocation.Latitude.ToString("F6"), @Model.LatestLocation.Longitude.ToString("F6")
                                </span>
                            </p>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--neutral-500);">
                                <strong>Status:</strong> 
                                @if (Model.LatestLocation.IsWithinGeofence)
                                {
                                    <span style="color: var(--success); font-weight: 600;"><i class="bi bi-check-circle"></i> Within Geofence</span>
                                }
                                else
                                {
                                    <span style="color: var(--error); font-weight: 600;"><i class="bi bi-exclamation-triangle"></i> Outside Geofence</span>
                                }
                            </p>
                            <p style="margin: 0; font-size: 0.75rem; color: var(--neutral-500); margin-top: var(--space-1);">
                                Last updated: <span id="lastUpdateText">@TimeZoneHelper.FormatPhilippineTime(Model.LatestLocation.TrackedAt)</span>
                            </p>
                        </div>
                    </div>
                }
                else
                {
                    <div style="text-align: center; padding: var(--space-6);">
                        <i class="bi bi-hourglass-split" style="font-size: 3rem; color: var(--neutral-400);"></i>
                        <p class="mt-3" style="color: var(--neutral-600);">Waiting for location update...</p>
                    </div>
                }
            </div>
        </div>

        <!-- Map Container -->
        <div class="card-minimal mb-4">
            <div style="padding: 0; border-radius: var(--radius-lg); overflow: hidden;">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    }
</div>

<!-- Load Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

<script>
    let map;
    let renterMarker;
    let storeMarker;
    let geofenceCircle;
    let locationTrail;
    const bookingId = @Model.Booking?.BookingId ?? 0;
    const renterName = '@(Model.Booking?.Renter.FullName ?? "Unknown")';
    const bikeName = '@(Model.Booking?.Bike.Brand ?? "") @(Model.Booking?.Bike.Model ?? "")';
    
    // Store location history for trail
    const locationHistory = [];
    
    @if (Model.LocationHistory.Any())
    {
        <text>
        // Initialize location history from server
        @foreach (var loc in Model.LocationHistory)
        {
            <text>
            locationHistory.push({
                lat: @loc.Latitude,
                lng: @loc.Longitude,
                timestamp: '@loc.TrackedAt.ToString("yyyy-MM-ddTHH:mm:ss")'
            });
            </text>
        }
        </text>
    }

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        if (bookingId === 0) return;
        
        const storeLat = @(Model.StoreLatitude?.ToString("F6") ?? "14.5995");
        const storeLng = @(Model.StoreLongitude?.ToString("F6") ?? "120.9842");
        const radius = @(Model.GeofenceRadiusKm?.ToString("F1") ?? "5.0") * 1000; // Convert km to meters
        
        // Get initial renter location
        const initialLat = @(Model.LatestLocation?.Latitude.ToString("F6") ?? "storeLat");
        const initialLng = @(Model.LatestLocation?.Longitude.ToString("F6") ?? "storeLng");
        
        // Create map centered on renter or store
        const centerLat = @(Model.LatestLocation?.Latitude ?? Model.StoreLatitude ?? 14.5995);
        const centerLng = @(Model.LatestLocation?.Longitude ?? Model.StoreLongitude ?? 120.9842);
        
        map = L.map('map').setView([centerLat, centerLng], 13);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Add store marker
        @if (Model.StoreLatitude.HasValue && Model.StoreLongitude.HasValue)
        {
            <text>
            storeMarker = L.marker([@Model.StoreLatitude.Value.ToString("F6"), @Model.StoreLongitude.Value.ToString("F6")], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup('@(Model.StoreName ?? "Store Location")');

            // Add geofence circle
            geofenceCircle = L.circle([@Model.StoreLatitude.Value.ToString("F6"), @Model.StoreLongitude.Value.ToString("F6")], {
                color: '#87A96B',
                fillColor: '#E8F0E3',
                fillOpacity: 0.3,
                radius: radius
            }).addTo(map);
            </text>
        }

        // Add renter marker if location exists
        @if (Model.LatestLocation != null)
        {
            <text>
            const isWithin = @Model.LatestLocation.IsWithinGeofence.ToString().ToLower();
            renterMarker = L.marker([@Model.LatestLocation.Latitude.ToString("F6"), @Model.LatestLocation.Longitude.ToString("F6")], {
                icon: L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${isWithin ? 'blue' : 'red'}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [30, 48],
                    iconAnchor: [15, 48],
                    popupAnchor: [1, -40],
                    shadowSize: [41, 41]
                }),
                zIndexOffset: 1000
            }).addTo(map).bindPopup(`
                <div style="min-width: 200px;">
                    <strong style="font-size: 1.1em;">${renterName}</strong><br>
                    <span style="color: #666;">${bikeName}</span><br>
                    <hr style="margin: 8px 0;">
                    <strong>Distance:</strong> @Model.LatestLocation.DistanceFromStoreKm?.ToString("F2") km<br>
                    <strong>Status:</strong> ${isWithin ? '<span style="color: green;">âœ“ Within Geofence</span>' : '<span style="color: red;">âš  Outside Geofence</span>'}<br>
                    <strong>Coordinates:</strong><br>
                    <code style="font-size: 0.85em;">@Model.LatestLocation.Latitude.ToString("F6"), @Model.LatestLocation.Longitude.ToString("F6")</code><br>
                    <small style="color: #666; display: block; margin-top: 8px;">
                        <i class="bi bi-circle-fill" style="color: #28a745; font-size: 0.6em;"></i> Live Tracking<br>
                        Updated: ${new Date().toLocaleTimeString()}
                    </small>
                </div>
            `);
            </text>
        }

        // Draw location trail if history exists
        if (locationHistory.length > 1) {
            const trailPoints = locationHistory.map(point => [point.lat, point.lng]);
            locationTrail = L.polyline(trailPoints, {
                color: '#3388ff',
                weight: 3,
                opacity: 0.6,
                smoothFactor: 1
            }).addTo(map);
        }

        // Fit map to show all markers
        const bounds = L.latLngBounds([]);
        if (storeMarker) bounds.extend(storeMarker.getLatLng());
        if (renterMarker) bounds.extend(renterMarker.getLatLng());
        if (geofenceCircle) bounds.extend(geofenceCircle.getBounds());
        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Initialize SignalR connection for real-time updates
        initializeLocationTrackingSignalR();
    });

    function initializeLocationTrackingSignalR() {
        if (typeof signalR === 'undefined') {
            console.error('SignalR library not loaded. Retrying in 2 seconds...');
            setTimeout(initializeLocationTrackingSignalR, 2000);
            return;
        }
        
        console.log('Initializing SignalR connection for location tracking...');
        
        // Check if notification hub connection already exists from _Layout.cshtml
        let connection;
        if (typeof window.BiketaBaiNotifications !== 'undefined' && 
            window.BiketaBaiNotifications.connection) {
            console.log('Reusing existing notification hub connection for location tracking');
            connection = window.BiketaBaiNotifications.connection;
        } else {
            // Create a new connection if one doesn't exist
            console.log('Creating new SignalR connection for location tracking');
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .withAutomaticReconnect()
                .build();
            
            connection.start().catch(err => {
                console.error("SignalR connection error:", err);
            });
        }
        
        // Remove existing handlers
        connection.off("ReceiveLocationUpdate");
        
        // Listen for location updates
        connection.on("ReceiveLocationUpdate", function(data) {
            console.log("ðŸ“ Received location update:", data);
            
            if (!data || !data.bookingId || parseInt(data.bookingId) !== bookingId) {
                return; // Not for this booking
            }
            
            const lat = parseFloat(data.latitude);
            const lng = parseFloat(data.longitude);
            const distance = parseFloat(data.distanceKm || 0);
            const isWithin = data.isWithinGeofence === true || data.isWithinGeofence === 'true';
            const trackedAt = data.trackedAt || new Date().toISOString();
            
            // Validate coordinates
            if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                console.error("âŒ Invalid coordinates in location update:", data);
                return;
            }
            
            // Add to history
            locationHistory.push({ lat, lng, timestamp: trackedAt });
            if (locationHistory.length > 100) {
                locationHistory.shift();
            }
            
            // Update trail
            if (locationHistory.length > 1) {
                if (locationTrail) {
                    map.removeLayer(locationTrail);
                }
                const trailPoints = locationHistory.map(point => [point.lat, point.lng]);
                locationTrail = L.polyline(trailPoints, {
                    color: isWithin ? '#3388ff' : '#ff3333',
                    weight: 3,
                    opacity: 0.6,
                    smoothFactor: 1
                }).addTo(map);
            }
            
            // Update marker
            if (renterMarker) {
                renterMarker.setLatLng([lat, lng], {
                    animate: true,
                    duration: 0.8,
                    easeLinearity: 0.25
                });
                
                // Update icon if geofence status changed
                const markerIcon = L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${isWithin ? 'blue' : 'red'}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [30, 48],
                    iconAnchor: [15, 48],
                    popupAnchor: [1, -40],
                    shadowSize: [41, 41]
                });
                renterMarker.setIcon(markerIcon);
                
                // Update popup
                renterMarker.setPopupContent(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 1.1em;">${renterName}</strong><br>
                        <span style="color: #666;">${bikeName}</span><br>
                        <hr style="margin: 8px 0;">
                        <strong>Distance:</strong> ${distance.toFixed(2)} km<br>
                        <strong>Status:</strong> ${isWithin ? '<span style="color: green;">âœ“ Within Geofence</span>' : '<span style="color: red;">âš  Outside Geofence</span>'}<br>
                        <strong>Coordinates:</strong><br>
                        <code style="font-size: 0.85em;">${lat.toFixed(6)}, ${lng.toFixed(6)}</code><br>
                        <small style="color: #666; display: block; margin-top: 8px;">
                            <i class="bi bi-circle-fill" style="color: #28a745; font-size: 0.6em;"></i> Live Tracking<br>
                            Updated: ${new Date().toLocaleTimeString()}
                        </small>
                    </div>
                `);
            } else {
                // Create marker if it doesn't exist
                renterMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${isWithin ? 'blue' : 'red'}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [30, 48],
                        iconAnchor: [15, 48],
                        popupAnchor: [1, -40],
                        shadowSize: [41, 41]
                    }),
                    zIndexOffset: 1000
                }).addTo(map).bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 1.1em;">${renterName}</strong><br>
                        <span style="color: #666;">${bikeName}</span><br>
                        <hr style="margin: 8px 0;">
                        <strong>Distance:</strong> ${distance.toFixed(2)} km<br>
                        <strong>Status:</strong> ${isWithin ? '<span style="color: green;">âœ“ Within Geofence</span>' : '<span style="color: red;">âš  Outside Geofence</span>'}<br>
                        <strong>Coordinates:</strong><br>
                        <code style="font-size: 0.85em;">${lat.toFixed(6)}, ${lng.toFixed(6)}</code><br>
                        <small style="color: #666; display: block; margin-top: 8px;">
                            <i class="bi bi-circle-fill" style="color: #28a745; font-size: 0.6em;"></i> Live Tracking<br>
                            Updated: ${new Date().toLocaleTimeString()}
                        </small>
                    </div>
                `);
            }
            
            // Update location display
            updateLocationDisplay(lat, lng, distance, isWithin, trackedAt);
        });
        
        console.log("âœ… Location tracking SignalR initialized. Listening for updates...");
    }

    function updateLocationDisplay(lat, lng, distance, isWithin, trackedAt) {
        const locationDisplay = document.getElementById('locationDisplay');
        if (!locationDisplay) return;
        
        let phTime;
        try {
            phTime = new Date(trackedAt).toLocaleString('en-US', {
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            phTime = new Date().toLocaleString();
        }
        
        locationDisplay.innerHTML = `
            <div id="locationInfo">
                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                    <p style="margin: 0;"><strong>Distance from Store:</strong> 
                        <span id="distanceText" style="color: ${isWithin ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                            ${distance.toFixed(2)} km
                        </span>
                    </p>
                    <p style="margin: 0;"><strong>Coordinates:</strong> 
                        <span id="coordinatesText" style="font-family: monospace; color: var(--neutral-700);">
                            ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </span>
                    </p>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--neutral-500);">
                        <strong>Status:</strong> 
                        ${isWithin 
                            ? '<span style="color: var(--success); font-weight: 600;"><i class="bi bi-check-circle"></i> Within Geofence</span>'
                            : '<span style="color: var(--error); font-weight: 600;"><i class="bi bi-exclamation-triangle"></i> Outside Geofence</span>'
                        }
                    </p>
                    <p style="margin: 0; font-size: 0.75rem; color: var(--neutral-500); margin-top: var(--space-1);">
                        Last updated: <span id="lastUpdateText">${phTime}</span>
                    </p>
                </div>
            </div>
        `;
    }
</script>

