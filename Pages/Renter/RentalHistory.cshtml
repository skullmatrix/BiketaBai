@page
@model RentalHistoryModel
@{
    ViewData["Title"] = "Rental History";
}

@section Styles {
    <link rel="stylesheet" href="~/css/rental-history.css" asp-append-version="true" />
}

<div class="rental-history-page">
    <div class="container">
        <!-- Compact Header -->
        <div class="history-header">
            <div>
                <h1><i class="bi bi-clock-history"></i> Rental History</h1>
                <p>Manage and track your bike rentals</p>
            </div>
            <a href="/Bikes/Browse" class="btn-sage-primary btn-compact">
                <i class="bi bi-bicycle"></i>
                <span>Browse Bikes</span>
            </a>
        </div>

        <!-- Compact Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon sage">
                    <i class="bi bi-card-list"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.TotalRentals</div>
                    <div class="stat-label">Total Rentals</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon sage">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">₱@Model.TotalSpent.ToString("N0")</div>
                    <div class="stat-label">Total Spent</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon sage">
                    <i class="bi bi-bicycle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.ActiveRentals</div>
                    <div class="stat-label">Active</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon sage">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.CompletedRentals</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
        </div>

        <!-- Compact Tabs -->
        <div class="tabs-compact">
            <button class="tab-btn active" data-tab="current">
                <i class="bi bi-bicycle"></i>
                <span>Current</span>
                @if (Model.CurrentBookings.Count > 0)
                {
                    <span class="tab-badge">@Model.CurrentBookings.Count</span>
                }
            </button>
            <button class="tab-btn" data-tab="completed">
                <i class="bi bi-check-circle"></i>
                <span>Completed</span>
                @if (Model.PastBookings.Count > 0)
                {
                    <span class="tab-badge">@Model.PastBookings.Count</span>
                }
            </button>
            <button class="tab-btn" data-tab="cancelled">
                <i class="bi bi-x-circle"></i>
                <span>Cancelled</span>
                @if (Model.CancelledBookings.Count > 0)
                {
                    <span class="tab-badge">@Model.CancelledBookings.Count</span>
                }
            </button>
        </div>

        <!-- Tab Content -->
        <!-- Current Rentals -->
        <div class="tab-content active" id="current-content">
            @if (Model.CurrentBookings.Any())
            {
                <div class="bookings-list">
                    @foreach (var booking in Model.CurrentBookings)
                    {
                        <div class="booking-card">
                            <div class="booking-image">
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" alt="@booking.Bike.Brand @booking.Bike.Model" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <i class="bi bi-bicycle"></i>
                                    </div>
                                }
                                <div class="status-badge @Model.GetStatusBadgeClass(booking.BookingStatus.StatusName)">
                                    <i class="bi @Model.GetStatusIcon(booking.BookingStatus.StatusName)"></i>
                                    <span>@booking.BookingStatus.StatusName</span>
                                </div>
                            </div>
                            
                            <div class="booking-details">
                                <div class="booking-header">
                                    <h3>@booking.Bike.Brand @booking.Bike.Model</h3>
                                    <div class="booking-price">₱@booking.TotalAmount.ToString("N2")</div>
                                </div>
                                
                                <div class="booking-meta">
                                    <div class="meta-item">
                                        <i class="bi bi-tag"></i>
                                        <span>@booking.Bike.BikeType.TypeName</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="bi bi-person"></i>
                                        <span>@booking.Bike.Owner.FullName</span>
                                    </div>
                                </div>
                                
                                <div class="booking-dates">
                                    <div class="date-item">
                                        <i class="bi bi-calendar-event"></i>
                                        <div>
                                            <span class="date-label">Start</span>
                                            <span class="date-value">@BiketaBai.Helpers.TimeZoneHelper.FormatPhilippineTime(booking.StartDate)</span>
                                        </div>
                                    </div>
                                    <div class="date-item">
                                        <i class="bi bi-calendar-x"></i>
                                        <div>
                                            <span class="date-label">End</span>
                                            <span class="date-value">@BiketaBai.Helpers.TimeZoneHelper.FormatPhilippineTime(booking.EndDate)</span>
                                        </div>
                                    </div>
                                    @if (booking.BookingStatus.StatusName == "Active")
                                    {
                                        <div class="date-item" style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid var(--neutral-200);">
                                            <i class="bi bi-clock" style="color: var(--sage-primary);"></i>
                                            <div>
                                                <span class="date-label">Time Remaining</span>
                                                <span class="date-value" style="color: var(--sage-primary); font-weight: 600;">
                                                    <span class="time-remaining" data-end-date="@BiketaBai.Helpers.TimeZoneHelper.FormatPhilippineTimeIso(booking.EndDate)">Calculating...</span>
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                                
                                <div class="booking-actions">
                                    <a href="/Bikes/Details/@booking.BikeId" class="btn-action btn-view">
                                        <i class="bi bi-eye"></i>
                                        <span>View</span>
                                    </a>
                                    @if (booking.BookingStatus.StatusName == "Pending" || booking.BookingStatus.StatusName == "Confirmed")
                                    {
                                        <form method="post" asp-page-handler="CancelBooking" asp-route-bookingId="@booking.BookingId" 
                                              onsubmit="return confirm('Cancel this booking? Cancellation policy applies.');" 
                                              class="d-inline">
                                            <button type="submit" class="btn-action btn-cancel">
                                                <i class="bi bi-x-circle"></i>
                                                <span>Cancel</span>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>No Current Rentals</h3>
                    <p>You don't have any active or pending rentals</p>
                    <a href="/Bikes/Browse" class="btn-sage-primary">
                        <i class="bi bi-bicycle"></i>
                        <span>Browse Bikes</span>
                    </a>
                </div>
            }
        </div>

        <!-- Completed Rentals -->
        <div class="tab-content" id="completed-content">
            @if (Model.PastBookings.Any())
            {
                <div class="bookings-list">
                    @foreach (var booking in Model.PastBookings)
                    {
                        <div class="booking-card">
                            <div class="booking-image">
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" alt="@booking.Bike.Brand @booking.Bike.Model" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <i class="bi bi-bicycle"></i>
                                    </div>
                                }
                                <div class="status-badge completed">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>Completed</span>
                                </div>
                            </div>
                            
                            <div class="booking-details">
                                <div class="booking-header">
                                    <h3>@booking.Bike.Brand @booking.Bike.Model</h3>
                                    <div class="booking-price">₱@booking.TotalAmount.ToString("N2")</div>
                                </div>
                                
                                <div class="booking-meta">
                                    <div class="meta-item">
                                        <i class="bi bi-tag"></i>
                                        <span>@booking.Bike.BikeType.TypeName</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="bi bi-person"></i>
                                        <span>@booking.Bike.Owner.FullName</span>
                                    </div>
                                </div>
                                
                                <div class="booking-dates">
                                    <div class="date-item">
                                        <i class="bi bi-calendar-check"></i>
                                        <div>
                                            <span class="date-label">Completed</span>
                                            <span class="date-value">@booking.EndDate.ToString("MMM dd, yyyy")</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="booking-actions">
                                    <a href="/Bikes/Details/@booking.BikeId" class="btn-action btn-view">
                                        <i class="bi bi-eye"></i>
                                        <span>View</span>
                                    </a>
                                    @if (!Model.HasRatedBooking(booking.BookingId))
                                    {
                                        <a href="/Renter/Review/@booking.BookingId" class="btn-action btn-review">
                                            <i class="bi bi-star"></i>
                                            <span>Leave Review</span>
                                        </a>
                                    }
                                    <a href="/Bikes/Details/@booking.BikeId" class="btn-action btn-rent-again">
                                        <i class="bi bi-arrow-repeat"></i>
                                        <span>Rent Again</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <h3>No Completed Rentals</h3>
                    <p>You haven't completed any rentals yet</p>
                    <a href="/Bikes/Browse" class="btn-sage-primary">
                        <i class="bi bi-bicycle"></i>
                        <span>Find Your First Bike</span>
                    </a>
                </div>
            }
        </div>

        <!-- Cancelled Rentals -->
        <div class="tab-content" id="cancelled-content">
            @if (Model.CancelledBookings.Any())
            {
                <div class="bookings-list">
                    @foreach (var booking in Model.CancelledBookings)
                    {
                        <div class="booking-card">
                            <div class="booking-image">
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" alt="@booking.Bike.Brand @booking.Bike.Model" />
                                }
                                else
                                {
                                    <div class="image-placeholder">
                                        <i class="bi bi-bicycle"></i>
                                    </div>
                                }
                                <div class="status-badge cancelled">
                                    <i class="bi bi-x-circle-fill"></i>
                                    <span>Cancelled</span>
                                </div>
                            </div>
                            
                            <div class="booking-details">
                                <div class="booking-header">
                                    <h3>@booking.Bike.Brand @booking.Bike.Model</h3>
                                </div>
                                
                                <div class="booking-meta">
                                    <div class="meta-item">
                                        <i class="bi bi-tag"></i>
                                        <span>@booking.Bike.BikeType.TypeName</span>
                                    </div>
                                </div>
                                
                                <div class="cancelled-notice">
                                    <i class="bi bi-info-circle"></i>
                                    <span>Refund processed to your wallet</span>
                                </div>
                                
                                <div class="booking-actions">
                                    <a href="/Bikes/Details/@booking.BikeId" class="btn-action btn-view">
                                        <i class="bi bi-eye"></i>
                                        <span>View</span>
                                    </a>
                                    <a href="/Bikes/Details/@booking.BikeId" class="btn-action btn-rent-again">
                                        <i class="bi bi-arrow-repeat"></i>
                                        <span>Book Again</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-x-circle"></i>
                    <h3>No Cancelled Rentals</h3>
                    <p>You haven't cancelled any bookings</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Helper function to get current Philippine time (UTC+8)
        function getPhilippineTime() {
            const now = new Date();
            // Get current time in Philippine timezone
            const phTimeStr = now.toLocaleString('en-US', { 
                timeZone: 'Asia/Manila',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // Parse the string to create a Date object
            // Format: "MM/DD/YYYY, HH:MM:SS"
            const parts = phTimeStr.split(', ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            
            // Create date in local timezone but representing Philippine time
            const phDate = new Date(
                parseInt(dateParts[2]), // year
                parseInt(dateParts[0]) - 1, // month (0-indexed)
                parseInt(dateParts[1]), // day
                parseInt(timeParts[0]), // hour
                parseInt(timeParts[1]), // minute
                parseInt(timeParts[2]) // second
            );
            
            return phDate;
        }
        
        // Time remaining countdown - uses Philippine time (UTC+8)
        function updateTimeRemaining() {
            $('.time-remaining').each(function() {
                const $element = $(this);
                const endDateStr = $element.data('end-date');
                if (!endDateStr) return;
                
                // Parse the end date - it's in Philippine time format (YYYY-MM-DDTHH:mm:ss)
                const endDateParts = endDateStr.split('T');
                const dateParts = endDateParts[0].split('-');
                const timeParts = endDateParts[1].split(':');
                
                // Create end date in local timezone but representing Philippine time values
                const endDate = new Date(
                    parseInt(dateParts[0]), // year
                    parseInt(dateParts[1]) - 1, // month (0-indexed)
                    parseInt(dateParts[2]), // day
                    parseInt(timeParts[0]), // hour
                    parseInt(timeParts[1]), // minute
                    parseInt(timeParts[2] || 0) // second
                );
                
                // Get current Philippine time
                const nowPHT = getPhilippineTime();
                
                // Calculate difference
                const diffMs = endDate.getTime() - nowPHT.getTime();

                if (diffMs <= 0) {
                    $element.text('Time Expired');
                    $element.css('color', 'var(--danger)');
                } else {
                    const diffSeconds = Math.floor(diffMs / 1000);
                    const hours = Math.floor(diffSeconds / 3600);
                    const minutes = Math.floor((diffSeconds % 3600) / 60);
                    const seconds = diffSeconds % 60;
                    
                    if (hours > 0) {
                        $element.text(`${hours}h ${minutes}m ${seconds}s`);
                    } else if (minutes > 0) {
                        $element.text(`${minutes}m ${seconds}s`);
                    } else {
                        $element.text(`${seconds}s`);
                    }
                }
            });
        }
        
        // Update countdown every second
        setInterval(updateTimeRemaining, 1000);
        updateTimeRemaining(); // Initial call

        $(document).ready(function() {
            // Tab switching
            $('.tab-btn').on('click', function() {
                const tabName = $(this).data('tab');
                
                // Update buttons
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                
                // Update content
                $('.tab-content').removeClass('active');
                $('#' + tabName + '-content').addClass('active');
                
                // Save to localStorage
                localStorage.setItem('rentalHistoryTab', tabName);
            });
            
            // Restore last tab
            const savedTab = localStorage.getItem('rentalHistoryTab');
            if (savedTab) {
                $('.tab-btn[data-tab="' + savedTab + '"]').click();
            }
        });
    </script>
}
