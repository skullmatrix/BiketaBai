@page
@model ProfileModel
@{
    ViewData["Title"] = "My Profile";
}

<link rel="stylesheet" href="~/css/premium-minimal.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/auth-minimal.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/profile-minimal.css" asp-append-version="true" />

<div class="profile-minimal-container">
    <div class="container">
        <!-- Compact Header -->
        <div class="profile-header-minimal">
            <div class="profile-header-content">
                <div class="profile-header-title">
                    <i class="bi bi-person-circle"></i>
                    <div>
                        <h1>My Profile</h1>
                        <p>Manage your account and view statistics</p>
                    </div>
                </div>
                @if (Model.CurrentUser.IsOwner)
                {
                    <a href="/Dashboard/Owner" class="btn-minimal-back">
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </a>
                }
                else if (Model.CurrentUser.IsRenter)
                {
                    <a href="/Dashboard/Renter" class="btn-minimal-back">
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </a>
                }
                else if (Model.CurrentUser.IsAdmin)
                {
                    <a href="/Dashboard/Admin" class="btn-minimal-back">
                        <i class="bi bi-arrow-left"></i> Dashboard
                    </a>
                }
            </div>
        </div>

        <!-- Success/Error Messages -->
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="success-message mb-3">
                <i class="bi bi-check-circle"></i>
                <div>
                    <strong>Success!</strong>
                    <p>@Model.SuccessMessage</p>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="error-summary mb-3">
                <i class="bi bi-exclamation-triangle"></i>
                <div>
                    <strong>Error</strong>
                    <p>@Model.ErrorMessage</p>
                </div>
            </div>
        }

        <!-- Profile Overview Card -->
        <div class="profile-card-minimal">
            <div class="profile-overview-grid">
                <!-- Profile Photo & Info -->
                <div class="profile-avatar-section">
                    <div class="profile-avatar-minimal">
                        @if (!string.IsNullOrEmpty(Model.CurrentUser.ProfilePhotoUrl))
                        {
                            <img src="@Model.CurrentUser.ProfilePhotoUrl" alt="Profile Photo" />
                        }
                        else
                        {
                            <i class="bi bi-person-fill"></i>
                        }
                    </div>
                    
                    <!-- Upload Photo Button -->
                    <form method="post" enctype="multipart/form-data" asp-page-handler="UploadPhoto">
                        <label for="photoUpload" class="btn-upload-photo">
                            <i class="bi bi-camera"></i> Change
                        </label>
                        <input type="file" id="photoUpload" name="profilePhoto" accept="image/*" style="display:none;" 
                               onchange="this.form.submit()" />
                    </form>

                    <div class="profile-user-info">
                        <h3>@(Model.CurrentUser.FullName ?? "No Name")</h3>
                        <p class="user-email">@(Model.CurrentUser.Email ?? "No Email")</p>
                        
                        <!-- Roles -->
                        <div class="profile-roles">
                            @if (Model.CurrentUser.IsAdmin)
                            {
                                <span class="role-badge admin">
                                    <i class="bi bi-shield-fill"></i> Admin
                                </span>
                            }
                            @if (Model.CurrentUser.IsOwner)
                            {
                                <span class="role-badge owner">
                                    <i class="bi bi-shop"></i> Owner
                                </span>
                            }
                            @if (Model.CurrentUser.IsRenter)
                            {
                                <span class="role-badge renter">
                                    <i class="bi bi-bicycle"></i> Renter
                                </span>
                            }
                        </div>

                        <!-- Verification Status -->
                        <div class="profile-verification">
                            @if (Model.CurrentUser.IsEmailVerified)
                            {
                                <span class="verified-badge">
                                    <i class="bi bi-patch-check-fill"></i> Verified
                                </span>
                            }
                            else
                            {
                                <span class="unverified-badge">
                                    <i class="bi bi-exclamation-circle"></i> Unverified
                                </span>
                            }
                            
                            @if (Model.CurrentUser.IsOwner)
                            {
                                @Html.Raw(Model.GetVerificationStatusBadge())
                            }
                        </div>
                        
                        <!-- Member Since -->
                        <p class="member-since">
                            <i class="bi bi-calendar"></i> Member since @Model.CurrentUser.CreatedAt.ToString("MMM yyyy")
                        </p>
                    </div>
                </div>
                
                <!-- Statistics Grid -->
                <div class="profile-stats-section">
                    @if (Model.CurrentUser.IsRenter)
                    {
                        <!-- Renter Statistics -->
                        <div class="stats-grid-3">
                            <div class="stat-card-minimal">
                                <i class="bi bi-bicycle"></i>
                                <div class="stat-content">
                                    <h4>@Model.Statistics.TotalRentals</h4>
                                    <p>Total Rentals</p>
                                    <small>@Model.Statistics.CompletedRentals completed</small>
                                </div>
                            </div>
                            
                            <div class="stat-card-minimal">
                                <i class="bi bi-wallet2"></i>
                                <div class="stat-content">
                                    <h4>₱@Model.Statistics.TotalSpent.ToString("N0")</h4>
                                    <p>Total Spent</p>
                                    <small>@Model.Statistics.ActiveRentals active</small>
                                </div>
                            </div>

                            <div class="stat-card-minimal">
                                <i class="bi bi-star-fill"></i>
                                <div class="stat-content">
                                    <h4>@Model.Statistics.AverageRating.ToString("F1")</h4>
                                    <p>User Rating</p>
                                    <small>@Model.Statistics.TotalReviews review(s)</small>
                                </div>
                            </div>
                        </div>
                    }

                    @if (Model.CurrentUser.IsOwner)
                    {
                        <!-- Owner Statistics -->
                        <div class="stats-grid-4">
                            <div class="stat-card-minimal">
                                <i class="bi bi-bicycle"></i>
                                <div class="stat-content">
                                    <h4>@Model.Statistics.TotalBikes</h4>
                                    <p>Total Bikes</p>
                                    <small>Listed</small>
                                </div>
                            </div>
                            
                            <div class="stat-card-minimal">
                                <i class="bi bi-calendar-check"></i>
                                <div class="stat-content">
                                    <h4>@Model.Statistics.TotalBookings</h4>
                                    <p>Bookings</p>
                                    <small>@Model.Statistics.CompletedBookings completed</small>
                                </div>
                            </div>
                            
                            <div class="stat-card-minimal">
                                <i class="bi bi-star-fill"></i>
                                <div class="stat-content">
                                    <h4>@Model.Statistics.AverageRating.ToString("F1")</h4>
                                    <p>Rating</p>
                                    <small>@Model.Statistics.TotalReviews review(s)</small>
                                </div>
                            </div>
                            
                            <div class="stat-card-minimal highlight">
                                <i class="bi bi-wallet2"></i>
                                <div class="stat-content">
                                    <h4>₱@Model.Statistics.TotalEarnings.ToString("N0")</h4>
                                    <p>Earnings</p>
                                    <small>90% share</small>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <!-- Wallet & Points -->
                    <div class="wallet-points-grid">
                        <div class="wallet-card-minimal">
                            <i class="bi bi-wallet2"></i>
                            <div>
                                <p>Wallet Balance</p>
                                <h5>₱@Model.Statistics.WalletBalance.ToString("N2")</h5>
                            </div>
                            <a href="/Wallet/Index" class="btn-minimal-action">Manage</a>
                        </div>
                        
                        <div class="wallet-card-minimal points">
                            <i class="bi bi-star-fill"></i>
                            <div>
                                <p>Loyalty Points</p>
                                <h5>@Model.Statistics.LoyaltyPoints pts</h5>
                            </div>
                            <a href="/Points/Index" class="btn-minimal-action">View</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Profile Form -->
        <div class="profile-forms-grid">
            <div class="profile-card-minimal edit-form">
                <div class="card-header-minimal">
                    <i class="bi bi-pencil-square"></i>
                    <h5>Edit Profile</h5>
                </div>
                
                <form method="post" class="profile-form-minimal">
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Full Name <span class="required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input asp-for="Input.FullName" class="auth-input" placeholder="Enter your full name" required />
                            <i class="bi bi-person auth-input-icon"></i>
                        </div>
                        <span asp-validation-for="Input.FullName" class="validation-message error"></span>
                    </div>
                    
                    <div class="auth-form-group">
                        <label class="auth-form-label">Email Address</label>
                        <div class="auth-input-wrapper">
                            <input type="email" class="auth-input" value="@Model.CurrentUser.Email" disabled />
                            <i class="bi bi-envelope auth-input-icon"></i>
                        </div>
                        <small class="helper-text">Email cannot be changed</small>
                    </div>
                    
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Phone Number <span class="required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <input asp-for="Input.Phone" class="auth-input" placeholder="+63 XXX XXX XXXX" required />
                            <i class="bi bi-telephone auth-input-icon"></i>
                        </div>
                        <span asp-validation-for="Input.Phone" class="validation-message error"></span>
                    </div>
                    
                    <div class="auth-form-group">
                        <label class="auth-form-label">
                            Address <span class="required">*</span>
                        </label>
                        <div class="auth-input-wrapper">
                            <textarea asp-for="Input.Address" class="auth-input textarea" rows="4" placeholder="Street, City, Province" required></textarea>
                            <i class="bi bi-geo-alt auth-input-icon"></i>
                        </div>
                        <span asp-validation-for="Input.Address" class="validation-message error"></span>
                    </div>
                    
                    <button type="submit" class="auth-btn-minimal auth-btn-primary">
                        <i class="bi bi-check-circle"></i> Update Profile
                    </button>
                </form>
                
                <div class="profile-divider"></div>
                
                <!-- Additional Actions -->
                <div class="profile-actions">
                    <a href="/Account/ChangePassword" class="auth-btn-minimal auth-btn-outline">
                        <i class="bi bi-key"></i> Change Password
                    </a>
                    
                    @if (Model.CurrentUser.IsOwner && string.IsNullOrEmpty(Model.CurrentUser.IdDocumentUrl))
                    {
                        <button type="button" class="auth-btn-minimal auth-btn-outline" data-bs-toggle="modal" data-bs-target="#uploadIdModal">
                            <i class="bi bi-file-earmark-text"></i> Upload ID Document
                        </button>
                    }
                </div>
            </div>

            <!-- Account Information -->
            <div class="profile-card-minimal">
                <div class="card-header-minimal">
                    <i class="bi bi-info-circle"></i>
                    <h5>Account Information</h5>
                </div>
                
                <div class="account-info-list">
                    <div class="info-item">
                        <span class="info-label">
                            <i class="bi bi-shield-check"></i> Account Status
                        </span>
                        <span class="info-value">
                            @if (Model.CurrentUser.IsSuspended)
                            {
                                <span class="status-badge suspended">Suspended</span>
                            }
                            else
                            {
                                <span class="status-badge active">Active</span>
                            }
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">
                            <i class="bi bi-envelope-check"></i> Email Verification
                        </span>
                        <span class="info-value">
                            @if (Model.CurrentUser.IsEmailVerified)
                            {
                                <span class="status-badge verified">Verified</span>
                            }
                            else
                            {
                                <span class="status-badge unverified">Not Verified</span>
                            }
                        </span>
                    </div>
                    
                    @if (Model.CurrentUser.IsOwner)
                    {
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-patch-check"></i> Owner Verification
                            </span>
                            <span class="info-value">
                                @Html.Raw(Model.GetVerificationStatusBadge())
                            </span>
                        </div>
                    }
                    
                    <div class="info-item">
                        <span class="info-label">
                            <i class="bi bi-calendar-plus"></i> Account Created
                        </span>
                        <span class="info-value">@Model.CurrentUser.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">
                            <i class="bi bi-clock"></i> Last Updated
                        </span>
                        <span class="info-value">@Model.CurrentUser.UpdatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.CurrentUser.IdDocumentUrl))
                    {
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-file-earmark-text"></i> ID Document
                            </span>
                            <span class="info-value">
                                <a href="@Model.CurrentUser.IdDocumentUrl" target="_blank" class="btn-view-doc">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </span>
                        </div>
                    }
                </div>
            </div>

            <!-- Recent Activity -->
            @if (Model.RecentBookings.Any())
            {
                <div class="profile-card-minimal recent-activity">
                    <div class="card-header-minimal">
                        <i class="bi bi-clock-history"></i>
                        <h5>Recent @(Model.CurrentUser.IsOwner ? "Bookings" : "Rentals")</h5>
                    </div>
                    
                    <div class="recent-bookings-list">
                        @foreach (var booking in Model.RecentBookings.Take(3))
                        {
                            <div class="recent-booking-item">
                                @if (booking.Bike.BikeImages.Any())
                                {
                                    <img src="@booking.Bike.BikeImages.First().ImageUrl" 
                                         class="booking-thumb" 
                                         alt="@booking.Bike.Brand" />
                                }
                                else
                                {
                                    <div class="booking-thumb-placeholder">
                                        <i class="bi bi-bicycle"></i>
                                    </div>
                                }
                                
                                <div class="booking-details">
                                    <h6>@booking.Bike.Brand @booking.Bike.Model</h6>
                                    @if (Model.CurrentUser.IsOwner)
                                    {
                                        <p class="booking-info">
                                            <i class="bi bi-person"></i> @booking.Renter.FullName
                                        </p>
                                    }
                                    <p class="booking-info">
                                        <i class="bi bi-calendar"></i> @booking.StartDate.ToString("MMM dd, yyyy")
                                    </p>
                                    <span class="status-badge @(booking.BookingStatus.StatusName.ToLower())">
                                        @booking.BookingStatus.StatusName
                                    </span>
                                </div>
                                
                                <div class="booking-amount">
                                    ₱@((Model.CurrentUser.IsOwner ? booking.TotalAmount * 0.90m : booking.TotalAmount).ToString("N2"))
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Upload ID Document Modal -->
@if (Model.CurrentUser.IsOwner)
{
    <div class="modal fade" id="uploadIdModal" tabindex="-1" aria-labelledby="uploadIdModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-minimal">
                <div class="modal-header-minimal">
                    <div class="modal-title-minimal">
                        <i class="bi bi-file-earmark-text"></i>
                        <h5>Upload ID Document</h5>
                    </div>
                    <button type="button" class="btn-close-minimal" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <form method="post" enctype="multipart/form-data" asp-page-handler="UploadIdDocument">
                    <div class="modal-body-minimal">
                        <p class="helper-text mb-3">
                            Upload a valid government-issued ID for owner verification. Accepted formats: JPG, PNG, PDF (Max 5MB)
                        </p>
                        <div class="auth-form-group">
                            <label class="auth-form-label">Select Document <span class="required">*</span></label>
                            <div class="file-upload-minimal">
                                <input type="file" class="file-input-minimal" id="idDocument" name="idDocument" 
                                       accept=".jpg,.jpeg,.png,.pdf" required />
                                <label for="idDocument" class="file-label-minimal">
                                    <i class="bi bi-cloud-upload"></i>
                                    <span>Choose file or drag here</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer-minimal">
                        <button type="button" class="auth-btn-minimal auth-btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="auth-btn-minimal auth-btn-primary">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Auto-dismiss alerts
        window.setTimeout(function() {
            $(".success-message, .error-summary").fadeOut(500, function(){
                $(this).remove(); 
            });
        }, 5000);
    </script>
}

