@page
@model BiketaBai.Pages.Account.RegisterRenterModel
@{
    ViewData["Title"] = "Register as Renter";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Progress Steps -->
            <div class="d-flex justify-content-center mb-4">
                <div class="registration-progress">
                    <div class="progress-step @(Model.CurrentStep >= 1 ? "active" : "") @(Model.CurrentStep > 1 ? "completed" : "")">
                        <div class="step-number">1</div>
                        <div class="step-label">Basic Info</div>
                    </div>
                    <div class="progress-line @(Model.CurrentStep > 1 ? "completed" : "")"></div>
                    <div class="progress-step @(Model.CurrentStep >= 2 ? "active" : "") @(Model.CurrentStep > 2 ? "completed" : "")">
                        <div class="step-number">2</div>
                        <div class="step-label">ID Verification</div>
                    </div>
                    <div class="progress-line @(Model.CurrentStep > 2 ? "completed" : "")"></div>
                    <div class="progress-step @(Model.CurrentStep >= 3 ? "active" : "")">
                        <div class="step-number">3</div>
                        <div class="step-label">Account Setup</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-bicycle"></i> Register as Renter
                    </h3>
                </div>
                <div class="card-body p-4">
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
                        </div>
                    }

                    <form method="post" enctype="multipart/form-data" id="renterRegistrationForm">
                        <input type="hidden" name="step" value="@Model.CurrentStep" />

                        <!-- Step 1: Basic Information -->
                        @if (Model.CurrentStep == 1)
                        {
                            <div class="registration-step">
                                <h4 class="mb-4">
                                    <i class="bi bi-person-fill"></i> Basic Information
                                </h4>

                                <div class="mb-3">
                                    <label asp-for="Input.FullName" class="form-label">
                                        Full Name <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Input.FullName" class="form-control" 
                                           placeholder="Enter your full name" required />
                                    <span asp-validation-for="Input.FullName" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Input.Email" class="form-label">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Input.Email" type="email" class="form-control" 
                                           placeholder="Enter your email" required />
                                    <span asp-validation-for="Input.Email" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Input.Address" class="form-label">
                                        Address <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Input.Address" class="form-control" 
                                           placeholder="Enter your complete address" required 
                                           id="addressInput" />
                                    <small class="form-text text-muted">
                                        <i class="bi bi-info-circle"></i> We'll verify this address
                                    </small>
                                    <div id="addressValidation" class="mt-2" style="display: none;">
                                        <span class="badge bg-success" id="addressValid">
                                            <i class="bi bi-check-circle"></i> Address verified
                                        </span>
                                        <span class="badge bg-danger" id="addressInvalid" style="display: none;">
                                            <i class="bi bi-x-circle"></i> Address not found
                                        </span>
                                    </div>
                                    <span asp-validation-for="Input.Address" class="text-danger"></span>
                                </div>

                                <div class="d-flex justify-content-end mt-4">
                                    <a href="/Account/RegisterType" class="btn btn-outline-secondary me-2">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        Next: ID Verification <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        }

                        <!-- Step 2: ID Verification -->
                        @if (Model.CurrentStep == 2)
                        {
                            <div class="registration-step">
                                <h4 class="mb-4">
                                    <i class="bi bi-card-text"></i> ID Verification
                                </h4>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <strong>Why we need your ID:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Verify your identity for security</li>
                                        <li>Cross-check with your provided address</li>
                                        <li>Ensure account authenticity</li>
                                    </ul>
                                </div>

                                <div class="mb-3">
                                    <label for="IdDocument" class="form-label">
                                        Upload ID Document <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" name="IdDocument" id="IdDocument" 
                                           class="form-control" accept=".jpg,.jpeg,.png,.pdf" required />
                                    <small class="form-text text-muted">
                                        Accepted formats: JPG, PNG, PDF (Max 5MB)
                                    </small>
                                    <div id="idPreview" class="mt-3" style="display: none;">
                                        <img id="idPreviewImg" src="" alt="ID Preview" 
                                             class="img-thumbnail" style="max-height: 200px;" />
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="submit" name="step" value="1" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" name="step" value="2" class="btn btn-primary">
                                        Next: Account Setup <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        }

                        <!-- Step 3: Account Setup -->
                        @if (Model.CurrentStep == 3)
                        {
                            <div class="registration-step">
                                <h4 class="mb-4">
                                    <i class="bi bi-shield-lock"></i> Account Setup
                                </h4>

                                <div class="mb-3">
                                    <label asp-for="Input.Password" class="form-label">
                                        Password <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Input.Password" type="password" class="form-control" 
                                           placeholder="Create a password (minimum 6 characters)" 
                                           required minlength="6" id="passwordInput" />
                                    <small class="form-text text-muted">
                                        Password must be at least 6 characters
                                    </small>
                                    <span asp-validation-for="Input.Password" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Input.ConfirmPassword" class="form-label">
                                        Confirm Password <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="Input.ConfirmPassword" type="password" class="form-control" 
                                           placeholder="Re-enter your password" required 
                                           id="confirmPasswordInput" />
                                    <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="submit" name="step" value="2" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Back
                                    </button>
                                    <button type="submit" name="step" value="3" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> Complete Registration
                                    </button>
                                </div>
                            </div>
                        }
                    </form>
                </div>
            </div>

            <div class="text-center mt-3">
                <p class="text-muted">
                    Already have an account? 
                    <a href="/Account/Login">Sign in here</a>
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .registration-progress {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s;
    }

    .progress-step.active .step-number {
        background: #87A96B;
        color: white;
    }

    .progress-step.completed .step-number {
        background: #28a745;
        color: white;
    }

    .step-label {
        font-size: 0.85rem;
        color: #666;
    }

    .progress-step.active .step-label {
        color: #87A96B;
        font-weight: 600;
    }

    .progress-line {
        width: 60px;
        height: 2px;
        background: #e0e0e0;
        transition: all 0.3s;
    }

    .progress-line.completed {
        background: #28a745;
    }
</style>

<script>
    $(document).ready(function() {
        // ID Preview
        $('#IdDocument').change(function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#idPreviewImg').attr('src', e.target.result);
                    $('#idPreview').show();
                };
                reader.readAsDataURL(file);
            } else {
                $('#idPreview').hide();
            }
        });

        // Address validation with API
        let addressValidationTimeout;
        $('#addressInput').on('input', function() {
            const address = $(this).val();
            $('#addressValidation').hide();
            
            clearTimeout(addressValidationTimeout);
            
            if (address && address.length > 5) {
                addressValidationTimeout = setTimeout(function() {
                    validateAddress(address);
                }, 1000); // Wait 1 second after user stops typing
            }
        });

        function validateAddress(address) {
            $.get('/Api/ValidateAddress', { address: address })
                .done(function(data) {
                    $('#addressValidation').show();
                    if (data.valid) {
                        $('#addressValid').show();
                        $('#addressInvalid').hide();
                        if (data.formattedAddress && data.formattedAddress !== address) {
                            // Suggest standardized address
                            $('#addressInput').data('validated-address', data.formattedAddress);
                        }
                    } else {
                        $('#addressValid').hide();
                        $('#addressInvalid').show().text(data.error || 'Address not found');
                    }
                })
                .fail(function() {
                    $('#addressValidation').show();
                    $('#addressValid').hide();
                    $('#addressInvalid').show().text('Validation service unavailable');
                });
        }

        // Password confirmation validation
        $('#confirmPasswordInput').on('input', function() {
            const password = $('#passwordInput').val();
            const confirm = $(this).val();
            if (confirm && password !== confirm) {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
    });
</script>

